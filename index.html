<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fernando Lapa - Dashboard de T칡nis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #1e40af;
            --secondary: #10b981;
            --accent: #facc15;
            --background: #f1f5f9;
            --text: #1f2937;
            --border: #e5e7eb;
            --error: #ef4444;
            --success: #22c55e;
            --card-bg: rgba(255, 255, 255, 0.9);
        }

        html, body { overflow-x: hidden; width: 100%; }
        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            background-image: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            background-attachment: fixed;
            color: var(--text);
        }

        .main-container {
            display: grid; grid-template-columns: 1fr; gap: 1.5rem; width: 100%;
            max-width: 1400px; margin: 0 auto; padding: 0.75rem;
        }
        @media (min-width: 1024px) { .main-container { grid-template-columns: 320px 1fr; } }
        
        .glass-card {
            background: var(--card-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .tab-button {
            padding: 0.75rem 1.25rem; font-weight: 600; font-size: 0.9rem;
            border-radius: 0.75rem; border: 2px solid transparent; color: #4b5563;
            cursor: pointer; transition: all 0.3s ease; white-space: nowrap;
        }
        .tab-button.active, .tab-button:hover {
            color: var(--primary); background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: smoothEnter 0.5s ease-out forwards; }
        
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes smoothEnter { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content { animation: smoothEnter 0.4s ease-out forwards; }
        
        .form-input, .form-select {
            width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border);
            background-color: #fff; font-size: 0.9rem; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(30, 64, 175, 0.3);
        }
        .btn {
            padding: 0.6rem 1.2rem; font-weight: 600; border-radius: 0.5rem; color: white;
            background-color: var(--primary); transition: background-color 0.3s; cursor: pointer; border: none;
        }
        .btn:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: var(--secondary); }
        .btn-secondary:hover { background-color: #059669; }
        .btn-danger { background-color: var(--error); }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-sm { padding: 0.25rem 0.6rem; font-size: 0.8rem; }

        #temporadas-tabela tr { cursor: pointer; }
        .details-btn, .toggle-sublist-btn {
            background: none; border: none; color: var(--primary); cursor: pointer;
            margin-left: 0.5rem; opacity: 0.6; transition: all 0.2s;
        }
        .details-btn:hover, .toggle-sublist-btn:hover { opacity: 1; }
        .sublist, .tournament-body { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .sublist.open, .tournament-body.open { max-height: 1000px; }
    </style>
</head>
<body>
    <div class="main-container">
        <aside class="space-y-6">
            <div class="glass-card p-6 text-center fade-in-up">
                <img src="https://ui-avatars.com/api/?name=Fernando+Lapa&background=1e40af&color=fff&size=96&bold=true&rounded=true" alt="Avatar Fernando Lapa" class="mx-auto mb-4 border-4 border-white/50 rounded-full shadow-lg">
                <div class="flex items-center justify-center gap-2">
                    <h1 class="text-2xl font-bold text-slate-800">Fernando Lapa</h1>
                    <span id="main-flag" class="text-2xl"></span>
                </div>
                <p class="text-sm text-slate-600">Tenista Profissional</p>
                <div class="text-xs text-slate-500 mt-2">
                    <i class="fa-solid fa-cake-candles mr-1"></i> 18/02/2011 (<span id="idade"></span> anos)
                </div>
                <div class="text-xs text-slate-500 mt-1">
                    <i class="fa-solid fa-location-dot mr-1"></i> Florian칩polis, SC, Brasil
                </div>
            </div>

            <div class="glass-card p-6 space-y-4 fade-in-up" style="animation-delay: 0.1s;">
                <h2 class="text-lg font-bold text-slate-800 border-b pb-2 mb-4">Estat칤sticas</h2>
                <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-slate-600"><i class="fa-solid fa-ranking-star w-5 mr-2 text-primary"></i>Ranking</span>
                    <span id="ranking" class="font-bold text-slate-700">Sem ranking</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-slate-600"><i class="fa-solid fa-sack-dollar w-5 mr-2 text-secondary"></i>Pr칡mios</span>
                    <span id="premiacao" class="font-bold text-slate-700">$0.00</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-slate-600"><i class="fa-solid fa-trophy w-5 mr-2 text-accent"></i>T칤tulos (ATP)</span>
                    <span id="titulos-total" class="font-bold text-slate-700">0</span>
                </div>
                 <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-slate-600"><i class="fa-solid fa-right-left w-5 mr-2 text-green-500"></i>V/D (ATP)</span>
                    <span id="vitorias-derrotas" class="font-bold text-slate-700">0 / 0</span>
                </div>
            </div>

            <div class="glass-card p-6 space-y-4 fade-in-up" style="animation-delay: 0.15s;">
                <h2 class="text-lg font-bold text-slate-800 border-b pb-2 mb-4">Proje칞칚o de Ranking</h2>
                <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-slate-600"><i class="fa-solid fa-calendar-alt w-5 mr-2 text-blue-500"></i>Pontos Atuais</span>
                    <span id="current-ranking-points" class="font-bold text-slate-700">0 pts</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-slate-600"><i class="fa-solid fa-arrow-down w-5 mr-2 text-red-500"></i>Pontos a Defender (Esta Semana)</span>
                    <span id="points-to-defend" class="font-bold text-red-600">0 pts</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-slate-600"><i class="fa-solid fa-chart-line w-5 mr-2 text-purple-500"></i>Proje칞칚o de Ranking</span>
                    <span id="projected-ranking" class="font-bold text-slate-700">Sem Ranking</span>
                </div>
            </div>

            <div class="glass-card p-4 fade-in-up" style="animation-delay: 0.2s;">
                 <button id="create-tournament-btn" class="btn w-full flex justify-center items-center">
                    <i class="fa-solid fa-plus-circle mr-2"></i>Criar Novo Torneio
                </button>
            </div>
        </aside>

        <main class="space-y-6 min-w-0">
            <div class="bg-slate-200/50 p-2 rounded-xl flex items-center justify-start gap-2 overflow-x-auto fade-in-up" style="animation-delay: 0.3s;" role="tablist">
                 <button class="tab-button active" data-tab="temporadas" role="tab" aria-selected="true">Temporadas</button>
                 <button class="tab-button" data-tab="titulos" role="tab" aria-selected="false">T칤tulos</button>
                 <button class="tab-button" data-tab="vitorias" role="tab" aria-selected="false">Vit칩rias/Derrotas</button>
                 <button class="tab-button" data-tab="h2h" role="tab" aria-selected="false">Head-to-Head</button>
                 <button class="tab-button" data-tab="recordes" role="tab" aria-selected="false">Recordes</button>
            </div>
            
            <div class="fade-in-up" style="animation-delay: 0.4s;">
                <div id="temporadas" class="tab-content active" role="tabpanel">
                    <div class="glass-card p-4 md:p-6">
                        <h2 class="text-2xl font-bold mb-6 text-slate-800">Hist칩rico de Temporadas</h2>
                        <div class="flex items-center gap-4 mb-4 bg-slate-100 p-3 rounded-lg">
                            <label for="season-filter" class="font-semibold text-gray-700 text-sm">Filtrar por Temporada:</label>
                            <select id="season-filter" class="form-select w-auto"></select>
                        </div>
                        <div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-slate-500">Vit칩rias (ATP)</p><p id="temporadas-vitorias" class="font-bold text-lg text-green-600">0</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-slate-500">Derrotas (ATP)</p><p id="temporadas-derrotas" class="font-bold text-lg text-red-600">0</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-slate-500">T칤tulos (ATP)</p><p id="temporadas-titulos" class="font-bold text-lg text-amber-500">0</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p id="temporadas-premiacao-label" class="text-xs text-slate-500">Premia칞칚o</p><p id="temporadas-premiacao" class="font-bold text-lg text-blue-700">$0.00</p></div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[600px] sm:min-w-full">
                                <thead class="bg-slate-100 text-xs text-slate-500 uppercase font-semibold">
                                    <tr>
                                        <th class="py-3 px-2 text-left rounded-l-lg">Datas</th>
                                        <th class="py-3 px-2 text-left">Torneio</th>
                                        <th class="py-3 px-2 text-center">Superf칤cie</th>
                                        <th class="py-3 px-2 text-center">Status</th>
                                        <th class="py-3 px-2 text-center">Campanha (V-D)</th>
                                        <th class="py-3 px-2 text-left">Resultado Final</th>
                                        <th class="py-3 px-2 text-center rounded-r-lg">A칞칫es</th>
                                    </tr>
                                </thead>
                                <tbody id="temporadas-tabela" class="text-sm align-middle"></tbody>
                            </table>
                             <p id="no-tournaments-msg" class="text-center text-slate-500 py-8 hidden">Nenhum torneio encontrado. Clique em "Criar Novo Torneio" para come칞ar.</p>
                        </div>
                        
                        <div class="mt-8 pt-6 border-t border-slate-200">
                             <h3 class="text-lg font-semibold mb-4 text-slate-700">Gerenciar Dados</h3>
                             <div class="flex flex-wrap gap-4 items-center">
                                 <button id="export-btn" class="btn">Exportar</button>
                                 <label for="import-file" class="btn cursor-pointer">Importar</label>
                                 <input type="file" id="import-file" class="hidden" accept=".json">
                             </div>
                        </div>
                    </div>
                </div>

                <div id="titulos" class="tab-content" role="tabpanel">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-card p-4 md:p-6">
                            <h2 class="text-2xl font-bold mb-6 text-slate-800">Resumo de T칤tulos</h2>
                             <p class="text-xs text-slate-500 mb-4">O total abaixo contabiliza apenas t칤tulos ATP (250+).</p>
                             <p class="font-semibold text-lg">Total de T칤tulos (ATP): <span id="titulos-total-resumo" class="text-primary">0</span></p>
                             <div id="titulos-list" class="mt-4 space-y-2 text-sm"></div>
                             <p class="font-semibold mt-6 pt-4 border-t border-slate-200">T칤tulos por Superf칤cie (ATP):</p>
                             <ul id="titulos-surface-list" class="list-disc pl-6 text-sm"></ul>
                        </div>
                         <div class="glass-card p-4 md:p-6"><h3 class="text-xl font-bold mb-4 text-slate-800">Distribui칞칚o de T칤tulos</h3><canvas id="titulosChart"></canvas></div>
                    </div>
                </div>

                <div id="vitorias" class="tab-content" role="tabpanel">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-card p-4 md:p-6">
                            <h2 class="text-2xl font-bold mb-6 text-slate-800">Vit칩rias e Derrotas</h2>
                            <p><strong>Total (ATP):</strong> <span id="total-vitorias" class="text-green-600">0</span> V / <span id="total-derrotas" class="text-red-600">0</span> D</p>
                            <p><strong>Taxa de Vit칩rias (ATP):</strong> <span id="taxa-vitorias" class="font-bold text-primary">0%</span></p>
                            <p class="font-semibold mt-6 pt-4 border-t border-slate-200">Por Tipo de Torneio:</p>
                            <div id="vitorias-list" class="text-sm space-y-1 mt-2"></div>
                            <p class="font-semibold mt-6 pt-4 border-t border-slate-200">Por Superf칤cie (ATP):</p>
                             <ul id="vitorias-surface-list" class="list-disc pl-6 text-sm"></ul>
                        </div>
                        <div class="glass-card p-4 md:p-6"><h3 class="text-xl font-bold mb-4 text-slate-800">Desempenho por Superf칤cie</h3><canvas id="vitoriasChart"></canvas></div>
                    </div>
                </div>

                <div id="h2h" class="tab-content" role="tabpanel">
                    <div class="glass-card p-4 md:p-6">
                        <h2 class="text-2xl font-bold mb-6 text-slate-800">Head-to-Head (H2H)</h2>
                        <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <div class="relative flex-grow">
                                <label for="h2h-search" class="block text-sm font-medium text-gray-700 mb-2">Pesquisar Advers치rio:</label>
                                <input id="h2h-search" class="form-input" placeholder="Digite o nome (Opcional se selecionar pa칤s)" autocomplete="off">
                                <div id="h2h-suggestions" class="absolute z-10 w-full bg-white rounded-md shadow-lg hidden mt-1 max-h-48 overflow-y-auto"></div>
                            </div>
                            <div class="md:w-1/3">
                                <label for="h2h-country-filter" class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Pa칤s:</label>
                                <select id="h2h-country-filter" class="form-select">
                                    <option value="">Todos os Pa칤ses</option>
                                </select>
                            </div>
                        </div>
                        <div id="h2h-results">
                            <p class="text-center text-slate-500 py-8">Selecione um advers치rio ou um pa칤s para ver o hist칩rico.</p>
                        </div>
                    </div>
                </div>

                <div id="recordes" class="tab-content" role="tabpanel">
                     <div class="glass-card p-4 md:p-6">
                        <h2 class="text-2xl font-bold mb-6 text-slate-800">Recordes na Carreira</h2>
                        <div id="recordes-conquistados" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="mainModal" class="fixed inset-0 z-50 items-center justify-center bg-black/60 hidden p-4">
        <div id="modalContent" class="modal-content glass-card max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center p-4 border-b border-slate-200 sticky top-0 bg-white/80 backdrop-blur-sm z-10">
                <h3 id="modalTitle" class="text-xl font-bold flex items-center gap-3"></h3>
                <button id="closeModalBtn" class="text-2xl text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div id="modalBody" class="p-6"></div>
            <div id="modalFooter" class="flex justify-end gap-3 p-4 border-t border-slate-200 sticky bottom-0 bg-white/80 backdrop-blur-sm"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';

        // --- CONFIG & GLOBALS ---
        const firebaseConfig = {
            apiKey: "AIzaSyBIWmpJcoCiD3jTWROFcjSZDgXcxafsgtA",
            authDomain: "tenis-456fc.firebaseapp.com",
            projectId: "tenis-456fc",
            storageBucket: "tenis-456fc.appspot.com",
            messagingSenderId: "21965853527",
            appId: "1:21965853527:web:38a9edbe0eb2438679e412",
            measurementId: "G-ZJ5MP3RLD9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let allTournaments = [];
        let titulosChart, vitoriasChart;
        let allOpponentNames = [];
        let availableOpponentCountries = new Set();
        
        // LISTA DE PA칈SES POPULARES PARA O FILTRO H2H
        const majorCountries = [
            "ARG", "AUS", "AUT", "BEL", "BRA", "CAN", "CHI", "CHN", "COL", "CRO", 
            "CZE", "DEN", "ECU", "ESP", "FIN", "FRA", "GBR", "GER", "GRE", "HUN", 
            "IND", "ITA", "JPN", "KAZ", "KOR", "MEX", "NED", "NOR", "NZL", "PER", 
            "POL", "POR", "ROU", "RSA", "RUS", "SRB", "SUI", "SVK", "SWE", "TPE", 
            "TUR", "UKR", "URU", "USA"
        ];

        const modal = document.getElementById('mainModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const dataNascimentoJogador = new Date('2011-02-18');
        
        const tournamentTypes = ['Grand Slam', 'ATP Finals', 'ATP Masters 1000', 'ATP 500', 'ATP 250', 'Jogos Ol칤mpicos', 'CH 175', 'CH 125', 'CH 100', 'CH 90', 'CH 75'];
        const surfaces = ['Saibro', 'R치pida', 'Grama'];
        const roundsByTournamentType = {
            'Grand Slam': ['Primeira Rodada', 'Segunda Rodada', 'Terceira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'ATP Masters 1000': ['Primeira Rodada', 'Segunda Rodada', 'Terceira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'ATP 500': ['Primeira Rodada', 'Segunda Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'ATP 250': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'Jogos Ol칤mpicos': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Disputa Bronze', 'Final'],
            'ATP Finals': ['Fase de Grupos 1', 'Fase de Grupos 2', 'Fase de Grupos 3', 'Semifinal', 'Final'],
            'CH 175': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 125': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 100': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 90': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 75': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'Default': ['Primeira Rodada', 'Segunda Rodada', 'Terceira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final']
        };
        const iocToIso2 = {'AFG':'AF','ALB':'AL','ALG':'DZ','ASA':'AS','AND':'AD','ANG':'AO','ANT':'AG','ARG':'AR','ARM':'AM','ARU':'AW','AUS':'AU','AUT':'AT','AZE':'AZ','BAH':'BS','BRN':'BH','BAN':'BD','BAR':'BB','BLR':'BY','BEL':'BE','BIZ':'BZ','BEN':'BJ','BER':'BM','BHU':'BT','BOL':'BO','BIH':'BA','BOT':'BW','BRA':'BR','IVB':'VG','BRU':'BN','BUL':'BG','BUR':'BF','BDI':'BI','CAM':'KH','CMR':'CM','CAN':'CA','CAY':'KY','CAF':'CF','CHA':'TD','CHI':'CL','CHN':'CN','TPE':'TW','COL':'CO','COM':'KM','CGO':'CG','COD':'CD','COK':'CK','CRC':'CR','CIV':'CI','CRO':'HR','CUB':'CU','CYP':'CY','CZE':'CZ','DEN':'DK','DJI':'DJ','DMA':'DM','DOM':'DO','ECU':'EC','EGY':'EG','ESA':'SV','GEQ':'GQ','ERI':'ER','EST':'EE','SWZ':'SZ','ETH':'ET','FIJ':'FJ','FIN':'FI','FRA':'FR','GAB':'GA','GAM':'GM','GEO':'GE','GER':'DE','GHA':'GH','GBR':'GB','GRE':'GR','GRN':'GD','GUM':'GU','GUA':'GT','GUI':'GN','GBS':'GW','GUY':'GY','HAI':'HT','HON':'HN','HKG':'HK','HUN':'HU','ISL':'IS','IND':'IN','INA':'ID','IRI':'IR','IRQ':'IQ','IRL':'IE','ISR':'IL','ITA':'IT','JAM':'JM','JOR':'JO','KAZ':'KZ','KEN':'KE','KIR':'KI','PRK':'KP','KOR':'KR','KUW':'KW','KGZ':'KG','LAO':'LA','LAT':'LV','LIB':'LB','LES':'LS','LBR':'LR','LBA':'LY','LIE':'LI','LTU':'LT','LUX':'LU','MAD':'MG','MAW':'MW','MAS':'MY','MDV':'MV','MLI':'ML','MLT':'MT','MHL':'MH','MTN':'MR','MRI':'MU','MEX':'MX','FSM':'FM','MDA':'MD','MON':'MC','MGL':'MN','MNE':'ME','MAR':'MA','MOZ':'MZ','MYA':'MM','NAM':'NA','NRU':'NR','NEP':'NP','NED':'NL','NZL':'NZ','NCA':'NI','NIG':'NE','NGR':'NG','MKD':'MK','NOR':'NO','OMA':'OM','PAK':'PK','PLW':'PW','PLE':'PS','PAN':'PA','PNG':'PG','PAR':'PY','PER':'PE','PHI':'PH','POL':'PL','POR':'PT','PUR':'PR','QAT':'QA','ROU':'RO','RUS':'RU','RWA':'RW','SKN':'KN','LCA':'LC','VIN':'VC','SAM':'WS','SMR':'SM','STP':'ST','KSA':'SA','SEN':'SN','SRB':'RS','SEY':'SC','SLE':'SL','SGP':'SG','SVK':'SK','SLO':'SI','SOL':'SB','SOM':'SO','RSA':'ZA','ESP':'ES','SRI':'LK','SUD':'SD','SUR':'SR','SWE':'SE','SUI':'CH','SYR':'SY','TAN':'TZ','THA':'TH','TLS':'TL','TOG':'TG','TGA':'TO','TTO':'TT','TUN':'TN','TUR':'TR','TKM':'TM','TUV':'TV','UGA':'UG','UKR':'UA','UAE':'AE','USA':'US','URU':'UY','UZB':'UZ','VAN':'VU','VEN':'VE','VIE':'VN','ISV':'VI','YEM':'YE','ZAM':'ZM','ZIM':'ZW'};
        
        const worldRecords = [
            // --- RANKING RECORDS (NEW) ---
            { id: 'weeksAtNo1', title: 'Mais Semanas como N췈 1 do Mundo', holder: 'Novak Djokovic', value: 428, stat: (s) => 0, format: (v) => `${v} Semanas` },
            { id: 'consecutiveWeeks', title: 'Semanas Consecutivas como N췈 1', holder: 'Roger Federer', value: 237, stat: (s) => 0, format: (v) => `${v} Semanas` },
            { id: 'yearEndNo1', title: 'Mais Vezes N췈 1 ao Final do Ano', holder: 'Novak Djokovic', value: 8, stat: (s) => 0, format: (v) => `${v} Anos` },

            // --- GRAND SLAMS ---
            { id: 'grandSlams', title: 'Mais T칤tulos de Grand Slam', holder: 'Novak Djokovic', value: 24, stat: (s) => s.porTipo['Grand Slam']?.t || 0, format: (v) => `${v} T칤tulos` },
            { id: 'grandSlamFinals', title: 'Mais Finais de Grand Slam', holder: 'Novak Djokovic', value: 36, stat: (s) => s.finaisGrandSlam, format: (v) => `${v} Finais` },
            
            // --- BIG TITLES & SURFACES ---
            { id: 'bigTitles', title: 'Rei dos "Big Titles" (GS, M1000, Finals, Oly)', holder: 'Novak Djokovic', value: 71, stat: (s) => (s.porTipo['Grand Slam']?.t || 0) + (s.porTipo['ATP Masters 1000']?.t || 0) + (s.porTipo['ATP Finals']?.t || 0) + (s.porTipo['Jogos Ol칤mpicos']?.t || 0), format: (v) => `${v} T칤tulos` },
            
            { id: 'hardTitles', title: 'Mais T칤tulos em Quadra R치pida', holder: 'Novak Djokovic', value: 71, stat: (s) => s.porSuperficie['R치pida']?.atp_t || 0, format: (v) => `${v} T칤tulos` },
            { id: 'clayTitles', title: 'Mais T칤tulos no Saibro', holder: 'Rafael Nadal', value: 63, stat: (s) => s.porSuperficie['Saibro']?.atp_t || 0, format: (v) => `${v} T칤tulos` },
            { id: 'grassTitles', title: 'Mais T칤tulos na Grama', holder: 'Roger Federer', value: 19, stat: (s) => s.porSuperficie['Grama']?.atp_t || 0, format: (v) => `${v} T칤tulos` },

            // --- OTHER TOURNAMENT TYPES ---
            { id: 'atpFinals', title: 'Mais T칤tulos de ATP Finals', holder: 'Novak Djokovic', value: 7, stat: (s) => s.porTipo['ATP Finals']?.t || 0, format: (v) => `${v} T칤tulos` },
            { id: 'masters1000', title: 'Mais T칤tulos de Masters 1000', holder: 'Novak Djokovic', value: 40, stat: (s) => s.porTipo['ATP Masters 1000']?.t || 0, format: (v) => `${v} T칤tulos` },
            { id: 'atp500', title: 'Mais T칤tulos de ATP 500', holder: 'Roger Federer', value: 24, stat: (s) => s.porTipo['ATP 500']?.t || 0, format: (v) => `${v} T칤tulos` },
            { id: 'atp250', title: 'Mais T칤tulos de ATP 250', holder: 'Thomas Muster', value: 26, stat: (s) => s.porTipo['ATP 250']?.t || 0, format: (v) => `${v} T칤tulos` },
            { id: 'challenger', title: 'Mais T칤tulos de Challenger', holder: 'Yen-Hsun Lu', value: 29, stat: (s) => s.titulosChallenger, format: (v) => `${v} T칤tulos` },
            
            // --- CAREER TOTALS ---
            { id: 'careerTitles', title: 'Mais T칤tulos na Carreira (ATP)', holder: 'Jimmy Connors', value: 109, stat: (s) => s.titulosATP, format: (v) => `${v} T칤tulos` },
            { id: 'matchWins', title: 'Mais Vit칩rias na Carreira (ATP)', holder: 'Jimmy Connors', value: 1274, stat: (s) => s.vitoriasATP, format: (v) => `${v} Vit칩rias` },
            { id: 'prizeMoney', title: 'Maior Premia칞칚o na Carreira', holder: 'Novak Djokovic', value: 184000000, stat: (s) => s.premiacao, format: (v) => formatCurrency(v) },
            
            // --- EFFICIENCY & RATIOS ---
            { id: 'winPercentage', title: '% de Vit칩rias (ATP, min. 200 jogos)', holder: 'Novak Djokovic', value: 83.9, stat: (s) => (s.vitoriasATP + s.derrotasATP > 200) ? (s.vitoriasATP / (s.vitoriasATP + s.derrotasATP) * 100) : 0, format: (v) => v > 0 ? `${v.toFixed(2)}%` : 'N/A' },
            { id: 'clayWinPerc', title: '% de Vit칩rias no Saibro (min. 50 jogos)', holder: 'Rafael Nadal', value: 91.3, stat: (s) => (s.porSuperficie['Saibro']?.atp_v + s.porSuperficie['Saibro']?.atp_d > 50) ? (s.porSuperficie['Saibro'].atp_v / (s.porSuperficie['Saibro'].atp_v + s.porSuperficie['Saibro'].atp_d) * 100) : 0, format: (v) => v > 0 ? `${v.toFixed(2)}%` : 'N/A' },
            { id: 'hardWinPerc', title: '% de Vit칩rias na R치pida (min. 50 jogos)', holder: 'Novak Djokovic', value: 84.7, stat: (s) => (s.porSuperficie['R치pida']?.atp_v + s.porSuperficie['R치pida']?.atp_d > 50) ? (s.porSuperficie['R치pida'].atp_v / (s.porSuperficie['R치pida'].atp_v + s.porSuperficie['R치pida'].atp_d) * 100) : 0, format: (v) => v > 0 ? `${v.toFixed(2)}%` : 'N/A' },
            { id: 'grassWinPerc', title: '% de Vit칩rias na Grama (min. 50 jogos)', holder: 'Roger Federer', value: 86.9, stat: (s) => (s.porSuperficie['Grama']?.atp_v + s.porSuperficie['Grama']?.atp_d > 50) ? (s.porSuperficie['Grama'].atp_v / (s.porSuperficie['Grama'].atp_v + s.porSuperficie['Grama'].atp_d) * 100) : 0, format: (v) => v > 0 ? `${v.toFixed(2)}%` : 'N/A' },
            
            // --- SEASON RECORDS ---
            { id: 'seasonWins', title: 'Mais Vit칩rias em uma Temporada', holder: 'Guillermo Vilas (1977)', value: 130, stat: (s) => s.maxVitoriasEmUmAno, format: (v) => `${v} Vit칩rias` },
            { id: 'seasonWinPerc', title: 'Melhor % em uma Temporada', holder: 'John McEnroe (1984)', value: 96.5, stat: (s) => s.maxPorcentagemVitoriasEmUmAno, format: (v) => v > 0 ? `${v.toFixed(1)}%` : 'N/A' },
            { id: 'singleSeason', title: 'Mais T칤tulos em uma Temporada', holder: 'Guillermo Vilas', value: 16, stat: (s) => s.maxTitulosEmUmAno, format: (v) => `${v} T칤tulos` },
            { id: 'prizeMoneySeason', title: 'Maior Premia칞칚o em uma Temporada', holder: 'Novak Djokovic (2015)', value: 21646145, stat: (s) => s.maxPremiacaoEmUmAno, format: (v) => formatCurrency(v) },
            
            // --- SPECIALS ---
            { id: 'careerSlam', title: 'Career Grand Slam', holder: 'V치rios', value: 4, stat: (s) => s.grandSlamEvents.size, format: (v) => v === 4 ? 'Conquistado 游끥' : `${v} de 4` },
            { id: 'goldenSlam', title: 'Career Golden Slam', holder: 'A. Agassi, R. Nadal', value: 5, stat: (s) => s.goldenSlamEvents.size, format: (v) => v === 5 ? 'Conquistado 游끥' : `${v} de 5` },
            { id: 'singleTournament', title: 'Mais T칤tulos em um 칔nico Torneio', holder: 'Rafael Nadal', value: 14, stat: (s) => s.maxTitulosUnicoTorneio, format: (v, s) => `${v} (${s.nomeMaxTitulosUnicoTorneio})` },
            { id: 'youngestGS', title: 'Vencedor de GS Mais Jovem', holder: 'Michael Chang', value: 207, isLowerBetter: true, stat: (s) => s.idadeMenorCampeaoGS, format: (v) => v > 0 ? `${Math.floor(v/12)}a ${v%12}m` : 'N/A' },
            { id: 'oldestGS', title: 'Vencedor de GS Mais Velho', holder: 'Ken Rosewall', value: 446, stat: (s) => s.idadeMaiorCampeaoGS, format: (v) => v > 0 ? `${Math.floor(v/12)}a ${v%12}m` : 'N/A' },
        ];

        // --- MODAL & UI HELPERS ---
        function openModal(title, bodyHTML, footerHTML = '') {
            modalTitle.innerHTML = title;
            modalBody.innerHTML = bodyHTML;
            modalFooter.innerHTML = footerHTML;
            modal.style.display = 'flex';
        }
        function closeModal() { modal.style.display = 'none'; }
        function formatCurrency(value) { return (Number(value) || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' }); }
        
        function estimarRanking(pontos) {
            if (pontos <= 0) return 'Sem Ranking';
            const rankingPointsMap = [
                { rank: 1, points: 9500 }, { rank: 10, points: 4000 }, { rank: 25, points: 1500 },
                { rank: 50, points: 1000 }, { rank: 100, points: 640 }, { rank: 150, points: 430 },
                { rank: 200, points: 310 }, { rank: 250, points: 240 }, { rank: 300, points: 190 },
                { rank: 400, points: 125 }, { rank: 500, points: 80 }, { rank: 750, points: 35 },
                { rank: 1000, points: 17 }, { rank: 1500, points: 1 }
            ];
            if (pontos >= rankingPointsMap[0].points) return `${rankingPointsMap[0].rank}췈`;
            for (let i = 1; i < rankingPointsMap.length; i++) {
                const upper = rankingPointsMap[i-1];
                const lower = rankingPointsMap[i];
                if (pontos >= lower.points && pontos < upper.points) {
                    const pointsRange = upper.points - lower.points;
                    const rankRange = lower.rank - upper.rank;
                    const pointsAboveLower = pontos - lower.points;
                    const rankOffset = (pointsAboveLower / pointsRange) * rankRange;
                    return `${Math.round(lower.rank - rankOffset)}췈`;
                }
            }
            return `>1500췈`;
        }

        function getFlagEmoji(iocCode) {
            if (!iocCode || iocCode.length < 2) return '';
            const code = iocCode.toUpperCase();
            const iso2 = iocToIso2[code] || (code.length === 2 ? code : '');
            if (!iso2) return `(${code})`;
            return iso2.toUpperCase().split('').map(char => String.fromCodePoint(char.charCodeAt(0) + 127397)).join('');
        }
        
        function abbreviateTournamentType(type) {
            const map = {
                "Grand Slam": "GS", "ATP Finals": "Finals", "ATP Masters 1000": "M1000",
                "Jogos Ol칤mpicos": "Ol칤mpiadas"
            };
            return map[type] || type;
        }

        function abbreviateRound(round) {
            const map = {
                "Primeira Rodada": "R1", "Segunda Rodada": "R2", "Terceira Rodada": "R3",
                "Oitavas de Final": "R16", "Quartas de Final": "QF", "Semifinal": "SF", "Final": "F",
                "Disputa Bronze": "Bronze"
            };
            return map[round] || round;
        }

        // Helper function to get the ISO week number (1-53) for a given date
        function getWeekNumber(d) {
            // Copy date so don't modify original
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // (Sunday is 0, Monday is 1 etc.)
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            // Calculate full weeks to nearest Thursday
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }
        
        // --- CRUD & DB OPERATIONS ---
        async function loadTournamentsFromDb() {
            try {
                const snapshot = await getDocs(collection(db, 'torneios'));
                allTournaments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Dados carregados do Firestore:", allTournaments); // DEBUG LOG
                updateUI();
            } catch (error) { 
                console.error("Falha ao carregar torneios. Detalhes do erro:", error);
                const noDataMsg = document.getElementById('no-tournaments-msg');
                noDataMsg.textContent = `Erro ao carregar dados: ${error.message}. Verifique o console do navegador (F12) para mais detalhes.`;
                noDataMsg.style.display = 'block';
            }
        }
        async function updateTournamentInDb(id, data, shouldRefreshModal = false) {
            try {
                const tournamentRef = doc(db, 'torneios', id);
                await updateDoc(tournamentRef, data);
                const index = allTournaments.findIndex(t => t.id === id);
                if (index > -1) {
                    allTournaments[index] = { ...allTournaments[index], ...data };
                }
                updateUI();
                if (shouldRefreshModal) {
                    openManageTournamentModal(id);
                }
            } catch (error) { console.error("Erro ao atualizar torneio: ", error); alert('Ocorreu um erro ao atualizar.'); }
        }
        async function deleteTournamentFromDb(id) {
            if (confirm('Tem certeza que deseja excluir este torneio e toda a sua campanha?')) {
                try {
                    await deleteDoc(doc(db, 'torneios', id));
                    allTournaments = allTournaments.filter(t => t.id !== id);
                    updateUI();
                } catch (error) { console.error("Erro ao excluir torneio: ", error); alert('Ocorreu um erro ao excluir.'); }
            }
        }
        async function handleSaveNewTournament() {
            const form = document.getElementById('create-tournament-form');
            if (!form.checkValidity()) { form.reportValidity(); return; }
            const dataInicio = document.getElementById('torneio-data-inicio').value;
            const torneioTipo = document.getElementById('torneio-tipo').value;
            
            const startingRoundName = document.getElementById('starting-round')?.value || 'Primeira Rodada';
            const allPossibleRounds = roundsByTournamentType[torneioTipo] || roundsByTournamentType['Default'];
            const startingRoundIndex = allPossibleRounds.indexOf(startingRoundName);
            
            const jogos = [];
            // Add 'Bye' entries for rounds before the starting round
            for(let i = 0; i < startingRoundIndex; i++) {
                jogos.push({
                    rodada: allPossibleRounds[i],
                    adversario: 'Bye',
                    nacionalidade: 'ATP',
                    placar: 'Bye',
                    resultado: 'Bye' // Use 'Bye' as result for bye rounds
                });
            }

            const adversario = document.getElementById('jogo-adversario').value.trim();
            const nacionalidade = document.getElementById('jogo-nacionalidade').value.trim().toUpperCase();
            const placar = document.getElementById('jogo-placar').value.trim();
            const resultado = document.getElementById('jogo-resultado').value;
            
            // Add the actual first played match
            jogos.push({
                rodada: startingRoundName,
                adversario,
                nacionalidade,
                placar,
                resultado,
            });
            
            let status = 'Em Andamento';
            let faseFinal = '';
            let pontos = 0;
            let premiacao = 0;

            if (resultado === 'D') { // If the first played match is a loss, the tournament is finished
                status = 'Finalizado';
                faseFinal = startingRoundName;
                pontos = Number(document.getElementById('torneio-pontos').value) || 0;
                premiacao = Number(document.getElementById('torneio-premiacao').value) || 0;
            }
            
            const newTournament = {
                nome: document.getElementById('torneio-nome').value.trim(),
                tipo: torneioTipo,
                superficie: document.getElementById('torneio-superficie').value,
                paisTorneio: document.getElementById('torneio-pais').value.trim().toUpperCase(),
                dataInicio, dataFim: document.getElementById('torneio-data-fim').value,
                ano: new Date(dataInicio + 'T00:00:00').getFullYear(),
                pontos, premiacao, faseFinal, status, jogos
            };

            try {
                const docRef = await addDoc(collection(db, 'torneios'), newTournament);
                allTournaments.push({ id: docRef.id, ...newTournament });
                closeModal();
                updateUI();
            } catch (error) { console.error("Erro ao salvar novo torneio: ", error); alert('Ocorreu um erro ao salvar.'); }
        }

        // --- MODAL RENDERING ---
        function openCreateTournamentModal() {
            const body = `
                <form id="create-tournament-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="torneio-nome" class="block text-sm font-medium">Nome</label><input type="text" id="torneio-nome" class="form-input mt-1" required></div>
                        <div><label for="torneio-pais" class="block text-sm font-medium">Pa칤s do Torneio (Ex: BRA)</label><input type="text" id="torneio-pais" maxlength="3" class="form-input mt-1" required></div>
                        <div><label for="torneio-tipo" class="block text-sm font-medium">Tipo</label><select id="torneio-tipo" class="form-select mt-1" required>${tournamentTypes.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                        <div id="starting-round-container" class="hidden">
                           <label for="starting-round" class="block text-sm font-medium">Rodada de In칤cio</label>
                           <select id="starting-round" class="form-select mt-1"></select>
                        </div>
                        <div><label for="torneio-superficie" class="block text-sm font-medium">Superf칤cie</label><select id="torneio-superficie" class="form-select mt-1" required>${surfaces.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
                        <div><label for="torneio-data-inicio" class="block text-sm font-medium">Data In칤cio</label><input type="date" id="torneio-data-inicio" class="form-input mt-1" required></div>
                        <div><label for="torneio-data-fim" class="block text-sm font-medium">Data Final</label><input type="date" id="torneio-data-fim" class="form-input mt-1" required></div>
                    </div>
                    <div class="pt-4 mt-4 border-t">
                        <h4 class="text-md font-semibold"><span id="match-round-label">Primeira</span> Partida</h4>
                        <div id="match-details-container">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <div><label for="jogo-adversario" class="block text-sm font-medium">Advers치rio</label><input type="text" id="jogo-adversario" class="form-input mt-1" required></div>
                                <div><label for="jogo-nacionalidade" class="block text-sm font-medium">Nacionalidade (Ex: SUI)</label><input type="text" id="jogo-nacionalidade" maxlength="3" class="form-input mt-1"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <div><label for="jogo-placar" class="block text-sm font-medium">Placar</label><input type="text" id="jogo-placar" class="form-input mt-1" required></div>
                                <div><label for="jogo-resultado" class="block text-sm font-medium">Resultado</label><select id="jogo-resultado" class="form-select mt-1"><option value="V" selected>Vit칩ria</option><option value="D">Derrota</option></select></div>
                            </div>
                        </div>
                    </div>
                    <div id="final-details-create" class="hidden space-y-4 pt-4 mt-4 border-t">
                         <h4 class="text-md font-semibold text-red-600">Finalizar Campanha (Derrota na Estreia)</h4>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="torneio-pontos" class="block text-sm font-medium">Pontos</label><input type="number" id="torneio-pontos" class="form-input mt-1" min="0" value="0"></div>
                            <div><label for="torneio-premiacao" class="block text-sm font-medium">Pr칡mio ($)</label><input type="number" id="torneio-premiacao" class="form-input mt-1" min="0" value="0"></div>
                        </div>
                    </div>
                </form>
            `;
            const footer = `<button id="save-tournament-btn" class="btn btn-secondary">Salvar e Continuar</button>`;
            openModal('Criar Novo Torneio', body, footer);
            
            const resultSelect = document.getElementById('jogo-resultado');
            const finalDetails = document.getElementById('final-details-create');
            const saveBtn = document.getElementById('save-tournament-btn');
            const tournamentTypeSelect = document.getElementById('torneio-tipo');
            const startingRoundContainer = document.getElementById('starting-round-container');
            const startingRoundSelect = document.getElementById('starting-round');
            const matchRoundLabel = document.getElementById('match-round-label');

            const updateStartingRounds = (type) => {
                const hasByes = type === 'ATP Masters 1000' || type === 'ATP 500';
                startingRoundContainer.classList.toggle('hidden', !hasByes);
                if(hasByes) {
                    startingRoundSelect.innerHTML = '';
                    const rounds = roundsByTournamentType[type];
                    // Options for starting round should be up to the 3rd round for M1000 and 2nd for ATP500
                    const maxRoundIndex = type === 'ATP Masters 1000' ? 2 : 1; 
                    for (let i = 0; i <= maxRoundIndex; i++) {
                         startingRoundSelect.innerHTML += `<option value="${rounds[i]}">${rounds[i]}</option>`;
                    }
                    matchRoundLabel.textContent = startingRoundSelect.value;
                } else {
                    matchRoundLabel.textContent = 'Primeira Rodada'; // Reset to default for other types
                }
            };
            
            const toggleFinalDetails = () => {
                const isLoss = resultSelect.value === 'D';
                finalDetails.classList.toggle('hidden', !isLoss);
                saveBtn.textContent = isLoss ? 'Salvar e Finalizar' : 'Salvar e Continuar';
                saveBtn.classList.toggle('btn-danger', isLoss);
                saveBtn.classList.toggle('btn-secondary', !isLoss);
            };

            tournamentTypeSelect.addEventListener('change', (e) => updateStartingRounds(e.target.value));
            startingRoundSelect.addEventListener('change', (e) => {
                matchRoundLabel.textContent = e.target.value;
                toggleFinalDetails(); // Re-evaluate final details visibility
            });
            resultSelect.addEventListener('change', toggleFinalDetails);
            saveBtn.addEventListener('click', handleSaveNewTournament);

            updateStartingRounds(tournamentTypeSelect.value); // Initial call
        }
        function openManageTournamentModal(torneioId) {
            const torneio = allTournaments.find(t => t.id === torneioId);
            if (!torneio) return;
            const matchesHistory = (torneio.jogos || []).map(jogo => `
                <div class="p-3 rounded-lg flex justify-between items-center ${jogo.resultado === 'V' ? 'bg-green-50' : (jogo.resultado === 'D' ? 'bg-red-50' : 'bg-gray-100')}">
                    <div class="flex-grow min-w-0 mr-2">
                        <p class="font-bold truncate">${jogo.rodada}</p>
                        <p class="text-sm text-slate-600 truncate">${getFlagEmoji('BRA')} Fernando Lapa vs ${jogo.adversario} ${getFlagEmoji(jogo.nacionalidade)}</p>
                    </div>
                    <div class="flex-shrink-0 flex items-center text-right">
                        <span class="font-semibold text-sm whitespace-nowrap mr-4">${jogo.placar}</span>
                        <span class="text-lg font-bold w-4 ${jogo.resultado === 'V' ? 'text-green-600' : (jogo.resultado === 'D' ? 'text-red-600' : 'text-gray-500')}">${jogo.resultado === 'Bye' ? '' : jogo.resultado}</span>
                    </div>
                </div>`).join('');
            let body = `<div id="matches-history-list" class="space-y-3">${matchesHistory}</div>`;
            const titlePrefix = torneio.status === 'Finalizado' ? '' : 'Gerenciar: ';
            const modalTitleHTML = `
                <span>${getFlagEmoji(torneio.paisTorneio)}</span>
                <span class="truncate">${titlePrefix}${torneio.nome}</span>
                <span class="text-sm font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded-md">${torneio.tipo}</span>
            `;

            if (torneio.status === 'Finalizado') {
                body += `<div class="mt-6 pt-4 border-t text-center space-y-2"><p class="text-lg font-bold">Campanha Finalizada</p><p><strong>Resultado:</strong> ${torneio.faseFinal}</p><p><strong>Pontos:</strong> ${torneio.pontos}</p><p><strong>Pr칡mio:</strong> ${formatCurrency(torneio.premiacao)}</p></div>`;
            } else {
                const lastPlayedRound = torneio.jogos[torneio.jogos.length - 1].rodada;
                const allPossibleRounds = roundsByTournamentType[torneio.tipo] || roundsByTournamentType['Default'];
                const lastPlayedIndex = allPossibleRounds.indexOf(lastPlayedRound);
                const remainingRounds = allPossibleRounds.slice(lastPlayedIndex + 1);

                if (remainingRounds.length === 0) {
                     body += `<div class="mt-6 pt-4 border-t text-center text-slate-500">Campanha em andamento. N칚o h치 mais rodadas para adicionar.</div>`;
                } else {
                    body += `
                        <form id="update-tournament-form" class="space-y-4 pt-6 mt-6 border-t">
                            <h4 class="text-md font-semibold">Pr칩ximo Jogo</h4>
                             <p class="text-xs text-gray-500 mb-2">Para um "bye", digite "Bye" no campo de advers치rio.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <div><label for="next-round" class="block text-sm font-medium">Fase</label><select id="next-round" class="form-select mt-1">${remainingRounds.map(r => `<option value="${r}">${r}</option>`).join('')}</select></div>
                                <div><label for="next-adversario" class="block text-sm font-medium">Advers치rio</label><input type="text" id="next-adversario" class="form-input mt-1" required></div>
                                <div><label for="next-nacionalidade" class="block text-sm font-medium">Nacionalidade</label><input type="text" maxlength="3" id="next-nacionalidade" class="form-input mt-1" placeholder="Ex: SUI"></div>
                                <div><label for="next-placar" class="block text-sm font-medium">Placar</label><input type="text" id="next-placar" class="form-input mt-1" required></div>
                            </div>
                            <div id="final-details-update" class="hidden space-y-4 pt-4 mt-4 border-t">
                                 <h4 id="final-title-update" class="text-md font-semibold"></h4>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="update-pontos" class="block text-sm font-medium">Pontos</label><input type="number" id="update-pontos" class="form-input mt-1" min="0" value="0"></div>
                                    <div><label for="update-premiacao" class="block text-sm font-medium">Pr칡mio ($)</label><input type="number" id="update-premiacao" class="form-input mt-1" min="0" value="0"></div>
                                </div>
                            </div>
                        </form>`;
                }
            }
            const footer = torneio.status !== 'Finalizado' ? `<button id="win-match-btn" class="btn btn-secondary">Salvar Vit칩ria</button><button id="lose-match-btn" class="btn btn-danger">Finalizar com Derrota</button>` : '';
            openModal(modalTitleHTML, body, footer);
            
            const adversarioInput = document.getElementById('next-adversario');
            const placarInput = document.getElementById('next-placar');
            const nacionalidadeInput = document.getElementById('next-nacionalidade');

            if(adversarioInput) {
                 adversarioInput.addEventListener('input', () => {
                    const isBye = adversarioInput.value.toLowerCase() === 'bye';
                    if (isBye) {
                        placarInput.value = 'Bye';
                        nacionalidadeInput.value = 'ATP';
                    }
                    placarInput.disabled = isBye;
                    nacionalidadeInput.disabled = isBye;
                 });
            }

            const handleUpdate = (result) => {
                 const form = document.getElementById('update-tournament-form');
                 const nextRoundName = form.querySelector('#next-round').value;
                 if (!nextRoundName) { alert('N칚o h치 mais fases neste torneio para selecionar.'); return; }
                 
                 const adversario = form.querySelector('#next-adversario').value.trim();
                 const placar = form.querySelector('#next-placar').value.trim();
                 const nacionalidade = form.querySelector('#next-nacionalidade').value.trim().toUpperCase();

                 const isBye = adversario.toLowerCase() === 'bye';
                 const finalResult = isBye ? 'Bye' : result; // If it's a bye, result is 'Bye'
                 const finalPlacar = isBye ? 'Bye' : placar;

                 if (!adversario || (!isBye && !placar)) { alert('Preencha advers치rio e placar.'); return; }
                 
                 const isFinal = nextRoundName === 'Final';
                 const newMatch = { rodada: nextRoundName, adversario: isBye ? 'Bye' : adversario, nacionalidade: isBye ? 'ATP' : nacionalidade, placar: finalPlacar, resultado: finalResult };
                 const updatedJogos = [...(torneio.jogos || []), newMatch];
                 let updatedData = { jogos: updatedJogos };
                 if (finalResult === 'D' || (finalResult === 'V' && isFinal)) { // Tournament finishes on a loss or winning the final
                     updatedData = { ...updatedData, status: 'Finalizado', faseFinal: finalResult === 'V' ? 'Campe칚o' : nextRoundName, pontos: Number(form.querySelector('#update-pontos').value) || 0, premiacao: Number(form.querySelector('#update-premiacao').value) || 0 };
                 }
                 updateTournamentInDb(torneioId, updatedData).then(closeModal);
            };
            const setupFinalizationUI = (isWin) => {
                const finalDetails = document.getElementById('final-details-update'), title = document.getElementById('final-title-update');
                if (finalDetails.classList.contains('hidden')) {
                    finalDetails.classList.remove('hidden');
                    title.textContent = isWin ? 'Finalizar (Campe칚o!)' : 'Finalizar com Derrota';
                    title.className = isWin ? 'text-md font-semibold text-amber-500' : 'text-md font-semibold text-red-600';
                    return false;
                } return true;
            };
            const winBtn = document.getElementById('win-match-btn'), loseBtn = document.getElementById('lose-match-btn');
            if(winBtn && loseBtn) {
                winBtn.addEventListener('click', () => {
                    const nextRound = document.getElementById('next-round').value;
                    const adversario = document.getElementById('next-adversario').value.trim();
                    const isBye = adversario.toLowerCase() === 'bye';
                    
                    if (isBye || nextRound === 'Final') { // If it's a bye or the final, show finalization options
                        if (setupFinalizationUI(true)) handleUpdate('V'); 
                    } else { 
                        handleUpdate('V'); 
                    }
                });
                loseBtn.addEventListener('click', () => { 
                    // Always show finalization options on a loss
                    if (setupFinalizationUI(false)) handleUpdate('D'); 
                });
            }
        }
        function handleDetailsClick(e) {
            const button = e.target.closest('.details-btn'); if (!button) return;
            const { filterType, filterValue, view } = button.dataset;
            let originalTournaments;
            if (filterType === 'category') {
                if (filterValue === 'CH') {
                    originalTournaments = allTournaments.filter(t => t.tipo.startsWith('CH'));
                } else {
                    originalTournaments = allTournaments.filter(t => t.tipo === filterValue);
                }
            } 
            else if (filterType === 'surface') { originalTournaments = allTournaments.filter(t => t.superficie === filterValue); }
            if (view === 'titles') { originalTournaments = originalTournaments.filter(t => t.faseFinal === 'Campe칚o'); }
            const seasons = [...new Set(originalTournaments.map(t => t.ano))].sort((a,b) => b-a);
            const tournamentNames = [...new Set(originalTournaments.map(t => t.nome))].sort();
            
            let displayValue = filterValue === 'CH' ? 'Challengers' : filterValue;
            const modalTitleText = view === 'titles' ? `T칤tulos - ${displayValue}` : `Campanhas - ${displayValue}`;
            
            const body = `
                <div class="flex flex-wrap gap-4 mb-4 p-2 bg-slate-100 rounded-lg">
                    <div class="flex-1 min-w-[150px]"><label class="text-xs font-semibold">Torneio:</label><select id="modal-tournament-filter" class="form-select text-sm"><option value="all">Todos</option>${tournamentNames.map(n => `<option value="${n}">${n}</option>`).join('')}</select></div>
                    <div class="flex-1 min-w-[150px]"><label class="text-xs font-semibold">Temporada:</label><select id="modal-season-filter" class="form-select text-sm"><option value="all">Carreira</option>${seasons.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
                </div>
                <div id="modal-results-content" class="space-y-2"></div>`;
            openModal(modalTitleText, body);
            const renderModalContent = () => {
                const seasonFilter = document.getElementById('modal-season-filter').value;
                const tournamentFilter = document.getElementById('modal-tournament-filter').value;
                let filtered = [...originalTournaments].sort((a, b) => new Date(b.dataInicio) - new Date(a.dataInicio));

                if (seasonFilter !== 'all') filtered = filtered.filter(t => t.ano == seasonFilter);
                if (tournamentFilter !== 'all') filtered = filtered.filter(t => t.nome === tournamentFilter);
                
                let contentHTML = '';
                if (filtered.length === 0) { contentHTML = '<p class="text-center p-4">Nenhum resultado para exibir.</p>'; } 
                else if (tournamentFilter !== 'all' && seasonFilter === 'all') {
                    let aggWins = 0, aggLosses = 0, aggTitles = 0;
                    filtered.forEach(t => {
                        aggWins += (t.jogos || []).filter(j => j.resultado === 'V').length;
                        aggLosses += (t.jogos || []).filter(j => j.resultado === 'D').length;
                        if (t.faseFinal === 'Campe칚o') aggTitles++;
                    });
                    contentHTML += `<div class="p-3 bg-slate-50 rounded-lg mb-4 text-center"><h4 class="font-bold">Resumo em ${tournamentFilter}</h4><p>${aggTitles} T칤tulo(s) | ${aggWins}V / ${aggLosses}D</p></div>`;
                }
                
                contentHTML += filtered.map(t => {
                    const vitorias = (t.jogos || []).filter(j => j.resultado === 'V').length;
                    const derrotas = (t.jogos || []).filter(j => j.resultado === 'D').length;
                    const matchesHTML = (t.jogos || []).map(jogo => `
                        <div class="p-2 pl-4 rounded-lg flex justify-between items-center text-xs ${jogo.resultado === 'V' ? 'bg-green-50/50' : (jogo.resultado === 'D' ? 'bg-red-50/50' : 'bg-gray-100/50')}">
                            <div class="flex-grow min-w-0 mr-2">
                                <p class="font-semibold truncate">${jogo.rodada}</p>
                                <p class="text-slate-600 truncate">${getFlagEmoji('BRA')} F. Lapa vs ${jogo.adversario} ${getFlagEmoji(jogo.nacionalidade)}</p>
                            </div>
                            <div class="flex-shrink-0 flex items-center text-right">
                                <span class="font-semibold whitespace-nowrap mr-3">${jogo.placar}</span>
                                <span class="font-bold w-4 ${jogo.resultado === 'V' ? 'text-green-600' : (jogo.resultado === 'D' ? 'text-red-600' : 'text-gray-500')}">${jogo.resultado === 'Bye' ? '' : jogo.resultado}</span>
                            </div>
                        </div>`).join('');

                    return `
                        <div class="tournament-accordion border-b last:border-b-0">
                            <div class="tournament-header p-3 cursor-pointer hover:bg-slate-50 rounded-md">
                                <p class="font-bold flex justify-between items-center">
                                    <span>${getFlagEmoji(t.paisTorneio)} ${t.ano} - ${t.nome}</span>
                                    <span class="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded-md">${t.tipo}</span>
                                </p>
                                <p class="text-sm text-slate-600">Resultado: ${t.faseFinal} | Campanha: ${vitorias}V-${derrotas}D | Pr칡mio: ${formatCurrency(t.premiacao)}</p>
                            </div>
                            <div class="tournament-body pl-4 pb-2 space-y-1">
                                ${matchesHTML}
                            </div>
                        </div>`;
                }).join('');
                document.getElementById('modal-results-content').innerHTML = contentHTML;
            };

            document.getElementById('modal-season-filter').addEventListener('change', renderModalContent);
            document.getElementById('modal-tournament-filter').addEventListener('change', renderModalContent);
            document.getElementById('modal-results-content').addEventListener('click', (e) => {
                const header = e.target.closest('.tournament-header');
                if (header) {
                    header.nextElementSibling.classList.toggle('open');
                }
            });
            renderModalContent();
        }
        
        // --- STATS CALCULATION & UI UPDATES ---
        function updateUI() {
            const stats = calculateAllStats();
            updateSeasonFilter(); 
            renderMainTable(); 
            updateStatsForSeason();
            updateStatsPanels(stats); 
            updateCharts(stats); 
            updateTabs(stats);
            updateOpponentList();
            updateRecordsTab(stats);
        }
        function calculateAllStats() {
            const stats = { 
                rankingPoints: 0, premiacao: 0, titulos: 0, vitoriasATP: 0, derrotasATP: 0, 
                porTipo: {}, porSuperficie: {}, titulosATP: 0, titulosChallenger: 0,
                maxTitulosUnicoTorneio: 0, nomeMaxTitulosUnicoTorneio: '-', maxTitulosEmUmAno: 0, 
                maxPremiacaoEmUmAno: 0, maxVitoriasEmUmAno: 0, maxPorcentagemVitoriasEmUmAno: 0,
                goldenSlamEvents: new Set(), grandSlamEvents: new Set(), 
                finaisATP: 0, finaisGrandSlam: 0,
                idadeMenorCampeaoGS: 0, idadeMaiorCampeaoGS: 0,
                idadeMenorCampeaoMasters: 0,
                pointsToDefendCurrentWeek: 0, // Points from last year in the current week that will drop
                projectedRankingPoints: 0 // Ranking points after current week's drop, before new points
            };

            tournamentTypes.forEach(t => { stats.porTipo[t] = { v: 0, d: 0, t: 0 }; });
            surfaces.forEach(s => { stats.porSuperficie[s] = { v: 0, d: 0, t: 0, atp_v: 0, atp_d: 0, atp_t: 0 }; });
            const oneYearAgo = new Date(); oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const titulosPorNome = {};
            const titulosPorAno = {};
            const premiacaoPorAno = {};
            const vitoriasPorAno = {};
            const derrotasPorAno = {};

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentWeekNumber = getWeekNumber(today);

            const pointsByTournamentId = {}; // To store points for each tournament ID

            allTournaments.forEach(t => {
                const tournamentPoints = Number(t.pontos) || 0;
                const tournamentStartDate = new Date(t.dataInicio + 'T00:00:00');
                const tournamentEndDate = new Date(t.dataFim + 'T00:00:00');
                const tournamentYear = tournamentStartDate.getFullYear();
                const tournamentWeek = getWeekNumber(tournamentStartDate);

                // Store points for each tournament
                pointsByTournamentId[t.id] = tournamentPoints;

                // Check for points to defend in the current week (from previous year)
                if (tournamentYear === currentYear - 1 && tournamentWeek === currentWeekNumber) {
                    stats.pointsToDefendCurrentWeek += tournamentPoints;
                }

                stats.premiacao += Number(t.premiacao) || 0;
                premiacaoPorAno[t.ano] = (premiacaoPorAno[t.ano] || 0) + (Number(t.premiacao) || 0);

                // Filter out 'Bye' results for V/D calculation
                const vitorias = (t.jogos || []).filter(j => j.resultado === 'V').length;
                const derrotas = (t.jogos || []).filter(j => j.resultado === 'D').length;
                const isATP = t.tipo && !t.tipo.startsWith('CH');
                
                if (isATP) {
                    stats.vitoriasATP += vitorias;
                    stats.derrotasATP += derrotas;
                    vitoriasPorAno[t.ano] = (vitoriasPorAno[t.ano] || 0) + vitorias;
                    derrotasPorAno[t.ano] = (derrotasPorAno[t.ano] || 0) + derrotas;
                    
                    if (t.faseFinal?.includes('Final') || t.faseFinal === 'Campe칚o') {
                        stats.finaisATP++;
                        if (t.tipo === 'Grand Slam') stats.finaisGrandSlam++;
                    }
                }
                
                if (t.faseFinal === 'Campe칚o') {
                    stats.titulos++;
                    titulosPorAno[t.ano] = (titulosPorAno[t.ano] || 0) + 1;
                    const nomeNormalizado = t.nome.toLowerCase();
                    titulosPorNome[nomeNormalizado] = (titulosPorNome[nomeNormalizado] || 0) + 1;
                    
                    if (isATP) stats.titulosATP++;
                    else stats.titulosChallenger++;

                    const gsMap = { 'australian open': 'ao', 'roland garros': 'rg', 'wimbledon': 'w', 'us open': 'uo'};
                    const oly = 'jogos ol칤mpicos';
                    if(gsMap[nomeNormalizado]) {
                        stats.grandSlamEvents.add(gsMap[nomeNormalizado]);
                        stats.goldenSlamEvents.add(gsMap[nomeNormalizado]);
                    }
                    if(nomeNormalizado === oly) stats.goldenSlamEvents.add('oly');
                    
                    if (t.dataFim) {
                        const idadeEmMeses = Math.floor((new Date(t.dataFim) - dataNascimentoJogador) / (1000 * 60 * 60 * 24 * 30.44));
                        if (t.tipo === 'Grand Slam') {
                            if (!stats.idadeMenorCampeaoGS || idadeEmMeses < stats.idadeMenorCampeaoGS) stats.idadeMenorCampeaoGS = idadeEmMeses;
                            if (!stats.idadeMaiorCampeaoGS || idadeEmMeses > stats.idadeMaiorCampeaoGS) stats.idadeMaiorCampeaoGS = idadeEmMeses;
                        }
                        if (t.tipo === 'ATP Masters 1000') {
                             if (!stats.idadeMenorCampeaoMasters || idadeEmMeses < stats.idadeMenorCampeaoMasters) stats.idadeMenorCampeaoMasters = idadeEmMeses;
                        }
                    }
                }

                if (stats.porTipo[t.tipo]) { stats.porTipo[t.tipo].v += vitorias; stats.porTipo[t.tipo].d += derrotas; if (t.faseFinal === 'Campe칚o') stats.porTipo[t.tipo].t++; }
                if (stats.porSuperficie[t.superficie]) {
                    stats.porSuperficie[t.superficie].v += vitorias; stats.porSuperficie[t.superficie].d += derrotas;
                    if (isATP) { stats.porSuperficie[t.superficie].atp_v += vitorias; stats.porSuperficie[t.superficie].atp_d += derrotas; if(t.faseFinal === 'Campe칚o') stats.porSuperficie[t.superficie].atp_t++; }
                }
            });

            // Calculate max values for seasons
            if (Object.keys(titulosPorNome).length > 0) {
                stats.maxTitulosUnicoTorneio = Math.max(...Object.values(titulosPorNome));
                stats.nomeMaxTitulosUnicoTorneio = Object.keys(titulosPorNome).find(key => titulosPorNome[key] === stats.maxTitulosUnicoTorneio);
            }
            if (Object.keys(titulosPorAno).length > 0) stats.maxTitulosEmUmAno = Math.max(...Object.values(titulosPorAno));
            if (Object.keys(premiacaoPorAno).length > 0) stats.maxPremiacaoEmUmAno = Math.max(...Object.values(premiacaoPorAno));
            if (Object.keys(vitoriasPorAno).length > 0) stats.maxVitoriasEmUmAno = Math.max(...Object.values(vitoriasPorAno));
            
            // Calc best winning percentage in a season (min 10 matches)
            let bestPerc = 0;
            Object.keys(vitoriasPorAno).forEach(ano => {
                const v = vitoriasPorAno[ano] || 0;
                const d = derrotasPorAno[ano] || 0;
                if (v + d > 10) {
                    const perc = (v / (v + d)) * 100;
                    if (perc > bestPerc) bestPerc = perc;
                }
            });
            stats.maxPorcentagemVitoriasEmUmAno = bestPerc;

            // Calculate current ranking points (best 19/20 results over 52 weeks)
            const sortedPoints = Object.values(pointsByTournamentId).sort((a, b) => b - a);
            stats.rankingPoints = sortedPoints.slice(0, 19).reduce((sum, points) => sum + points, 0); // Sum best 19 results

            // Calculate projected ranking points
            stats.projectedRankingPoints = stats.rankingPoints - stats.pointsToDefendCurrentWeek;
            if (stats.projectedRankingPoints < 0) stats.projectedRankingPoints = 0; // Points can't be negative

            return stats;
        }
        function updateStatsPanels(stats) {
            document.getElementById('ranking').textContent = `${estimarRanking(stats.rankingPoints)} (${stats.rankingPoints} pts)`;
            document.getElementById('premiacao').textContent = formatCurrency(stats.premiacao);
            // CORRE칂츾O AQUI: Usando titulosATP em vez de stats.titulos (que incluia Challenger)
            document.getElementById('titulos-total').textContent = stats.titulosATP;
            document.getElementById('vitorias-derrotas').textContent = `${stats.vitoriasATP} / ${stats.derrotasATP}`;

            // New projection stats
            document.getElementById('current-ranking-points').textContent = `${stats.rankingPoints} pts`;
            document.getElementById('points-to-defend').textContent = `${stats.pointsToDefendCurrentWeek} pts`;
            document.getElementById('projected-ranking').textContent = `${estimarRanking(stats.projectedRankingPoints)} (${stats.projectedRankingPoints} pts)`;
        }
        function updateTabs(stats) {
             const atpTypes = tournamentTypes.filter(t => !t.startsWith('CH'));
             const chTypes = tournamentTypes.filter(t => t.startsWith('CH'));

             // REMOVE CHALLENGERS FROM TITLES LIST - Only ATP Types
             let titulosListHTML = atpTypes.map(type => `<p class="flex justify-between items-center"><strong>${type}:</strong> <span>${stats.porTipo[type]?.t || 0} <button class="details-btn" data-filter-type="category" data-filter-value="${type}" data-view="titles" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></p>`).join('');
             
             // Restaurada a se칞칚o de Challengers (colaps치vel)
             const totalChTitles = chTypes.reduce((sum, type) => sum + (stats.porTipo[type]?.t || 0), 0);
             titulosListHTML += `<div><p class="flex justify-between items-center"><strong>Challengers:</strong> <span>${totalChTitles} <button class="details-btn" data-filter-type="category" data-filter-value="CH" data-view="titles" title="Ver detalhes de todos os Challengers"><i class="fa-solid fa-eye"></i></button><button class="toggle-sublist-btn" data-target="ch-titles-sublist"><i class="fa-solid fa-plus"></i></button></span></p><div id="ch-titles-sublist" class="sublist pl-4 space-y-1 mt-1">${chTypes.map(type => `<p class="flex justify-between items-center text-xs"><em>${type}:</em> <span>${stats.porTipo[type]?.t || 0}</span></p>`).join('')}</div></div>`;

             document.getElementById('titulos-list').innerHTML = titulosListHTML;
             
             let vitoriasListHTML = atpTypes.map(type => `<div class="flex justify-between items-center">${type}: <span>${stats.porTipo[type]?.v || 0} / ${stats.porTipo[type]?.d || 0} <button class="details-btn" data-filter-type="category" data-filter-value="${type}" data-view="wins" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></div>`).join('');
             const totalChWins = chTypes.reduce((sum, type) => sum + (stats.porTipo[type]?.v || 0), 0);
             const totalChLosses = chTypes.reduce((sum, type) => sum + (stats.porTipo[type]?.d || 0), 0);
             vitoriasListHTML += `<div><div class="flex justify-between items-center">Challengers: <span>${totalChWins} / ${totalChLosses} <button class="details-btn" data-filter-type="category" data-filter-value="CH" data-view="wins" title="Ver detalhes de todos os Challengers"><i class="fa-solid fa-eye"></i></button><button class="toggle-sublist-btn" data-target="ch-wins-sublist"><i class="fa-solid fa-plus"></i></button></span></div><div id="ch-wins-sublist" class="sublist pl-4 space-y-1 mt-1">${chTypes.map(type => `<div class="flex justify-between items-center text-xs"><em>${type}:</em> <span>${stats.porTipo[type]?.v || 0} / ${stats.porTipo[type]?.d || 0}</span></div>`).join('')}</div></div>`;
             document.getElementById('vitorias-list').innerHTML = vitoriasListHTML;
             
             const titulosATP = Object.entries(stats.porTipo).filter(([key]) => key && !key.startsWith("CH")).reduce((sum, [, val]) => sum + val.t, 0);
             document.getElementById('titulos-total-resumo').textContent = titulosATP;
             document.getElementById('titulos-surface-list').innerHTML = surfaces.map(s => `<li class="flex justify-between items-center">${s}: <span>${stats.porSuperficie[s]?.atp_t || 0} <button class="details-btn" data-filter-type="surface" data-filter-value="${s}" data-view="titles" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></li>`).join('');
             document.getElementById('total-vitorias').textContent = stats.vitoriasATP;
             document.getElementById('total-derrotas').textContent = stats.derrotasATP;
             document.getElementById('taxa-vitorias').textContent = (stats.vitoriasATP + stats.derrotasATP > 0) ? `${((stats.vitoriasATP / (stats.vitoriasATP + stats.derrotasATP)) * 100).toFixed(1)}%` : '0%';
             document.getElementById('vitorias-surface-list').innerHTML = surfaces.map(s => `<li class="flex justify-between items-center">${s}: <span>${stats.porSuperficie[s]?.atp_v || 0} / ${stats.porSuperficie[s]?.atp_d || 0} <button class="details-btn" data-filter-type="surface" data-filter-value="${s}" data-view="wins" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></li>`).join('');
        }
        function updateCharts(stats) {
             if (titulosChart) { 
                 // CORRE칂츾O AQUI: Chart volta a mostrar tudo (incluindo challengers) para visualiza칞칚o de distribui칞칚o
                 titulosChart.data.labels = tournamentTypes;
                 titulosChart.data.datasets[0].data = tournamentTypes.map(t => stats.porTipo[t]?.t || 0); 
                 titulosChart.update(); 
             }
             if (vitoriasChart) {
                vitoriasChart.data.datasets[0].data = surfaces.map(s => stats.porSuperficie[s]?.atp_v || 0);
                vitoriasChart.data.datasets[1].data = surfaces.map(s => stats.porSuperficie[s]?.atp_d || 0);
                vitoriasChart.update();
             }
        }
        function updateRecordsTab(stats) {
            const container = document.getElementById('recordes-conquistados');
            let html = worldRecords.map(record => {
                const playerValue = record.stat(stats);
                const isBroken = record.isLowerBetter ? (playerValue > 0 && playerValue < record.value) : (playerValue >= record.value);
                const progress = record.value > 0 ? Math.min((playerValue / record.value) * 100, 100) : (isBroken ? 100 : 0);
                return `
                <div class="glass-card p-4 rounded-lg ${isBroken ? 'bg-green-100/50 border-green-400' : 'bg-white/30'}">
                    <h4 class="font-bold text-md text-primary">${record.title} ${isBroken ? '游끥' : ''}</h4>
                    <p class="text-xs text-slate-600 mt-1">Recorde: ${record.holder} (${record.format(record.value, {})})</p>
                    <p class="text-sm font-semibold mt-2">Progresso de Fernando: ${record.format(playerValue, stats)}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>`;
            }).join('');
            container.innerHTML = html || '<p class="text-gray-500 md:col-span-2">Nenhum recorde para exibir.</p>';
        }
        function renderMainTable() {
            const tableBody = document.getElementById('temporadas-tabela');
            const noDataMsg = document.getElementById('no-tournaments-msg');
            const season = document.getElementById('season-filter').value;
            const filtered = (season === 'all') ? allTournaments : allTournaments.filter(t => t.ano == season);
            filtered.sort((a, b) => new Date(b.dataInicio) - new Date(a.dataInicio));
            if (filtered.length === 0) { tableBody.innerHTML = ''; noDataMsg.style.display = 'block'; return; }
            noDataMsg.style.display = 'none';
            tableBody.innerHTML = filtered.map(t => `
                <tr class="group border-b border-slate-200/50 hover:bg-slate-50/50 transition-colors duration-200" data-id="${t.id}">
                    <td class="py-4 px-2 whitespace-nowrap text-xs text-slate-600 group-hover:text-slate-800">${t.dataInicio ? t.dataInicio.split('-').reverse().join('/') : 'N/A'}</td>
                    <td class="py-4 px-2 font-semibold text-slate-800">
                        <span class="flex items-center">
                            ${getFlagEmoji(t.paisTorneio)} 
                            <span class="ml-2">${t.nome || ''}</span>
                            <span class="text-xs text-slate-500 ml-1 whitespace-nowrap">(${abbreviateTournamentType(t.tipo) || ''})</span>
                        </span>
                    </td>
                    <td class="py-4 px-2 text-center text-slate-600 capitalize">${t.superficie || 'N/A'}</td>
                    <td class="py-4 px-2 text-center">
                        <span class="px-2 py-1 text-xs font-bold rounded-full whitespace-nowrap ${t.status === 'Finalizado' ? 'bg-slate-400 text-white' : 'bg-yellow-400 text-black'}">${t.status}</span>
                    </td>
                    <td class="py-4 px-2 text-center text-sm font-medium">
                        <span class="text-green-600">${(t.jogos || []).filter(j => j.resultado === 'V').length}</span>
                        /
                        <span class="text-red-600">${(t.jogos || []).filter(j => j.resultado === 'D').length}</span>
                    </td>
                    <td class="py-4 px-2 text-left text-sm font-medium text-slate-700">${t.faseFinal || '-'}</td>
                    <td class="py-4 px-2 text-center">
                        <button class="delete-btn text-slate-400 hover:text-red-500 transition-colors duration-200" data-id="${t.id}" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`).join('');
            tableBody.querySelectorAll('tr').forEach(row => row.addEventListener('click', (e) => { if (!e.target.closest('.delete-btn')) openManageTournamentModal(row.dataset.id); }));
            tableBody.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); deleteTournamentFromDb(btn.dataset.id); }));
        }
        function updateSeasonFilter() {
             const anos = [...new Set(allTournaments.map(t => t.ano))].filter(Boolean).sort((a, b) => b - a);
             const select = document.getElementById('season-filter');
             const currentYear = new Date().getFullYear();
             select.innerHTML = `<option value="all">Todas</option>${anos.map(ano => `<option value="${ano}">${ano}</option>`).join('')}`;
             if (anos.includes(currentYear)) {
                 select.value = currentYear;
             } else if (anos.length > 0) {
                 select.value = anos[0];
             }
        }
        function updateStatsForSeason() {
            const season = document.getElementById('season-filter').value;
            if (!season) return;
            const filtered = (season === 'all') ? allTournaments : allTournaments.filter(t => t.ano == season);
            let vitoriasATP = 0, derrotasATP = 0, titulosATP = 0, premiacao = 0;
            filtered.forEach(t => {
                premiacao += Number(t.premiacao) || 0;
                const isATP = t.tipo && !t.tipo.startsWith('CH');
                if (isATP) {
                    vitoriasATP += (t.jogos || []).filter(j => j.resultado === 'V').length;
                    derrotasATP += (t.jogos || []).filter(j => j.resultado === 'D').length;
                    if(t.faseFinal === 'Campe칚o') titulosATP++;
                }
            });
            document.getElementById('temporadas-vitorias').textContent = vitoriasATP;
            document.getElementById('temporadas-derrotas').textContent = derrotasATP;
            document.getElementById('temporadas-titulos').textContent = titulosATP;
            document.getElementById('temporadas-premiacao').textContent = formatCurrency(premiacao);
        }
        // --- H2H FUNCTIONS ---
        function updateOpponentList() {
            const opponentMap = new Map();
            availableOpponentCountries = new Set();
            
            allTournaments.forEach(t => (t.jogos || []).forEach(j => {
                const normalized = j.adversario.trim().toLowerCase();
                if (!opponentMap.has(normalized)) {
                    opponentMap.set(normalized, { name: j.adversario.trim(), country: j.nacionalidade });
                }
                if (j.nacionalidade && j.nacionalidade !== 'ATP') {
                    availableOpponentCountries.add(j.nacionalidade);
                }
            }));
            
            // Populate global names
            allOpponentNames = Array.from(opponentMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            
            // CORRE칂츾O: Merge DB countries with Major Countries list
            const combinedCountries = new Set([...availableOpponentCountries, ...majorCountries]);
            const sortedCountries = Array.from(combinedCountries).sort();
            
            // Populate Country Filter
            const countrySelect = document.getElementById('h2h-country-filter');
            const currentVal = countrySelect.value;
            countrySelect.innerHTML = '<option value="">Todos os Pa칤ses</option>' + 
                sortedCountries.map(c => `<option value="${c}">${c} ${getFlagEmoji(c)}</option>`).join('');
            countrySelect.value = currentVal;
        }

        function handleH2hSearchInput() {
            const searchInput = document.getElementById('h2h-search');
            const suggestionsDiv = document.getElementById('h2h-suggestions');
            const countryFilter = document.getElementById('h2h-country-filter').value;
            const query = searchInput.value.toLowerCase();
            
            if (!query) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            let filteredOpponents = allOpponentNames;
            
            if (countryFilter) {
                filteredOpponents = filteredOpponents.filter(op => op.country === countryFilter);
            }
            
            const suggestions = filteredOpponents.filter(op => op.name.toLowerCase().includes(query));

            if (suggestions.length > 0) {
                const isMobile = window.innerWidth < 768;
                suggestionsDiv.style.bottom = isMobile ? '100%' : 'auto';
                suggestionsDiv.style.top = isMobile ? 'auto' : '100%';
                suggestionsDiv.innerHTML = suggestions.map(op => `<div class="p-2 hover:bg-slate-100 cursor-pointer">${op.name} ${getFlagEmoji(op.country)}</div>`).join('');
                suggestionsDiv.classList.remove('hidden');
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        }

        function displayH2HResults() {
            const opponentNameInput = document.getElementById('h2h-search').value.trim();
            const countryFilter = document.getElementById('h2h-country-filter').value;
            const resultsDiv = document.getElementById('h2h-results');
            
            // Case 1: No Input, No Country -> Reset
            if (!opponentNameInput && !countryFilter) { 
                resultsDiv.innerHTML = `<p class="text-center text-slate-500 py-8">Selecione um advers치rio ou pa칤s.</p>`; 
                return; 
            }
            
            // Case 2: Country Selected but No Name Input -> List all players from that country
            if (countryFilter && !opponentNameInput) {
                const opponentsFromCountry = allOpponentNames.filter(op => op.country === countryFilter);
                if(opponentsFromCountry.length === 0) {
                    resultsDiv.innerHTML = `<p class="text-center text-slate-500 py-8">Nenhum advers치rio enfrentado do pa칤s: ${getFlagEmoji(countryFilter)} ${countryFilter}.</p>`;
                    return;
                }

                let listHtml = `<div class="mb-4 text-center font-bold text-lg text-slate-700">Advers치rios de ${getFlagEmoji(countryFilter)} ${countryFilter}</div>`;
                listHtml += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[400px] overflow-y-auto">`;
                
                opponentsFromCountry.forEach(op => {
                    let wins = 0, losses = 0;
                    allTournaments.forEach(t => {
                        (t.jogos || []).forEach(j => {
                             if (j.adversario.trim().toLowerCase() === op.name.toLowerCase()) {
                                if (j.resultado === 'V') wins++; else losses++;
                             }
                        });
                    });
                    listHtml += `
                        <div class="bg-white border border-slate-200 p-3 rounded-lg flex justify-between items-center cursor-pointer hover:bg-slate-50" onclick="document.getElementById('h2h-search').value = '${op.name}'; document.getElementById('h2h-search').dispatchEvent(new Event('change'));">
                            <span class="font-medium">${op.name}</span>
                            <span class="text-sm"><span class="text-green-600 font-bold">${wins}</span> - <span class="text-red-600 font-bold">${losses}</span></span>
                        </div>`;
                });
                listHtml += `</div><p class="text-center text-xs text-slate-400 mt-2">Clique em um jogador para ver detalhes.</p>`;
                resultsDiv.innerHTML = listHtml;
                return;
            }

            // Case 3: Specific Opponent Search (with or without country filter)
            let wins = 0, losses = 0; const matches = [];
            let opponentNationalityCode = '';
            
            allTournaments.forEach(t => {
                (t.jogos || []).forEach(j => {
                    if (j.adversario.trim().toLowerCase() === opponentNameInput.toLowerCase()) {
                        if (countryFilter && j.nacionalidade !== countryFilter) return; // Filter mismatch check
                        
                        if (j.resultado === 'V') wins++; else losses++;
                        if (j.nacionalidade && !opponentNationalityCode) opponentNationalityCode = j.nacionalidade;
                        matches.push({ ...t, ...j });
                    }
                });
            });

            if (matches.length === 0) {
                 resultsDiv.innerHTML = `<p class="text-center text-slate-500 py-8">Nenhum confronto encontrado${countryFilter ? ` com este filtro de pa칤s` : ''}.</p>`; 
                 return;
            }

            matches.sort((a,b) => new Date(b.dataInicio) - new Date(a.dataInicio));
            let html = `<div class="text-center mb-6"><p class="text-xl md:text-2xl font-bold whitespace-nowrap">F. Lapa ${getFlagEmoji('BRA')} <span class="text-green-600">${wins}</span> x <span class="text-red-600">${losses}</span> ${opponentNameInput} ${getFlagEmoji(opponentNationalityCode)}</p></div>`;
            
            html += `
                <div class="overflow-x-auto"><table class="w-full text-sm">
                    <thead class="text-xs uppercase bg-slate-100"><tr>
                        <th class="py-3 px-2 md:px-4 text-left">Ano</th><th class="py-3 px-2 md:px-4 text-left">Torneio</th>
                        <th class="py-3 px-2 md:px-4 text-left whitespace-nowrap">Tipo</th><th class="py-3 px-2 md:px-4 text-left">Rodada</th>
                        <th class="py-3 px-2 md:px-4 text-left">Piso</th><th class="py-3 px-2 md:px-4 text-left whitespace-nowrap">Placar</th>
                        <th class="py-3 px-2 md:px-4 text-left">Res.</th>
                    </tr></thead><tbody>
                    ${matches.map(m => `
                        <tr class="border-b odd:bg-white even:bg-slate-50">
                            <td class="py-3 px-2 md:px-4">${m.ano}</td>
                            <td class="py-3 px-2 md:px-4 font-semibold">${getFlagEmoji(m.paisTorneio)} ${m.nome}</td>
                            <td class="py-3 px-2 md:px-4 whitespace-nowrap">${abbreviateTournamentType(m.tipo)}</td>
                            <td class="py-3 px-2 md:px-4">${abbreviateRound(m.rodada)}</td>
                            <td class="py-3 px-2 md:px-4">${m.superficie}</td>
                            <td class="py-3 px-2 md:px-4 whitespace-nowrap">${m.placar}</td>
                            <td class="py-3 px-2 md:px-4 font-bold ${m.resultado === 'V' ? 'text-green-600' : 'text-red-600'}">${m.resultado === 'V' ? 'Vit칩ria' : 'Derrota'}</td>
                        </tr>`).join('')}
                    </tbody></table></div>`;
            resultsDiv.innerHTML = html;
        }
        // --- INITIALIZATION ---
        function initialize() {
            document.getElementById('create-tournament-btn').addEventListener('click', openCreateTournamentModal);
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.getElementById('season-filter').addEventListener('change', () => { renderMainTable(); updateStatsForSeason(); });
            
            const h2hSearch = document.getElementById('h2h-search');
            const h2hCountry = document.getElementById('h2h-country-filter');

            h2hSearch.addEventListener('input', handleH2hSearchInput);
            h2hSearch.addEventListener('change', displayH2HResults);
            h2hCountry.addEventListener('change', () => {
                 handleH2hSearchInput(); // Update suggestions
                 displayH2HResults();   // Update results
            });

            document.getElementById('h2h-suggestions').addEventListener('click', (e) => {
                if (e.target.tagName === 'DIV') {
                    const text = e.target.innerText; 
                    const namePart = text.split(/[\uD800-\uDBFF][\uDC00-\uDFFF]/)[0].trim();
                    h2hSearch.value = namePart;
                    document.getElementById('h2h-suggestions').classList.add('hidden');
                    displayH2HResults();
                }
            });
            document.addEventListener('click', (e) => { if (!e.target.closest('.relative')) { document.getElementById('h2h-suggestions').classList.add('hidden'); }});
            document.getElementById('titulos-list').addEventListener('click', handleDetailsClick);
            document.getElementById('vitorias-list').addEventListener('click', handleDetailsClick);
            document.getElementById('titulos-surface-list').addEventListener('click', handleDetailsClick);
            document.getElementById('vitorias-surface-list').addEventListener('click', handleDetailsClick);
            
            const listContainers = ['vitorias-list', 'titulos-list'];
            listContainers.forEach(id => {
                document.getElementById(id).addEventListener('click', (e) => {
                    const button = e.target.closest('.toggle-sublist-btn');
                    if (!button) return;
                    const targetId = button.dataset.target;
                    const target = document.getElementById(targetId);
                    const icon = button.querySelector('i');
                    target.classList.toggle('open');
                    icon.classList.toggle('fa-plus');
                    icon.classList.toggle('fa-minus');
                });
            });

            const tabButtons = document.querySelectorAll('.tab-button'), tabContents = document.querySelectorAll('.tab-content');
            tabButtons.forEach(button => button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(button.dataset.tab).classList.add('active');
            }));
            const chartColors = ['#facc15', '#10b981', '#1e3a8a', '#22d3ee', '#f97316', '#8b5cf6', '#6b7280', '#a1a1aa', '#71717a', '#52525b', '#4b5563'];
            titulosChart = new Chart(document.getElementById('titulosChart').getContext('2d'), { type: 'pie', data: { labels: tournamentTypes, datasets: [{ data: [], backgroundColor: chartColors }] } });
            vitoriasChart = new Chart(document.getElementById('vitoriasChart').getContext('2d'), { type: 'bar', data: { labels: surfaces, datasets: [{ label: 'Vit칩rias (ATP)', data: [], backgroundColor: '#10b981' }, { label: 'Derrotas (ATP)', data: [], backgroundColor: '#ef4444' }]}, options: { scales: { y: { beginAtZero: true } } } });
            
            calcularIdade();
            document.getElementById('main-flag').textContent = getFlagEmoji('BRA');
            loadTournamentsFromDb();
        }

        function calcularIdade(){
            const hoje = new Date();
            let idade = hoje.getFullYear() - dataNascimentoJogador.getFullYear();
            const m = hoje.getMonth() - dataNascimentoJogador.getMonth();
            if (m < 0 || (m === 0 && hoje.getDate() < dataNascimentoJogador.getDate())) {
                idade--;
            }
            document.getElementById('idade').textContent = idade;
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
