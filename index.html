<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fernando Lapa - Tennis Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
    <style>
        /*
         * V6: Cores Finais e Contraste Máximo
         */
        :root {
            --primary: #06b6d4; /* Cyan/Sky Blue for accent and interaction */
            --secondary: #10b981; /* Green for success/wins */
            --accent: #fcd34d; /* Amber/Yellow for titles */
            --background-deep: #121A2A; 
            --card-base: #222B40; 
            --text-main: #F8FAFC; 
            --text-muted: #AAB8C8; 
            --border-subtle: #475569; 
        }

        html, body { overflow-x: hidden; width: 100%; }
        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-deep);
            background-image: radial-gradient(at 0% 0%, #3b82f630, transparent 50%), 
                              radial-gradient(at 100% 100%, #06b6d430, transparent 50%);
            background-attachment: fixed;
            color: var(--text-main);
            transition: all 0.5s ease;
        }

        .main-container {
            display: grid; grid-template-columns: 1fr; gap: 2rem; width: 100%;
            max-width: 1500px; margin: 0 auto; padding: 2rem 1rem;
        }
        @media (min-width: 1024px) { .main-container { grid-template-columns: 320px 1fr; } }
        
        .dashboard-card {
            background: var(--card-base);
            border: 1px solid var(--border-subtle); 
            border-radius: 1rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); 
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .dashboard-card:hover {
             transform: translateY(-3px);
             box-shadow: 0 10px 30px rgba(6, 182, 212, 0.25); 
             border-color: var(--primary); 
        }
        
        /* Stats Display Styling */
        .stat-value {
            font-weight: 900;
            font-size: 1.5rem; 
            color: var(--text-main); 
        }
        .stat-label {
            font-weight: 500;
            font-size: 0.9rem; 
            color: var(--text-muted); 
        }

        /* Tab Navigation Styling */
        .tab-nav-container {
            background-color: var(--card-base);
            border-radius: 1rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            border: 1px solid var(--border-subtle); 
        }
        .tab-nav-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(6, 182, 212, 0.25); 
            border-color: var(--primary); 
        }

        .tab-button {
            padding: 0.75rem 1.25rem; font-weight: 700; font-size: 0.95rem;
            border-radius: 0.75rem; border: none; color: var(--text-muted);
            background-color: transparent; cursor: pointer; transition: all 0.3s ease; white-space: nowrap;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .tab-button:hover { color: var(--text-main); background-color: #3f5075; }
        .tab-button.active {
            color: var(--primary); 
            background-color: var(--background-deep); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
            border: 1px solid var(--primary); 
        }

        .tab-content { display: none; opacity: 0; transition: opacity 0.4s ease, transform 0.4s ease; transform: translateY(10px); }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }
        
        /* Forms and Buttons */
        .form-input, .form-select {
            padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border-subtle);
            background-color: var(--background-deep); 
            color: var(--text-main);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.4);
        }
        .btn {
            padding: 0.75rem 1.5rem; font-weight: 700; border-radius: 0.5rem; color: #1c2132;
            background: linear-gradient(135deg, var(--primary), #38bdf8);
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
            transition: transform 0.2s ease, box-shadow 0.3s ease; cursor: pointer; border: none;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        }
        .btn:hover { background: linear-gradient(135deg, #38bdf8, var(--primary)); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(6, 182, 212, 0.5); }
        .btn-secondary { background: linear-gradient(135deg, var(--secondary), #4ade80); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-secondary:hover { background: linear-gradient(135deg, #4ade80, var(--secondary)); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #f87171); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); color: white; }
        .btn-danger:hover { background: linear-gradient(135deg, #f87171, #ef4444); }
        
        /* Table Styles */
        #temporadas-tabela tr:nth-child(even) { background-color: #27344D; }
        #temporadas-tabela tr:hover { background-color: #3f5075 !important; }
        .tournament-accordion .tournament-header:hover { background-color: #3f5075 !important; }

        /* Record Card Specifics */
        .record-holder-value {
            font-weight: 700;
            color: var(--text-main);
        }

        /* Sublist Styling */
        .sublist {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .sublist.open {
            max-height: 200px; 
            transition: max-height 0.5s ease-in;
        }

        /* Custom Chart.js Tooltip Styling for a more modern look */
        .chartjs-tooltip {
            background: var(--card-base) !important;
            border: 1px solid var(--primary) !important;
            border-radius: 0.5rem !important;
            padding: 10px !important;
            opacity: 1 !important;
            font-family: 'Inter', sans-serif !important;
            color: var(--text-main) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4) !important;
        }
        .chartjs-tooltip table {
            margin: 0 !important;
        }
        .chartjs-tooltip thead tr {
            border-bottom: 1px solid var(--border-subtle) !important;
            margin-bottom: 5px !important;
        }
        .chartjs-tooltip tbody tr span {
            font-weight: 600 !important;
            color: var(--text-main) !important;
        }
        .chartjs-tooltip-key {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 8px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <aside class="space-y-6">
            <div class="dashboard-card p-8 text-center">
                <div class="w-28 h-28 mx-auto mb-4 bg-gray-700 rounded-full flex items-center justify-center border-4 border-primary/50 overflow-hidden shadow-xl">
                     <img src="https://ui-avatars.com/api/?name=FL&background=06b6d4&color=fff&size=100&bold=true&rounded=true" alt="Avatar Fernando Lapa" class="w-full h-full object-cover">
                </div>
                <div class="flex items-center justify-center gap-2 mb-1">
                    <h1 class="text-2xl font-extrabold text-text-main">Fernando Lapa</h1>
                    <span id="main-flag" class="text-2xl"></span>
                </div>
                <p class="text-sm font-medium text-text-muted">Tenista Profissional</p>
                <div class="mt-4 border-t border-border-subtle pt-4 text-xs text-text-muted">
                    <div class="flex justify-center items-center gap-4">
                         <span class="flex items-center"><i class="fa-solid fa-cake-candles mr-2 text-primary"></i> 18/02/2011 (<span id="idade"></span> anos)</span>
                    </div>
                    <div class="mt-1 flex justify-center items-center">
                        <i class="fa-solid fa-location-dot mr-2 text-secondary"></i> Florianópolis, SC, Brasil
                    </div>
                </div>
            </div>

            <div class="dashboard-card p-6 space-y-4">
                <h2 class="text-xl font-bold border-b border-border-subtle pb-3 mb-2 text-text-main">Estatísticas Chave</h2>
                <div class="flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <span class="stat-label flex items-center"><i class="fa-solid fa-ranking-star w-5 mr-3 text-primary"></i>Ranking Atual</span>
                        <span id="ranking" class="stat-value text-text-main">Sem ranking</span>
                    </div>
                    <div class="flex items-center justify-between border-t border-border-subtle pt-3">
                        <span class="stat-label flex items-center"><i class="fa-solid fa-sack-dollar w-5 mr-3 text-secondary"></i>Total de Prêmios</span>
                        <span id="premiacao" class="stat-value text-secondary">$0.00</span>
                    </div>
                    <div class="flex items-center justify-between border-t border-border-subtle pt-3">
                        <span class="stat-label flex items-center"><i class="fa-solid fa-trophy w-5 mr-3 text-accent"></i>Títulos (ATP 250+)</span>
                        <span id="titulos-total" class="stat-value text-accent">0</span>
                    </div>
                     <div class="flex items-center justify-between border-t border-border-subtle pt-3">
                        <span class="stat-label flex items-center"><i class="fa-solid fa-right-left w-5 mr-3 text-red-400"></i>V/D na Carreira (ATP)</span>
                        <span id="vitorias-derrotas" class="stat-value text-text-main">0 / 0</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-card p-6 space-y-4">
                <h2 class="text-xl font-bold border-b border-border-subtle pb-3 mb-2 text-text-main">Análise de Pontos</h2>
                <div class="flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <span class="stat-label flex items-center"><i class="fa-solid fa-calendar-alt w-5 mr-3 text-primary"></i>Pontos Atuais</span>
                        <span id="current-ranking-points" class="stat-value text-text-main">0 pts</span>
                    </div>
                    <div class="flex items-center justify-between border-t border-border-subtle pt-3">
                        <span class="stat-label flex items-center"><i class="fa-solid fa-arrow-down w-5 mr-3 text-red-500"></i>Pontos a Defender</span>
                        <span id="points-to-defend" class="stat-value text-red-500">0 pts</span>
                    </div>
                    <div class="flex items-center justify-between border-t border-border-subtle pt-3">
                        <span class="stat-label flex items-center"><i class="fa-solid fa-chart-line w-5 mr-3 text-sky-400"></i>Projeção de Ranking</span>
                        <span id="projected-ranking" class="stat-value text-sky-400">Sem Ranking</span>
                    </div>
                </div>
            </div>

            <div class="p-0">
                 <button id="create-tournament-btn" class="btn w-full flex justify-center items-center text-lg">
                    <i class="fa-solid fa-plus-circle mr-2"></i>Criar Novo Torneio
                </button>
            </div>
        </aside>

        <main class="space-y-8 min-w-0">
            <div class="tab-nav-container flex items-center justify-start gap-2 overflow-x-auto" role="tablist">
                 <button class="tab-button active" data-tab="temporadas" role="tab" aria-selected="true"><i class="fas fa-calendar-days"></i>Temporadas</button>
                 <button class="tab-button" data-tab="titulos" role="tab" aria-selected="false"><i class="fas fa-trophy"></i>Títulos</button>
                 <button class="tab-button" data-tab="vitorias" role="tab" aria-selected="false"><i class="fas fa-right-left"></i>V/D</button>
                 <button class="tab-button" data-tab="h2h" role="tab" aria-selected="false"><i class="fas fa-handshake"></i>Head-to-Head</button>
                 <button class="tab-button" data-tab="recordes" role="tab" aria-selected="false"><i class="fas fa-medal"></i>Recordes</button>
            </div>
            
            <div>
                <div id="temporadas" class="tab-content active" role="tabpanel">
                    <div class="dashboard-card p-4 md:p-6">
                        <h2 class="text-2xl font-extrabold mb-6 text-text-main">Histórico de Campanhas</h2>
                        <div class="flex items-center gap-4 mb-8 bg-background-deep p-4 rounded-lg border border-border-subtle">
                            <label for="season-filter" class="font-semibold text-text-muted text-lg">Filtrar por Temporada:</label>
                            <select id="season-filter" class="form-select w-auto"></select>
                        </div>
                        <div class="mb-8 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-card-base/50 p-3 rounded-lg border border-border-subtle"><p class="stat-label">Vitórias (ATP)</p><p id="temporadas-vitorias" class="stat-value text-secondary">0</p></div>
                            <div class="bg-card-base/50 p-3 rounded-lg border border-border-subtle"><p class="stat-label">Derrotas (ATP)</p><p id="temporadas-derrotas" class="stat-value text-red-400">0</p></div>
                            <div class="bg-card-base/50 p-3 rounded-lg border border-border-subtle"><p class="stat-label">Títulos (ATP)</p><p id="temporadas-titulos" class="stat-value text-accent">0</p></div>
                            <div class="bg-card-base/50 p-3 rounded-lg border border-border-subtle"><p class="stat-label">Premiação</p><p id="temporadas-premiacao" class="stat-value text-primary">$0.00</p></div>
                        </div>

                        <div class="overflow-x-auto rounded-lg border border-border-subtle">
                            <table class="w-full min-w-[700px] sm:min-w-full text-left">
                                <thead class="bg-card-base text-xs text-text-muted uppercase font-semibold">
                                    <tr>
                                        <th class="py-3 px-4 rounded-tl-lg">Datas</th>
                                        <th class="py-3 px-4">Torneio</th>
                                        <th class="py-3 px-4 text-center">Superfície</th>
                                        <th class="py-3 px-4 text-center">Status</th>
                                        <th class="py-3 px-4 text-center">V/D</th>
                                        <th class="py-3 px-4">Resultado Final</th>
                                        <th class="py-3 px-4 rounded-tr-lg text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="temporadas-tabela" class="text-sm align-middle divide-y divide-border-subtle"></tbody>
                            </table>
                             <p id="no-tournaments-msg" class="text-center text-text-muted py-8 hidden">Nenhum torneio encontrado. Clique em "Criar Novo Torneio" para começar.</p>
                        </div>
                        
                        <div class="mt-10 pt-6 border-t border-border-subtle">
                             <h3 class="text-lg font-bold mb-4 text-text-main">Gerenciar Dados</h3>
                             <div class="flex flex-wrap gap-4 items-center">
                                 <button id="export-btn" class="btn bg-primary hover:bg-sky-400"><i class="fas fa-file-export mr-2"></i>Exportar Dados</button>
                                 <label for="import-file" class="btn btn-secondary cursor-pointer"><i class="fas fa-file-import mr-2"></i>Importar Dados</label>
                                 <input type="file" id="import-file" class="hidden" accept=".json">
                             </div>
                        </div>
                    </div>
                </div>

                <div id="titulos" class="tab-content" role="tabpanel">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="dashboard-card p-4 md:p-6">
                            <h2 class="text-2xl font-extrabold mb-6 text-text-main">Resumo de Títulos</h2>
                             <p class="text-sm text-text-muted mb-4">O total abaixo contabiliza apenas títulos ATP (250+).</p>
                             <p class="font-extrabold text-2xl mb-6">Total de Títulos (ATP): <span id="titulos-total-resumo" class="text-primary">0</span></p>
                             
                             <h3 class="text-lg font-bold mb-3 text-text-main border-b border-border-subtle pb-2">Por Categoria</h3>
                             <div id="titulos-list" class="space-y-1 text-sm"></div>
                             
                             <h3 class="font-bold mt-6 pt-4 border-t border-border-subtle text-lg text-text-main">Por Superfície (ATP):</h3>
                             <ul id="titulos-surface-list" class="list-none pl-0 text-sm space-y-1 pt-2"></ul>
                        </div>
                         <div class="dashboard-card p-4 md:p-6 flex flex-col justify-center">
                            <h3 class="text-xl font-bold mb-4 text-text-main text-center">Distribuição de Títulos</h3>
                            <div class="w-full max-h-96 mx-auto">
                                <canvas id="titulosChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="vitorias" class="tab-content" role="tabpanel">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="dashboard-card p-4 md:p-6">
                            <h2 class="text-2xl font-extrabold mb-6 text-text-main">Vitórias e Derrotas</h2>
                            <p class="text-lg"><strong>Total (ATP):</strong> <span id="total-vitorias" class="text-secondary font-extrabold">0</span> V / <span id="total-derrotas" class="text-red-400 font-extrabold">0</span> D</p>
                            <p class="text-lg"><strong>Taxa de Vitórias (ATP):</strong> <span id="taxa-vitorias" class="font-extrabold text-primary">0%</span></p>
                            
                            <h3 class="font-bold mt-6 pt-4 border-t border-border-subtle text-lg text-text-main border-b pb-2 mb-2">Por Tipo de Torneio</h3>
                            <div id="vitorias-list" class="text-sm space-y-1 mt-2"></div>
                            
                            <h3 class="font-bold mt-6 pt-4 border-t border-border-subtle text-lg text-text-main border-b pb-2 mb-2">Por Superfície (ATP)</h3>
                             <ul id="vitorias-surface-list" class="list-none pl-0 text-sm space-y-1 pt-2"></ul>
                        </div>
                        <div class="dashboard-card p-4 md:p-6 flex flex-col justify-center">
                            <h3 class="text-xl font-bold mb-4 text-text-main text-center">Desempenho por Superfície</h3>
                            <div class="w-full max-h-96 mx-auto">
                                <canvas id="vitoriasChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="h2h" class="tab-content" role="tabpanel">
                    <div class="dashboard-card p-4 md:p-6">
                        <h2 class="text-2xl font-extrabold mb-6 text-text-main">Head-to-Head (H2H)</h2>
                        <div class="flex flex-col md:flex-row gap-4 mb-6 p-4 bg-card-base/50 rounded-lg border border-border-subtle">
                            <div class="relative flex-grow">
                                <label for="h2h-search" class="block text-sm font-medium text-text-muted mb-1">Pesquisar Adversário:</label>
                                <input id="h2h-search" class="form-input w-full" placeholder="Digite o nome (Opcional se selecionar país)" autocomplete="off">
                                <div id="h2h-suggestions" class="absolute z-20 w-full bg-card-base rounded-lg shadow-xl hidden mt-1 max-h-48 overflow-y-auto border border-primary/50"></div>
                            </div>
                            <div class="md:w-1/3">
                                <label for="h2h-country-filter" class="block text-sm font-medium text-text-muted mb-1">Filtrar por País:</label>
                                <select id="h2h-country-filter" class="form-select">
                                    <option value="">Todos os Países</option>
                                </select>
                            </div>
                        </div>
                        <div id="h2h-results">
                            <p class="text-center text-text-muted py-8">Selecione um adversário ou um país para ver o histórico.</p>
                        </div>
                    </div>
                </div>

                <div id="recordes" class="tab-content" role="tabpanel">
                     <div class="dashboard-card p-4 md:p-6">
                        <h2 class="text-2xl font-extrabold mb-6 text-text-main">Recordes na Carreira</h2>
                        <div id="recordes-conquistados" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="mainModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 hidden p-4 backdrop-blur-sm">
        <div id="modalContent" class="dashboard-card max-w-2xl w-full max-h-[90vh] overflow-y-auto transition-transform duration-300 transform scale-95 opacity-0">
            <div class="flex justify-between items-center p-5 border-b border-border-subtle sticky top-0 bg-card-base z-10 rounded-t-lg">
                <h3 id="modalTitle" class="text-xl font-bold flex items-center gap-3 text-primary"></h3>
                <button id="closeModalBtn" class="text-3xl text-text-muted hover:text-red-400 transition-colors">&times;</button>
            </div>
            <div id="modalBody" class="p-6"></div>
            <div id="modalFooter" class="flex justify-end gap-3 p-5 border-t border-border-subtle sticky bottom-0 bg-card-base z-10 rounded-b-lg"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';

        // --- CONFIG & GLOBALS ---
        const firebaseConfig = {
            // VERIFIQUE E SUBSTITUA ESSAS CREDENCIAIS PELAS SUAS DO FIREBASE
            apiKey: "AIzaSyBIWmpJcoCiD3jTWROFcjSZDgXcxafsgtA", 
            authDomain: "tenis-456fc.firebaseapp.com",
            projectId: "tenis-456fc",
            storageBucket: "tenis-456fc.appspot.com",
            messagingSenderId: "21965853527",
            appId: "1:21965853527:web:38a9edbe0eb2438679e412",
            measurementId: "G-ZJ5MP3RLD9"
        };
        
        // Inicialização do App
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let allTournaments = [];
        let titulosChart, vitoriasChart;
        let allOpponentNames = [];
        let availableOpponentCountries = new Set();
        
        // LISTA DE PAÍSES POPULARES PARA O FILTRO H2H
        const majorCountries = [
            "ARG", "AUS", "AUT", "BEL", "BRA", "CAN", "CHI", "CHN", "COL", "CRO", 
            "CZE", "DEN", "ECU", "ESP", "FIN", "FRA", "GBR", "GER", "GRE", "HUN", 
            "IND", "ITA", "JPN", "KAZ", "KOR", "MEX", "NED", "NOR", "NZL", "PER", 
            "POL", "POR", "ROU", "RSA", "RUS", "SRB", "SUI", "SVK", "SWE", "TPE", 
            "TUR", "UKR", "URU", "USA"
        ];

        const modal = document.getElementById('mainModal');
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const dataNascimentoJogador = new Date('2011-02-18');
        
        const tournamentTypes = ['Grand Slam', 'ATP Finals', 'ATP Masters 1000', 'ATP 500', 'ATP 250', 'Jogos Olímpicos', 'CH 175', 'CH 125', 'CH 100', 'CH 90', 'CH 75'];
        const surfaces = ['Saibro', 'Rápida', 'Grama'];
        const roundsByTournamentType = {
            'Grand Slam': ['Primeira Rodada', 'Segunda Rodada', 'Terceira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'ATP Masters 1000': ['Primeira Rodada', 'Segunda Rodada', 'Terceira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'ATP 500': ['Primeira Rodada', 'Segunda Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'ATP 250': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'Jogos Olímpicos': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Disputa Bronze', 'Final'],
            'ATP Finals': ['Fase de Grupos 1', 'Fase de Grupos 2', 'Fase de Grupos 3', 'Semifinal', 'Final'],
            'CH 175': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 125': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 100': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 90': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 75': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'Default': ['Primeira Rodada', 'Segunda Rodada', 'Terceira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final']
        };
        const iocToIso2 = {'AFG':'AF','ALB':'AL','ALG':'DZ','ASA':'AS','AND':'AD','ANG':'AO','ANT':'AG','ARG':'AR','ARM':'AM','ARU':'AW','AUS':'AU','AUT':'AT','AZE':'AZ','BAH':'BS','BRN':'BH','BAN':'BD','BAR':'BB','BLR':'BY','BEL':'BE','BIZ':'BZ','BEN':'BJ','BER':'BM','BHU':'BT','BOL':'BO','BIH':'BA','BOT':'BW','BRA':'BR','IVB':'VG','BRU':'BN','BUL':'BG','BUR':'BF','BDI':'BI','CAM':'KH','CMR':'CM','CAN':'CA','CAY':'KY','CAF':'CF','CHA':'TD','CHI':'CL','CHN':'CN','TPE':'TW','COL':'CO','COM':'KM','CGO':'CG','COD':'CD','COK':'CK','CRC':'CR','CIV':'CI','CRO':'HR','CUB':'CU','CYP':'CY','CZE':'CZ','DEN':'DK','DJI':'DJ','DMA':'DM','DOM':'DO','ECU':'EC','EGY':'EG','ESA':'SV','GEQ':'GQ','ERI':'ER','EST':'EE','SWZ':'SZ','ETH':'ET','FIJ':'FJ','FIN':'FI','FRA':'FR','GAB':'GA','GAM':'GM','GEO':'GE','GER':'DE','GHA':'GH','GBR':'GB','GRE':'GR','GRN':'GD','GUM':'GU','GUA':'GT','GUI':'GN','GBS':'GW','GUY':'GY','HAI':'HT','HON':'HN','HKG':'HK','HUN':'HU','ISL':'IS','IND':'IN','INA':'ID','IRI':'IR','IRQ':'IQ','IRL':'IE','ISR':'IL','ITA':'IT','JAM':'JM','JOR':'JO','KAZ':'KZ','KEN':'KE','KIR':'KI','PRK':'KP','KOR':'KR','KUW':'KW','KGZ':'KG','LAO':'LA','LAT':'LV','LIB':'LB','LES':'LS','LBR':'LR','LBA':'LY','LIE':'LI','LTU':'LT','LUX':'LU','MAD':'MG','MAW':'MW','MAS':'MY','MDV':'MV','MLI':'ML','MLT':'MT','MHL':'MH','MTN':'MR','MRI':'MU','MEX':'MX','FSM':'FM','MDA':'MD','MON':'MC','MGL':'MN','MNE':'ME','MAR':'MA','MOZ':'MZ','MYA':'MM','NAM':'NA','NRU':'NR','NEP':'NP','NED':'NL','NZL':'NZ','NCA':'NI','NIG':'NE','NGR':'NG','MKD':'MK','NOR':'NO','OMA':'OM','PAK':'PK','PLW':'PW','PLE':'PS','PAN':'PA','PNG':'PG','PAR':'PY','PER':'PE','PHI':'PH','POL':'PL','POR':'PT','PUR':'PR','QAT':'QA','ROU':'RO','RUS':'RU','RWA':'RW','SKN':'KN','LCA':'LC','VIN':'VC','SAM':'WS','SMR':'SM','STP':'ST','KSA':'SA','SEN':'SN','SRB':'RS','SEY':'SC','SLE':'SL','SGP':'SG','SVK':'SK','SLO':'SI','SOL':'SB','SOM':'SO','RSA':'ZA','ESP':'ES','SRI':'LK','SUD':'SD','SUR':'SR','SWE':'SE','SUI':'CH','SYR':'SY','TAN':'TZ','THA':'TH','TLS':'TL','TOG':'TG','TGA':'TO','TTO':'TT','TUN':'TN','TUR':'TR','TKM':'TM','TUV':'TV','UGA':'UG','UKR':'UA','UAE':'AE','USA':'US','URU':'UY','UZB':'UZ','VAN':'VU','VEN':'VE','VIE':'VN','ISV':'VI','YEM':'YE','ZAM':'ZM','ZIM':'ZW'};
        
        const worldRecords = [
            // --- RANKING RECORDS ---
            { id: 'weeksAtNo1', title: 'Mais Semanas como Nº 1 do Mundo', holder: 'Novak Djokovic', value: 428, stat: (s) => 0, format: (v) => `${v} Semanas` },
            { id: 'consecutiveWeeks', title: 'Semanas Consecutivas como Nº 1', holder: 'Roger Federer', value: 237, stat: (s) => 0, format: (v) => `${v} Semanas` },
            { id: 'yearEndNo1', title: 'Mais Vezes Nº 1 ao Final do Ano', holder: 'Novak Djokovic', value: 8, stat: (s) => 0, format: (v) => `${v} Anos` },

            // --- GRAND SLAMS & AGE ---
            { id: 'grandSlams', title: 'Mais Títulos de Grand Slam', holder: 'Novak Djokovic', value: 24, stat: (s) => s.porTipo['Grand Slam']?.t || 0, format: (v) => `${v} Títulos` },
            { id: 'grandSlamFinals', title: 'Mais Finais de Grand Slam', holder: 'Novak Djokovic', value: 36, stat: (s) => s.finaisGrandSlam, format: (v) => `${v} Finais` },
            { id: 'youngestGS', title: 'Vencedor de GS Mais Jovem', holder: 'Michael Chang', value: 207, isLowerBetter: true, stat: (s) => s.idadeMenorCampeaoGS, format: (v) => v > 0 ? `${Math.floor(v/12)}a ${v%12}m` : 'N/A' },
            { id: 'oldestGS', title: 'Vencedor de GS Mais Velho', holder: 'Ken Rosewall', value: 446, stat: (s) => s.idadeMaiorCampeaoGS, format: (v) => v > 0 ? `${Math.floor(v/12)}a ${v%12}m` : 'N/A' },
            
            // --- BIG TITLES & SURFACES ---
            { id: 'bigTitles', title: 'Rei dos "Big Titles" (GS, M1000, Finals, Oly)', holder: 'Novak Djokovic', value: 71, stat: (s) => (s.porTipo['Grand Slam']?.t || 0) + (s.porTipo['ATP Masters 1000']?.t || 0) + (s.porTipo['ATP Finals']?.t || 0) + (s.porTipo['Jogos Olímpicos']?.t || 0), format: (v) => `${v} Títulos` },
            
            { id: 'hardTitles', title: 'Mais Títulos em Quadra Rápida', holder: 'Novak Djokovic', value: 71, stat: (s) => s.porSuperficie['Rápida']?.atp_t || 0, format: (v) => `${v} Títulos` },
            { id: 'clayTitles', title: 'Mais Títulos no Saibro', holder: 'Rafael Nadal', value: 63, stat: (s) => s.porSuperficie['Saibro']?.atp_t || 0, format: (v) => `${v} Títulos` },
            { id: 'grassTitles', title: 'Mais Títulos na Grama', holder: 'Roger Federer', value: 19, stat: (s) => s.porSuperficie['Grama']?.atp_t || 0, format: (v) => `${v} Títulos` },

            // --- OTHER TOURNAMENT TYPES ---
            { id: 'masters1000', title: 'Mais Títulos de Masters 1000', holder: 'Novak Djokovic', value: 40, stat: (s) => s.porTipo['ATP Masters 1000']?.t || 0, format: (v) => `${v} Títulos` },
            { id: 'atpFinals', title: 'Mais Títulos de ATP Finals', holder: 'Novak Djokovic', value: 7, stat: (s) => s.porTipo['ATP Finals']?.t || 0, format: (v) => `${v} Títulos` },
            { id: 'atp500', title: 'Mais Títulos de ATP 500', holder: 'Roger Federer', value: 24, stat: (s) => s.porTipo['ATP 500']?.t || 0, format: (v) => `${v} Títulos` },
            
            // --- CAREER TOTALS ---
            { id: 'careerTitles', title: 'Mais Títulos na Carreira (ATP)', holder: 'Jimmy Connors', value: 109, stat: (s) => s.titulosATP, format: (v) => `${v} Títulos` },
            { id: 'matchWins', title: 'Mais Vitórias na Carreira (ATP)', holder: 'Jimmy Connors', value: 1274, stat: (s) => s.vitoriasATP, format: (v) => `${v} Vitórias` },
            { id: 'prizeMoney', title: 'Maior Premiação na Carreira', holder: 'Novak Djokovic', value: 184000000, stat: (s) => s.premiacao, format: (v) => formatCurrency(v) },
            
            // --- EFFICIENCY & RATIOS ---
            { id: 'winPercentage', title: '% de Vitórias (ATP, min. 200 jogos)', holder: 'Novak Djokovic', value: 83.9, stat: (s) => (s.vitoriasATP + s.derrotasATP > 200) ? (s.vitoriasATP / (s.vitoriasATP + s.derrotasATP) * 100) : 0, format: (v) => v > 0 ? `${v.toFixed(2)}%` : 'N/A' },
            { id: 'clayWinPerc', title: '% de Vitórias no Saibro (min. 50 jogos)', holder: 'Rafael Nadal', value: 91.3, stat: (s) => (s.porSuperficie['Saibro']?.atp_v + s.porSuperficie['Saibro']?.atp_d > 50) ? (s.porSuperficie['Saibro'].atp_v / (s.porSuperficie['Saibro'].atp_v + s.porSuperficie['Saibro'].atp_d) * 100) : 0, format: (v) => v > 0 ? `${v.toFixed(2)}%` : 'N/A' },
            { id: 'hardWinPerc', title: '% de Vitórias na Rápida (min. 50 jogos)', holder: 'Novak Djokovic', value: 84.7, stat: (s) => (s.porSuperficie['Rápida']?.atp_v + s.porSuperficie['Rápida']?.atp_d > 50) ? (s.porSuperficie['Rápida'].atp_v / (s.porSuperficie['Rápida'].atp_v + s.porSuperficie['Rápida'].atp_d) * 100) : 0, format: (v) => v > 0 ? `${v.toFixed(2)}%` : 'N/A' },
            
            // --- SEASON RECORDS ---
            { id: 'seasonWins', title: 'Mais Vitórias em uma Temporada', holder: 'Guillermo Vilas (1977)', value: 130, stat: (s) => s.maxVitoriasEmUmAno, format: (v) => `${v} Vitórias` },
            { id: 'seasonWinPerc', title: 'Melhor % em uma Temporada', holder: 'John McEnroe (1984)', value: 96.5, stat: (s) => s.maxPorcentagemVitoriasEmUmAno, format: (v) => v > 0 ? `${v.toFixed(1)}%` : 'N/A' },
        ];

        // --- MODAL & UI HELPERS ---
        function openModal(title, bodyHTML, footerHTML = '') {
            modalTitle.innerHTML = title;
            modalBody.innerHTML = bodyHTML;
            modalFooter.innerHTML = footerHTML;
            modal.style.display = 'flex';
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 50);
        }
        function closeModal() { 
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        function formatCurrency(value) { return (Number(value) || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' }); }
        
        function estimarRanking(pontos) {
            if (pontos <= 0) return 'Sem Ranking';
            const rankingPointsMap = [
                { rank: 1, points: 9500 }, { rank: 10, points: 4000 }, { rank: 25, points: 1500 },
                { rank: 50, points: 1000 }, { rank: 100, points: 640 }, { rank: 150, points: 430 },
                { rank: 200, points: 310 }, { rank: 250, points: 240 }, { rank: 300, points: 190 },
                { rank: 400, points: 125 }, { rank: 500, points: 80 }, { rank: 750, points: 35 },
                { rank: 1000, points: 17 }, { rank: 1500, points: 1 }
            ];
            if (pontos >= rankingPointsMap[0].points) return `${rankingPointsMap[0].rank}º`;
            for (let i = 1; i < rankingPointsMap.length; i++) {
                const upper = rankingPointsMap[i-1];
                const lower = rankingPointsMap[i];
                if (pontos >= lower.points && pontos < upper.points) {
                    const pointsRange = upper.points - lower.points;
                    const rankRange = lower.rank - upper.rank;
                    const pointsAboveLower = pontos - lower.points;
                    const rankOffset = (pointsAboveLower / pointsRange) * rankRange;
                    return `${Math.round(lower.rank - rankOffset)}º`;
                }
            }
            return `>1500º`;
        }

        function getFlagEmoji(iocCode) {
            if (!iocCode || iocCode.length < 2) return '';
            const code = iocCode.toUpperCase();
            const iso2 = iocToIso2[code] || (code.length === 2 ? code : '');
            if (!iso2) return `(${code})`;
            return iso2.toUpperCase().split('').map(char => String.fromCodePoint(char.charCodeAt(0) + 127397)).join('');
        }
        
        function abbreviateTournamentType(type) {
            const map = {
                "Grand Slam": "GS", "ATP Finals": "Finals", "ATP Masters 1000": "M1000",
                "Jogos Olímpicos": "Olímpiadas"
            };
            return map[type] || type;
        }

        function abbreviateRound(round) {
            const map = {
                "Primeira Rodada": "R1", "Segunda Rodada": "R2", "Terceira Rodada": "R3",
                "Oitavas de Final": "R16", "Quartas de Final": "QF", "Semifinal": "SF", "Final": "F",
                "Disputa Bronze": "Bronze"
            };
            return map[round] || round;
        }

        // Helper function to get the ISO week number (1-53) for a given date
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }
        
        // --- CRUD & DB OPERATIONS ---
        async function loadTournamentsFromDb() {
            // Nome da Coleção (Ponto Crítico)
            const collectionName = 'torneios'; 
            
            try {
                // Tenta carregar os dados
                const snapshot = await getDocs(collection(db, collectionName));
                allTournaments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Se não houver documentos, exibe uma mensagem
                if (allTournaments.length === 0) {
                    document.getElementById('no-tournaments-msg').textContent = `Nenhum torneio encontrado na coleção '${collectionName}'. Comece a adicionar dados!`;
                    document.getElementById('no-tournaments-msg').style.display = 'block';
                }

                console.log("Dados carregados do Firestore:", allTournaments);
                updateUI();
                
            } catch (error) { 
                // Captura e exibe o erro exato do Firestore
                console.error("ERRO FATAL NO FIRESTORE. Detalhes:", error);
                
                let friendlyMsg = `
                    ERRO DE CONEXÃO COM O FIREBASE (Ver console F12 para detalhes). 
                    1. Confirme se a coleção se chama '${collectionName}' (case-sensitive).
                    2. Verifique Regras de Segurança e Credenciais.
                `;
                
                document.getElementById('no-tournaments-msg').textContent = friendlyMsg;
                document.getElementById('no-tournaments-msg').style.display = 'block';
            }
        }
        async function updateTournamentInDb(id, data, shouldRefreshModal = false) {
            try {
                const tournamentRef = doc(db, 'torneios', id);
                await updateDoc(tournamentRef, data);
                const index = allTournaments.findIndex(t => t.id === id);
                if (index > -1) {
                    allTournaments[index] = { ...allTournaments[index], ...data };
                }
                updateUI();
                if (shouldRefreshModal) {
                    openManageTournamentModal(id);
                }
            } catch (error) { console.error("Erro ao atualizar torneio: ", error); alert('Ocorreu um erro ao atualizar.'); }
        }
        async function deleteTournamentFromDb(id) {
            if (confirm('Tem certeza que deseja excluir este torneio e toda a sua campanha?')) {
                try {
                    await deleteDoc(doc(db, 'torneios', id));
                    allTournaments = allTournaments.filter(t => t.id !== id);
                    updateUI();
                } catch (error) { console.error("Erro ao excluir torneio: ", error); alert('Ocorreu um erro ao excluir.'); }
            }
        }
        async function handleSaveNewTournament() {
            const form = document.getElementById('create-tournament-form');
            if (!form.checkValidity()) { form.reportValidity(); return; }
            const dataInicio = document.getElementById('torneio-data-inicio').value;
            const torneioTipo = document.getElementById('torneio-tipo').value;
            
            const startingRoundName = document.getElementById('starting-round')?.value || 'Primeira Rodada';
            const allPossibleRounds = roundsByTournamentType[torneioTipo] || roundsByTournamentType['Default'];
            const startingRoundIndex = allPossibleRounds.indexOf(startingRoundName);
            
            const jogos = [];
            for(let i = 0; i < startingRoundIndex; i++) {
                jogos.push({
                    rodada: allPossibleRounds[i],
                    adversario: 'Bye',
                    nacionalidade: 'ATP',
                    placar: 'Bye',
                    resultado: 'Bye'
                });
            }

            const adversario = document.getElementById('jogo-adversario').value.trim();
            const nacionalidade = document.getElementById('jogo-nacionalidade').value.trim().toUpperCase();
            const placar = document.getElementById('jogo-placar').value.trim();
            const resultado = document.getElementById('jogo-resultado').value;
            
            jogos.push({
                rodada: startingRoundName,
                adversario,
                nacionalidade,
                placar,
                resultado,
            });
            
            let status = 'Em Andamento';
            let faseFinal = '';
            let pontos = 0;
            let premiacao = 0;

            if (resultado === 'D') { 
                status = 'Finalizado';
                faseFinal = startingRoundName;
                pontos = Number(document.getElementById('torneio-pontos').value) || 0;
                premiacao = Number(document.getElementById('torneio-premiacao').value) || 0;
            }
            
            const newTournament = {
                nome: document.getElementById('torneio-nome').value.trim(),
                tipo: torneioTipo,
                superficie: document.getElementById('torneio-superficie').value,
                paisTorneio: document.getElementById('torneio-pais').value.trim().toUpperCase(),
                dataInicio, dataFim: document.getElementById('torneio-data-fim').value,
                ano: new Date(dataInicio + 'T00:00:00').getFullYear(),
                pontos, premiacao, faseFinal, status, jogos
            };

            try {
                const docRef = await addDoc(collection(db, 'torneios'), newTournament);
                allTournaments.push({ id: docRef.id, ...newTournament });
                closeModal();
                updateUI();
            } catch (error) { console.error("Erro ao salvar novo torneio: ", error); alert('Ocorreu um erro ao salvar.'); }
        }

        // --- MODAL RENDERING ---
        function openCreateTournamentModal() {
            const body = `
                <form id="create-tournament-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="torneio-nome" class="block text-sm font-medium text-text-muted">Nome</label><input type="text" id="torneio-nome" class="form-input mt-1" required></div>
                        <div><label for="torneio-pais" class="block text-sm font-medium text-text-muted">País do Torneio (Ex: BRA)</label><input type="text" id="torneio-pais" maxlength="3" class="form-input mt-1" required></div>
                        <div><label for="torneio-tipo" class="block text-sm font-medium text-text-muted">Tipo</label><select id="torneio-tipo" class="form-select mt-1" required>${tournamentTypes.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                        <div id="starting-round-container" class="hidden">
                           <label for="starting-round" class="block text-sm font-medium text-text-muted">Rodada de Início</label>
                           <select id="starting-round" class="form-select mt-1"></select>
                        </div>
                        <div><label for="torneio-superficie" class="block text-sm font-medium text-text-muted">Superfície</label><select id="torneio-superficie" class="form-select mt-1" required>${surfaces.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
                        <div><label for="torneio-data-inicio" class="block text-sm font-medium text-text-muted">Data Início</label><input type="date" id="torneio-data-inicio" class="form-input mt-1" required></div>
                        <div><label for="torneio-data-fim" class="block text-sm font-medium text-text-muted">Data Final</label><input type="date" id="torneio-data-fim" class="form-input mt-1" required></div>
                    </div>
                    <div class="pt-4 mt-4 border-t border-border-subtle">
                        <h4 class="text-md font-semibold text-text-main"><span id="match-round-label">Primeira</span> Partida</h4>
                        <div id="match-details-container">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <div><label for="jogo-adversario" class="block text-sm font-medium text-text-muted">Adversário</label><input type="text" id="jogo-adversario" class="form-input mt-1" required></div>
                                <div><label for="jogo-nacionalidade" class="block text-sm font-medium text-text-muted">Nacionalidade (Ex: SUI)</label><input type="text" id="jogo-nacionalidade" maxlength="3" class="form-input mt-1"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <div><label for="jogo-placar" class="block text-sm font-medium text-text-muted">Placar</label><input type="text" id="jogo-placar" class="form-input mt-1" required></div>
                                <div><label for="jogo-resultado" class="block text-sm font-medium text-text-muted">Resultado</label><select id="jogo-resultado" class="form-select mt-1"><option value="V" selected>Vitória</option><option value="D">Derrota</option></select></div>
                            </div>
                        </div>
                    </div>
                    <div id="final-details-create" class="hidden space-y-4 pt-4 mt-4 border-t border-border-subtle">
                         <h4 class="text-md font-semibold text-red-500">Finalizar Campanha (Derrota na Estreia)</h4>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="torneio-pontos" class="block text-sm font-medium text-text-muted">Pontos</label><input type="number" id="torneio-pontos" class="form-input mt-1" min="0" value="0"></div>
                            <div><label for="torneio-premiacao" class="block text-sm font-medium text-text-muted">Prêmio ($)</label><input type="number" id="torneio-premiacao" class="form-input mt-1" min="0" value="0"></div>
                        </div>
                    </div>
                </form>
            `;
            const footer = `<button id="save-tournament-btn" class="btn btn-secondary">Salvar e Continuar</button>`;
            openModal('Criar Novo Torneio', body, footer);
            
            const resultSelect = document.getElementById('jogo-resultado');
            const finalDetails = document.getElementById('final-details-create');
            const saveBtn = document.getElementById('save-tournament-btn');
            const tournamentTypeSelect = document.getElementById('torneio-tipo');
            const startingRoundContainer = document.getElementById('starting-round-container');
            const startingRoundSelect = document.getElementById('starting-round');
            const matchRoundLabel = document.getElementById('match-round-label');

            const updateStartingRounds = (type) => {
                const hasByes = type === 'ATP Masters 1000' || type === 'ATP 500';
                startingRoundContainer.classList.toggle('hidden', !hasByes);
                if(hasByes) {
                    startingRoundSelect.innerHTML = '';
                    const rounds = roundsByTournamentType[type];
                    const maxRoundIndex = type === 'ATP Masters 1000' ? 2 : 1; 
                    for (let i = 0; i <= maxRoundIndex; i++) {
                         startingRoundSelect.innerHTML += `<option value="${rounds[i]}">${rounds[i]}</option>`;
                    }
                    matchRoundLabel.textContent = startingRoundSelect.value;
                } else {
                    matchRoundLabel.textContent = 'Primeira Rodada'; 
                }
            };
            
            const toggleFinalDetails = () => {
                const isLoss = resultSelect.value === 'D';
                finalDetails.classList.toggle('hidden', !isLoss);
                saveBtn.textContent = isLoss ? 'Salvar e Finalizar' : 'Salvar e Continuar';
                saveBtn.classList.toggle('btn-danger', isLoss);
                saveBtn.classList.toggle('btn-secondary', !isLoss);
            };

            tournamentTypeSelect.addEventListener('change', (e) => updateStartingRounds(e.target.value));
            startingRoundSelect.addEventListener('change', (e) => {
                matchRoundLabel.textContent = e.target.value;
                toggleFinalDetails(); 
            });
            resultSelect.addEventListener('change', toggleFinalDetails);
            saveBtn.addEventListener('click', handleSaveNewTournament);

            updateStartingRounds(tournamentTypeSelect.value); 
        }
        function openManageTournamentModal(torneioId) {
            const torneio = allTournaments.find(t => t.id === torneioId);
            if (!torneio) return;
            const matchesHistory = (torneio.jogos || []).map(jogo => `
                <div class="p-3 rounded-lg flex justify-between items-center ${jogo.resultado === 'V' ? 'bg-secondary/20' : (jogo.resultado === 'D' ? 'bg-red-500/20' : 'bg-card-base/50')}">
                    <div class="flex-grow min-w-0 mr-2">
                        <p class="font-bold truncate">${jogo.rodada}</p>
                        <p class="text-sm text-text-muted truncate">${getFlagEmoji('BRA')} Fernando Lapa vs ${jogo.adversario} ${getFlagEmoji(jogo.nacionalidade)}</p>
                    </div>
                    <div class="flex-shrink-0 flex items-center text-right">
                        <span class="font-semibold text-sm whitespace-nowrap mr-4">${jogo.placar}</span>
                        <span class="text-lg font-bold w-4 ${jogo.resultado === 'V' ? 'text-secondary' : (jogo.resultado === 'D' ? 'text-red-500' : 'text-text-muted')}">${jogo.resultado === 'Bye' ? '' : jogo.resultado}</span>
                    </div>
                </div>`).join('');
            let body = `<div id="matches-history-list" class="space-y-3">${matchesHistory}</div>`;
            const titlePrefix = torneio.status === 'Finalizado' ? '' : 'Gerenciar: ';
            const modalTitleHTML = `
                <span>${getFlagEmoji(torneio.paisTorneio)}</span>
                <span class="truncate">${titlePrefix}${torneio.nome}</span>
                <span class="text-sm font-medium text-text-muted bg-background-deep px-3 py-1 rounded-full">${torneio.tipo}</span>
            `;

            if (torneio.status === 'Finalizado') {
                body += `<div class="mt-6 pt-4 border-t border-border-subtle text-center space-y-2"><p class="text-lg font-bold text-text-main">Campanha Finalizada</p><p class="text-text-muted"><strong>Resultado:</strong> ${torneio.faseFinal}</p><p class="text-text-muted"><strong>Pontos:</strong> ${torneio.pontos}</p><p class="text-text-muted"><strong>Prêmio:</strong> ${formatCurrency(torneio.premiacao)}</p></div>`;
            } else {
                const lastPlayedRound = torneio.jogos[torneio.jogos.length - 1].rodada;
                const allPossibleRounds = roundsByTournamentType[torneio.tipo] || roundsByTournamentType['Default'];
                const lastPlayedIndex = allPossibleRounds.indexOf(lastPlayedRound);
                const remainingRounds = allPossibleRounds.slice(lastPlayedIndex + 1);

                if (remainingRounds.length === 0) {
                     body += `<div class="mt-6 pt-4 border-t border-border-subtle text-center text-text-muted">Campanha em andamento. Não há mais rodadas para adicionar.</div>`;
                } else {
                    body += `
                        <form id="update-tournament-form" class="space-y-4 pt-6 mt-6 border-t border-border-subtle">
                            <h4 class="text-md font-semibold text-text-main">Próximo Jogo</h4>
                             <p class="text-xs text-text-muted mb-2">Para um "bye", digite "Bye" no campo de adversário.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <div><label for="next-round" class="block text-sm font-medium text-text-muted">Fase</label><select id="next-round" class="form-select mt-1">${remainingRounds.map(r => `<option value="${r}">${r}</option>`).join('')}</select></div>
                                <div><label for="next-adversario" class="block text-sm font-medium text-text-muted">Adversário</label><input type="text" id="next-adversario" class="form-input mt-1" required></div>
                                <div><label for="next-nacionalidade" class="block text-sm font-medium text-text-muted">Nacionalidade</label><input type="text" maxlength="3" id="next-nacionalidade" class="form-input mt-1" placeholder="Ex: SUI"></div>
                                <div><label for="next-placar" class="block text-sm font-medium text-text-muted">Placar</label><input type="text" id="next-placar" class="form-input mt-1" required></div>
                            </div>
                            <div id="final-details-update" class="hidden space-y-4 pt-4 mt-4 border-t border-border-subtle">
                                 <h4 id="final-title-update" class="text-md font-semibold text-text-main"></h4>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="update-pontos" class="block text-sm font-medium text-text-muted">Pontos</label><input type="number" id="update-pontos" class="form-input mt-1" min="0" value="0"></div>
                                    <div><label for="update-premiacao" class="block text-sm font-medium text-text-muted">Prêmio ($)</label><input type="number" id="update-premiacao" class="form-input mt-1" min="0" value="0"></div>
                                </div>
                            </div>
                        </form>`;
                }
            }
            const footer = torneio.status !== 'Finalizado' ? `<button id="win-match-btn" class="btn btn-secondary">Salvar Vitória</button><button id="lose-match-btn" class="btn btn-danger">Finalizar com Derrota</button>` : '';
            openModal(modalTitleHTML, body, footer);
            
            const adversarioInput = document.getElementById('next-adversario');
            const placarInput = document.getElementById('next-placar');
            const nacionalidadeInput = document.getElementById('next-nacionalidade');

            if(adversarioInput) {
                 adversarioInput.addEventListener('input', () => {
                    const isBye = adversarioInput.value.toLowerCase() === 'bye';
                    if (isBye) {
                        placarInput.value = 'Bye';
                        nacionalidadeInput.value = 'ATP';
                    }
                    placarInput.disabled = isBye;
                    nacionalidadeInput.disabled = isBye;
                 });
            }

            const handleUpdate = (result) => {
                 const form = document.getElementById('update-tournament-form');
                 const nextRoundName = form.querySelector('#next-round').value;
                 if (!nextRoundName) { alert('Não há mais fases neste torneio para selecionar.'); return; }
                 
                 const adversario = form.querySelector('#next-adversario').value.trim();
                 const placar = form.querySelector('#next-placar').value.trim();
                 const nacionalidade = form.querySelector('#next-nacionalidade').value.trim().toUpperCase();

                 const isBye = adversario.toLowerCase() === 'bye';
                 const finalResult = isBye ? 'Bye' : result; // If it's a bye, result is 'Bye'
                 const finalPlacar = isBye ? 'Bye' : placar;

                 if (!adversario || (!isBye && !placar)) { alert('Preencha adversário e placar.'); return; }
                 
                 const isFinal = nextRoundName === 'Final';
                 const newMatch = { rodada: nextRoundName, adversario: isBye ? 'Bye' : adversario, nacionalidade: isBye ? 'ATP' : nacionalidade, placar: finalPlacar, resultado: finalResult };
                 const updatedJogos = [...(torneio.jogos || []), newMatch];
                 let updatedData = { jogos: updatedJogos };
                 if (finalResult === 'D' || (finalResult === 'V' && isFinal)) { // Tournament finishes on a loss or winning the final
                     updatedData = { ...updatedData, status: 'Finalizado', faseFinal: finalResult === 'V' ? 'Campeão' : nextRoundName, pontos: Number(form.querySelector('#update-pontos').value) || 0, premiacao: Number(form.querySelector('#update-premiacao').value) || 0 };
                 }
                 updateTournamentInDb(torneioId, updatedData).then(closeModal);
            };
            const setupFinalizationUI = (isWin) => {
                const nextRound = document.getElementById('next-round').value;
                const finalDetails = document.getElementById('final-details-update'), title = document.getElementById('final-title-update');
                if (finalDetails.classList.contains('hidden')) {
                    finalDetails.classList.remove('hidden');
                    title.textContent = isWin ? 'Finalizar (Campeão!)' : `Finalizar com Derrota na fase: ${nextRound}`;
                    title.className = isWin ? 'text-md font-semibold text-accent' : 'text-md font-semibold text-red-500';
                    return false;
                } return true;
            };
            const winBtn = document.getElementById('win-match-btn'), loseBtn = document.getElementById('lose-match-btn');
            if(winBtn && loseBtn) {
                winBtn.addEventListener('click', () => {
                    const nextRound = document.getElementById('next-round').value;
                    const adversario = document.getElementById('next-adversario').value.trim();
                    const isBye = adversario.toLowerCase() === 'bye';
                    
                    if (isBye || nextRound === 'Final') { 
                        if (setupFinalizationUI(true)) handleUpdate('V'); 
                    } else { 
                        handleUpdate('V'); 
                    }
                });
                loseBtn.addEventListener('click', () => { 
                    if (setupFinalizationUI(false)) handleUpdate('D'); 
                });
            }
        }
        function handleDetailsClick(e) {
            const button = e.target.closest('.details-btn'); if (!button) return;
            const { filterType, filterValue, view } = button.dataset;
            let originalTournaments;
            if (filterType === 'category') {
                if (filterValue === 'CH') {
                    originalTournaments = allTournaments.filter(t => t.tipo.startsWith('CH'));
                } else {
                    originalTournaments = allTournaments.filter(t => t.tipo === filterValue);
                }
            } 
            else if (filterType === 'surface') { originalTournaments = allTournaments.filter(t => t.superficie === filterValue); }
            if (view === 'titles') { originalTournaments = originalTournaments.filter(t => t.faseFinal === 'Campeão'); }
            const seasons = [...new Set(originalTournaments.map(t => t.ano))].sort((a,b) => b-a);
            const tournamentNames = [...new Set(originalTournaments.map(t => t.nome))].sort();
            
            let displayValue = filterValue === 'CH' ? 'Challengers' : filterValue;
            const modalTitleText = view === 'titles' ? `Títulos - ${displayValue}` : `Campanhas - ${displayValue}`;
            
            const body = `
                <div class="flex flex-wrap gap-4 mb-4 p-4 bg-background-deep rounded-lg border border-border-subtle">
                    <div class="flex-1 min-w-[150px]"><label class="text-xs font-semibold text-text-muted">Torneio:</label><select id="modal-tournament-filter" class="form-select text-sm bg-card-base"><option value="all">Todos</option>${tournamentNames.map(n => `<option value="${n}">${n}</option>`).join('')}</select></div>
                    <div class="flex-1 min-w-[150px]"><label class="text-xs font-semibold text-text-muted">Temporada:</label><select id="modal-season-filter" class="form-select text-sm bg-card-base"><option value="all">Carreira</option>${seasons.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
                </div>
                <div id="modal-results-content" class="space-y-2"></div>`;
            openModal(modalTitleText, body);
            const renderModalContent = () => {
                const seasonFilter = document.getElementById('modal-season-filter').value;
                const tournamentFilter = document.getElementById('modal-tournament-filter').value;
                let filtered = [...originalTournaments].sort((a, b) => new Date(b.dataInicio) - new Date(a.dataInicio));

                if (seasonFilter !== 'all') filtered = filtered.filter(t => t.ano == seasonFilter);
                if (tournamentFilter !== 'all') filtered = filtered.filter(t => t.nome === tournamentFilter);
                
                let contentHTML = '';
                if (filtered.length === 0) { contentHTML = '<p class="text-center p-4 text-text-muted">Nenhum resultado para exibir.</p>'; } 
                else if (tournamentFilter !== 'all' && seasonFilter === 'all') {
                    let aggWins = 0, aggLosses = 0, aggTitles = 0;
                    filtered.forEach(t => {
                        aggWins += (t.jogos || []).filter(j => j.resultado === 'V').length;
                        aggLosses += (t.jogos || []).filter(j => j.resultado === 'D').length;
                        if (t.faseFinal === 'Campeão') aggTitles++;
                    });
                    contentHTML += `<div class="p-3 bg-card-base/50 rounded-lg mb-4 text-center border border-border-subtle"><h4 class="font-bold text-text-main">Resumo em ${tournamentFilter}</h4><p class="text-text-muted">${aggTitles} Título(s) | <span class="text-secondary">${aggWins}V</span> / <span class="text-red-400">${aggLosses}D</span></p></div>`;
                }
                
                contentHTML += filtered.map(t => `
                        <div class="tournament-accordion border-b border-border-subtle last:border-b-0">
                            <div class="tournament-header p-3 cursor-pointer hover:bg-card-base/50 rounded-md transition-colors">
                                <p class="font-bold flex justify-between items-center text-text-main">
                                    <span class="flex items-center gap-2">${getFlagEmoji(t.paisTorneio)} ${t.ano} - ${t.nome}</span>
                                    <span class="text-xs font-medium text-text-muted bg-background-deep px-2 py-1 rounded-full">${t.tipo}</span>
                                </p>
                                <p class="text-sm text-text-muted mt-1">Resultado: <span class="font-semibold">${t.faseFinal}</span> | Campanha: <span class="text-secondary font-semibold">${(t.jogos || []).filter(j => j.resultado === 'V').length}V</span>-<span class="text-red-500 font-semibold">${(t.jogos || []).filter(j => j.resultado === 'D').length}D</span></p>
                            </div>
                            <div class="tournament-body pl-4 pb-2 space-y-1">
                                ${(t.jogos || []).map(jogo => `
                                    <div class="p-2 pl-4 rounded-lg flex justify-between items-center text-xs ${jogo.resultado === 'V' ? 'bg-secondary/20' : (jogo.resultado === 'D' ? 'bg-red-500/20' : 'bg-card-base/50')}">
                                        <div class="flex-grow min-w-0 mr-2">
                                            <p class="font-semibold truncate">${jogo.rodada}</p>
                                            <p class="text-text-muted truncate">${getFlagEmoji('BRA')} F. Lapa vs ${jogo.adversario} ${getFlagEmoji(jogo.nacionalidade)}</p>
                                        </div>
                                        <div class="flex-shrink-0 flex items-center text-right">
                                            <span class="font-semibold whitespace-nowrap mr-3">${jogo.placar}</span>
                                            <span class="font-bold w-4 ${jogo.resultado === 'V' ? 'text-secondary' : (jogo.resultado === 'D' ? 'text-red-500' : 'text-text-muted')}">${jogo.resultado === 'Bye' ? '' : jogo.resultado}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
                document.getElementById('modal-results-content').innerHTML = contentHTML;
            };

            document.getElementById('modal-season-filter').addEventListener('change', renderModalContent);
            document.getElementById('modal-tournament-filter').addEventListener('change', renderModalContent);
            document.getElementById('modal-results-content').addEventListener('click', (e) => {
                const header = e.target.closest('.tournament-header');
                if (header) {
                    header.nextElementSibling.classList.toggle('open');
                }
            });
            renderModalContent();
        }
        
        // --- STATS CALCULATION & UI UPDATES ---
        function updateUI() {
            const stats = calculateAllStats();
            updateSeasonFilter(); 
            renderMainTable(); 
            updateStatsForSeason();
            updateStatsPanels(stats); 
            updateCharts(stats); 
            updateTabs(stats);
            updateOpponentList();
            updateRecordsTab(stats);
        }
        function calculateAllStats() {
            const stats = { 
                rankingPoints: 0, premiacao: 0, titulos: 0, vitoriasATP: 0, derrotasATP: 0, 
                porTipo: {}, porSuperficie: {}, titulosATP: 0, titulosChallenger: 0,
                maxTitulosUnicoTorneio: 0, nomeMaxTitulosUnicoTorneio: '-', maxTitulosEmUmAno: 0, 
                maxPremiacaoEmUmAno: 0, maxVitoriasEmUmAno: 0, maxPorcentagemVitoriasEmUmAno: 0,
                goldenSlamEvents: new Set(), grandSlamEvents: new Set(), 
                finaisATP: 0, finaisGrandSlam: 0,
                idadeMenorCampeaoGS: 0, idadeMaiorCampeaoGS: 0,
                idadeMenorCampeaoMasters: 0,
                pointsToDefendCurrentWeek: 0, 
                projectedRankingPoints: 0 
            };

            tournamentTypes.forEach(t => { stats.porTipo[t] = { v: 0, d: 0, t: 0 }; });
            surfaces.forEach(s => { stats.porSuperficie[s] = { v: 0, d: 0, t: 0, atp_v: 0, atp_d: 0, atp_t: 0 }; });
            const titulosPorNome = {};
            const titulosPorAno = {};
            const premiacaoPorAno = {};
            const vitoriasPorAno = {};
            const derrotasPorAno = {};

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentWeekNumber = getWeekNumber(today);

            const pointsByTournamentId = {}; 

            allTournaments.forEach(t => {
                const tournamentPoints = Number(t.pontos) || 0;
                const tournamentStartDate = new Date(t.dataInicio + 'T00:00:00');
                const tournamentYear = tournamentStartDate.getFullYear();
                const tournamentWeek = getWeekNumber(tournamentStartDate);

                pointsByTournamentId[t.id] = tournamentPoints;

                if (tournamentYear === currentYear - 1 && tournamentWeek === currentWeekNumber) {
                    stats.pointsToDefendCurrentWeek += tournamentPoints;
                }

                stats.premiacao += Number(t.premiacao) || 0;
                premiacaoPorAno[t.ano] = (premiacaoPorAno[t.ano] || 0) + (Number(t.premiacao) || 0);

                const vitorias = (t.jogos || []).filter(j => j.resultado === 'V').length;
                const derrotas = (t.jogos || []).filter(j => j.resultado === 'D').length;
                const isATP = t.tipo && !t.tipo.startsWith('CH');
                
                if (isATP) {
                    stats.vitoriasATP += vitorias;
                    stats.derrotasATP += derrotas;
                    vitoriasPorAno[t.ano] = (vitoriasPorAno[t.ano] || 0) + vitorias;
                    derrotasPorAno[t.ano] = (derrotasPorAno[t.ano] || 0) + derrotas;
                    
                    if (t.faseFinal?.includes('Final') || t.faseFinal === 'Campeão') {
                        stats.finaisATP++;
                        if (t.tipo === 'Grand Slam') stats.finaisGrandSlam++;
                    }
                }
                
                if (t.faseFinal === 'Campeão') {
                    stats.titulos++;
                    titulosPorAno[t.ano] = (titulosPorAno[t.ano] || 0) + 1;
                    const nomeNormalizado = t.nome.toLowerCase();
                    titulosPorNome[nomeNormalizado] = (titulosPorNome[nomeNormalizado] || 0) + 1;
                    
                    if (isATP) stats.titulosATP++;
                    else stats.titulosChallenger++;

                    const gsMap = { 'australian open': 'ao', 'roland garros': 'rg', 'wimbledon': 'w', 'us open': 'uo'};
                    const oly = 'jogos olímpicos';
                    if(gsMap[nomeNormalizado]) {
                        stats.grandSlamEvents.add(gsMap[nomeNormalizado]);
                        stats.goldenSlamEvents.add(gsMap[nomeNormalizado]);
                    }
                    if(nomeNormalizado === oly) stats.goldenSlamEvents.add('oly');
                    
                    if (t.dataFim) {
                        const idadeEmMeses = Math.floor((new Date(t.dataFim) - dataNascimentoJogador) / (1000 * 60 * 60 * 24 * 30.44));
                        if (t.tipo === 'Grand Slam') {
                            if (!stats.idadeMenorCampeaoGS || idadeEmMeses < stats.idadeMenorCampeaoGS) stats.idadeMenorCampeaoGS = idadeEmMeses;
                            if (!stats.idadeMaiorCampeaoGS || idadeEmMeses > stats.idadeMaiorCampeaoGS) stats.idadeMaiorCampeaoGS = idadeEmMeses;
                        }
                        if (t.tipo === 'ATP Masters 1000') {
                             if (!stats.idadeMenorCampeaoMasters || idadeEmMeses < stats.idadeMenorCampeaoMasters) stats.idadeMenorCampeaoMasters = idadeEmMeses;
                        }
                    }
                }

                if (stats.porTipo[t.tipo]) { stats.porTipo[t.tipo].v += vitorias; stats.porTipo[t.tipo].d += derrotas; if (t.faseFinal === 'Campeão') stats.porTipo[t.tipo].t++; }
                if (stats.porSuperficie[t.superficie]) {
                    stats.porSuperficie[t.superficie].v += vitorias; stats.porSuperficie[t.superficie].d += derrotas;
                    if (isATP) { stats.porSuperficie[t.superficie].atp_v += vitorias; stats.porSuperficie[t.superficie].atp_d += derrotas; if(t.faseFinal === 'Campeão') stats.porSuperficie[t.superficie].atp_t++; }
                }
            });

            // Calculate max values for seasons
            if (Object.keys(titulosPorNome).length > 0) {
                stats.maxTitulosUnicoTorneio = Math.max(...Object.values(titulosPorNome));
                stats.nomeMaxTitulosUnicoTorneio = Object.keys(titulosPorNome).find(key => titulosPorNome[key] === stats.maxTitulosUnicoTorneio);
            }
            if (Object.keys(titulosPorAno).length > 0) stats.maxTitulosEmUmAno = Math.max(...Object.values(titulosPorAno));
            if (Object.keys(premiacaoPorAno).length > 0) stats.maxPremiacaoEmUmAno = Math.max(...Object.values(premiacaoPorAno));
            if (Object.keys(vitoriasPorAno).length > 0) stats.maxVitoriasEmUmAno = Math.max(...Object.values(vitoriasPorAno));
            
            // Calc best winning percentage in a season (min 10 matches)
            let bestPerc = 0;
            Object.keys(vitoriasPorAno).forEach(ano => {
                const v = vitoriasPorAno[ano] || 0;
                const d = derrotasPorAno[ano] || 0;
                if (v + d > 10) {
                    const perc = (v / (v + d)) * 100;
                    if (perc > bestPerc) bestPerc = perc;
                }
            });
            stats.maxPorcentagemVitoriasEmUmAno = bestPerc;

            // Calculate current ranking points (best 19/20 results over 52 weeks)
            const sortedPoints = Object.values(pointsByTournamentId).sort((a, b) => b - a);
            stats.rankingPoints = sortedPoints.slice(0, 19).reduce((sum, points) => sum + points, 0); 

            // Calculate projected ranking points
            stats.projectedRankingPoints = stats.rankingPoints - stats.pointsToDefendCurrentWeek;
            if (stats.projectedRankingPoints < 0) stats.projectedRankingPoints = 0; // Points can't be negative

            return stats;
        }
        function updateStatsPanels(stats) {
            document.getElementById('ranking').textContent = `${estimarRanking(stats.rankingPoints)} (${stats.rankingPoints} pts)`;
            document.getElementById('premiacao').textContent = formatCurrency(stats.premiacao);
            document.getElementById('titulos-total').textContent = stats.titulosATP;
            document.getElementById('vitorias-derrotas').textContent = `${stats.vitoriasATP} / ${stats.derrotasATP}`;

            document.getElementById('current-ranking-points').textContent = `${stats.rankingPoints} pts`;
            document.getElementById('points-to-defend').textContent = `${stats.pointsToDefendCurrentWeek} pts`;
            document.getElementById('projected-ranking').textContent = `${estimarRanking(stats.projectedRankingPoints)} (${stats.projectedRankingPoints} pts)`;
        }
        function updateTabs(stats) {
             const atpTypes = tournamentTypes.filter(t => !t.startsWith('CH'));
             const chTypes = tournamentTypes.filter(t => t.startsWith('CH'));

             let titulosListHTML = atpTypes.map(type => `<p class="flex justify-between items-center data-row hover:bg-card-base/50"><strong>${type}:</strong> <span>${stats.porTipo[type]?.t || 0} <button class="details-btn text-primary hover:text-accent" data-filter-type="category" data-filter-value="${type}" data-view="titles" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></p>`).join('');
             
             const totalChTitles = chTypes.reduce((sum, type) => sum + (stats.porTipo[type]?.t || 0), 0);
             titulosListHTML += `<div><p class="flex justify-between items-center data-row hover:bg-card-base/50"><strong>Challengers:</strong> <span>${totalChTitles} <button class="details-btn text-primary hover:text-accent" data-filter-type="category" data-filter-value="CH" data-view="titles" title="Ver detalhes de todos os Challengers"><i class="fa-solid fa-eye"></i></button><button class="toggle-sublist-btn text-primary hover:text-accent" data-target="ch-titles-sublist"><i class="fa-solid fa-plus"></i></button></span></p><div id="ch-titles-sublist" class="sublist pl-4 space-y-1 mt-1">${chTypes.map(type => `<p class="flex justify-between items-center text-xs text-text-muted hover:bg-card-base/30 p-1 rounded"><em>${type}:</em> <span>${stats.porTipo[type]?.t || 0}</span></p>`).join('')}</div></div>`;

             document.getElementById('titulos-list').innerHTML = titulosListHTML;
             
             let vitoriasListHTML = atpTypes.map(type => `<div class="flex justify-between items-center data-row hover:bg-card-base/50">${type}: <span><span class="text-secondary">${stats.porTipo[type]?.v || 0}</span> / <span class="text-red-400">${stats.porTipo[type]?.d || 0}</span> <button class="details-btn text-primary hover:text-accent" data-filter-type="category" data-filter-value="${type}" data-view="wins" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></div>`).join('');
             const totalChWins = chTypes.reduce((sum, type) => sum + (stats.porTipo[type]?.v || 0), 0);
             const totalChLosses = chTypes.reduce((sum, type) => sum + (stats.porTipo[type]?.d || 0), 0);
             vitoriasListHTML += `<div><div class="flex justify-between items-center data-row hover:bg-card-base/50">Challengers: <span><span class="text-secondary">${totalChWins}</span> / <span class="text-red-400">${totalChLosses}</span> <button class="details-btn text-primary hover:text-accent" data-filter-type="category" data-filter-value="CH" data-view="wins" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button><button class="toggle-sublist-btn text-primary hover:text-accent" data-target="ch-wins-sublist"><i class="fa-solid fa-plus"></i></button></span></div><div id="ch-wins-sublist" class="sublist pl-4 space-y-1 mt-1">${chTypes.map(type => `<div class="flex justify-between items-center text-xs text-text-muted hover:bg-card-base/30 p-1 rounded"><em>${type}:</em> <span><span class="text-secondary">${stats.porTipo[type]?.v || 0}</span> / <span class="text-red-400">${stats.porTipo[type]?.d || 0}</span></span></div>`).join('')}</div></div>`;
             document.getElementById('vitorias-list').innerHTML = vitoriasListHTML;
             
             const titulosATP = Object.entries(stats.porTipo).filter(([key]) => key && !key.startsWith("CH")).reduce((sum, [, val]) => sum + val.t, 0);
             document.getElementById('titulos-total-resumo').textContent = titulosATP;
             document.getElementById('titulos-surface-list').innerHTML = surfaces.map(s => `<li class="flex justify-between items-center py-1 data-row hover:bg-card-base/50"><span>${s}:</span> <span>${stats.porSuperficie[s]?.atp_t || 0} <button class="details-btn text-primary hover:text-accent" data-filter-type="surface" data-filter-value="${s}" data-view="titles" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></li>`).join('');
             document.getElementById('total-vitorias').textContent = stats.vitoriasATP;
             document.getElementById('total-derrotas').textContent = stats.derrotasATP;
             document.getElementById('taxa-vitorias').textContent = (stats.vitoriasATP + stats.derrotasATP > 0) ? `${((stats.vitoriasATP / (stats.vitoriasATP + stats.derrotasATP)) * 100).toFixed(1)}%` : '0%';
             document.getElementById('vitorias-surface-list').innerHTML = surfaces.map(s => `<li class="flex justify-between items-center py-1 data-row hover:bg-card-base/50"><span>${s}:</span> <span><span class="text-secondary">${stats.porSuperficie[s]?.atp_v || 0}</span> / <span class="text-red-400">${stats.porSuperficie[s]?.atp_d || 0}</span> <button class="details-btn text-primary hover:text-accent" data-filter-type="surface" data-filter-value="${s}" data-view="wins" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></li>`).join('');
        }
        function updateCharts(stats) {
             // Paleta de cores mais contrastante e fácil de identificar para o Donut
             // Cores selecionadas para máxima distinção em fundo escuro
             const chartColors = [
                '#38BDF8', // Sky Blue (ATP 250)
                '#FCD34D', // Amber (ATP 500)
                '#A78BFA', // Violet (Masters 1000)
                '#F472B6', // Pink (GS)
                '#10B981', // Emerald (Finals)
                '#EF4444', // Red (Olympics)
                '#06B6D4', // Cyan (CH 175)
                '#F97316', // Orange (CH 125)
                '#3B82F6', // Blue (CH 100)
                '#DC2626', // Deep Red (CH 90)
                '#D1D5DB'  // Light Gray (CH 75)
             ];

             if (titulosChart) { 
                 titulosChart.data.labels = tournamentTypes;
                 titulosChart.data.datasets[0].data = tournamentTypes.map(t => stats.porTipo[t]?.t || 0); 
                 titulosChart.data.datasets[0].backgroundColor = chartColors.slice(0, tournamentTypes.length);
                 
                 // Configuração de legenda e tooltip
                 titulosChart.options.plugins.legend.labels.font.size = 14; 
                 titulosChart.options.plugins.legend.labels.color = 'var(--text-main)';
                 
                 titulosChart.update(); 
             }
             if (vitoriasChart) {
                vitoriasChart.data.datasets[0].data = surfaces.map(s => stats.porSuperficie[s]?.atp_v || 0);
                vitoriasChart.data.datasets[1].data = surfaces.map(s => stats.porSuperficie[s]?.atp_d || 0);
                
                vitoriasChart.update();
             }
        }
        function updateRecordsTab(stats) {
            const container = document.getElementById('recordes-conquistados');
            let html = worldRecords.map(record => {
                const playerValue = record.stat(stats);
                const isLowerBetter = record.isLowerBetter;
                const isBroken = isLowerBetter ? (playerValue > 0 && playerValue < record.value) : (playerValue >= record.value);
                
                let progress;
                if (record.id === 'weeksAtNo1' || record.id === 'consecutiveWeeks' || record.id === 'yearEndNo1') {
                    progress = 0; 
                } else if (isLowerBetter) {
                    progress = record.value > 0 ? Math.min((record.value / playerValue) * 100, 100) : 0;
                    if (playerValue === 0) progress = 0;
                    if (playerValue > record.value) progress = 100;
                } else {
                    progress = record.value > 0 ? Math.min((playerValue / record.value) * 100, 100) : 0;
                }
                
                const progressColor = isBroken ? 'bg-secondary' : 'bg-primary';

                return `
                <div class="dashboard-card p-4 rounded-lg border ${isBroken ? 'border-secondary/50 bg-secondary/10' : 'border-border-subtle'} transition-colors">
                    <h4 class="font-bold text-lg ${isBroken ? 'text-secondary' : 'text-text-main'}">${record.title} ${isBroken ? '🏆' : ''}</h4>
                    <p class="text-xs text-text-muted mt-1">Recorde: ${record.holder} (<span class="record-holder-value">${record.format(record.value, {})}</span>)</p>
                    <p class="text-sm font-semibold mt-3">Progresso: <span class="${isBroken ? 'text-secondary' : 'text-primary'}">${record.format(playerValue, stats)}</span></p>
                    <div class="w-full bg-background-deep rounded-full h-2 mt-3">
                        <div class="${progressColor} h-2 rounded-full transition-all duration-700" style="width: ${progress}%"></div>
                    </div>
                </div>`;
            }).join('');
            container.innerHTML = html || '<p class="text-text-muted md:col-span-2">Nenhum recorde para exibir.</p>';
        }
        function renderMainTable() {
            const tableBody = document.getElementById('temporadas-tabela');
            const noDataMsg = document.getElementById('no-tournaments-msg');
            const season = document.getElementById('season-filter').value;
            const filtered = (season === 'all') ? allTournaments : allTournaments.filter(t => t.ano == season);
            filtered.sort((a, b) => new Date(b.dataInicio) - new Date(a.dataInicio));
            if (filtered.length === 0) { tableBody.innerHTML = ''; noDataMsg.style.display = 'block'; return; }
            noDataMsg.style.display = 'none';
            tableBody.innerHTML = filtered.map(t => `
                <tr class="group border-b border-border-subtle hover:bg-card-base/50 transition-colors duration-200" data-id="${t.id}">
                    <td class="py-3 px-4 whitespace-nowrap text-xs text-text-muted">${t.dataInicio ? t.dataInicio.split('-').reverse().join('/') : 'N/A'}</td>
                    <td class="py-3 px-4 font-semibold text-text-main">
                        <span class="flex items-center gap-2 whitespace-nowrap">
                            ${getFlagEmoji(t.paisTorneio)} 
                            <span>${t.nome || ''}</span>
                            <span class="text-xs text-text-muted">(${abbreviateTournamentType(t.tipo) || ''})</span>
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center text-text-muted capitalize whitespace-nowrap">${t.superficie || 'N/A'}</td>
                    <td class="py-3 px-4 text-center whitespace-nowrap">
                        <span class="px-3 py-1 text-xs font-bold rounded-full whitespace-nowrap ${t.status === 'Finalizado' ? 'bg-background-deep text-text-muted' : 'bg-yellow-500 text-background-deep'}">${t.status}</span>
                    </td>
                    <td class="py-3 px-4 text-center text-sm font-medium whitespace-nowrap">
                        <span class="text-secondary">${(t.jogos || []).filter(j => j.resultado === 'V').length}</span>
                        /
                        <span class="text-red-400">${(t.jogos || []).filter(j => j.resultado === 'D').length}</span>
                    </td>
                    <td class="py-3 px-4 text-left text-sm font-medium text-text-main whitespace-nowrap">${t.faseFinal || '-'}</td>
                    <td class="py-3 px-4 text-center whitespace-nowrap">
                        <button class="delete-btn text-text-muted hover:text-red-400 transition-colors duration-200" data-id="${t.id}" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`).join('');
            tableBody.querySelectorAll('tr').forEach(row => row.addEventListener('click', (e) => { if (!e.target.closest('.delete-btn')) openManageTournamentModal(row.dataset.id); }));
            tableBody.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); deleteTournamentFromDb(btn.dataset.id); }));
        }
        function updateSeasonFilter() {
             const anos = [...new Set(allTournaments.map(t => t.ano))].filter(Boolean).sort((a, b) => b - a);
             const select = document.getElementById('season-filter');
             const currentYear = new Date().getFullYear();
             select.innerHTML = `<option value="all">Todas</option>${anos.map(ano => `<option value="${ano}">${ano}</option>`).join('')}`;
             if (anos.includes(currentYear)) {
                 select.value = currentYear;
             } else if (anos.length > 0) {
                 select.value = anos[0];
             }
        }
        function updateStatsForSeason() {
            const season = document.getElementById('season-filter').value;
            if (!season) return;
            const filtered = (season === 'all') ? allTournaments : allTournaments.filter(t => t.ano == season);
            let vitoriasATP = 0, derrotasATP = 0, titulosATP = 0, premiacao = 0;
            filtered.forEach(t => {
                premiacao += Number(t.premiacao) || 0;
                const isATP = t.tipo && !t.tipo.startsWith('CH');
                if (isATP) {
                    vitoriasATP += (t.jogos || []).filter(j => j.resultado === 'V').length;
                    derrotasATP += (t.jogos || []).filter(j => j.resultado === 'D').length;
                    if(t.faseFinal === 'Campeão') titulosATP++;
                }
            });
            document.getElementById('temporadas-vitorias').textContent = vitoriasATP;
            document.getElementById('temporadas-derrotas').textContent = derrotasATP;
            document.getElementById('temporadas-titulos').textContent = titulosATP;
            document.getElementById('temporadas-premiacao').textContent = formatCurrency(premiacao);
        }
        // --- H2H FUNCTIONS ---
        function updateOpponentList() {
            const opponentMap = new Map();
            availableOpponentCountries = new Set();
            
            allTournaments.forEach(t => (t.jogos || []).forEach(j => {
                const normalized = j.adversario.trim().toLowerCase();
                if (!opponentMap.has(normalized)) {
                    opponentMap.set(normalized, { name: j.adversario.trim(), country: j.nacionalidade });
                }
                if (j.nacionalidade && j.nacionalidade !== 'ATP') {
                    availableOpponentCountries.add(j.nacionalidade);
                }
            }));
            
            // Populate global names
            allOpponentNames = Array.from(opponentMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            
            // CORREÇÃO: Merge DB countries with Major Countries list
            const combinedCountries = new Set([...availableOpponentCountries, ...majorCountries]);
            const sortedCountries = Array.from(combinedCountries).sort();
            
            // Populate Country Filter
            const countrySelect = document.getElementById('h2h-country-filter');
            const currentVal = countrySelect.value;
            countrySelect.innerHTML = '<option value="">Todos os Países</option>' + 
                sortedCountries.map(c => `<option value="${c}">${c} ${getFlagEmoji(c)}</option>`).join('');
            countrySelect.value = currentVal;
        }

        function handleH2hSearchInput() {
            const searchInput = document.getElementById('h2h-search');
            const suggestionsDiv = document.getElementById('h2h-suggestions');
            const countryFilter = document.getElementById('h2h-country-filter').value;
            const query = searchInput.value.toLowerCase();
            
            if (!query) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            let filteredOpponents = allOpponentNames;
            
            if (countryFilter) {
                filteredOpponents = filteredOpponents.filter(op => op.country === countryFilter);
            }
            
            const suggestions = filteredOpponents.filter(op => op.name.toLowerCase().includes(query));

            if (suggestions.length > 0) {
                const isMobile = window.innerWidth < 768;
                suggestionsDiv.style.bottom = isMobile ? '100%' : 'auto';
                suggestionsDiv.style.top = isMobile ? 'auto' : '100%';
                suggestionsDiv.innerHTML = suggestions.map(op => `<div class="p-3 hover:bg-background-deep cursor-pointer text-text-main">${op.name} ${getFlagEmoji(op.country)}</div>`).join('');
                suggestionsDiv.classList.remove('hidden');
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        }

        function displayH2HResults() {
            const opponentNameInput = document.getElementById('h2h-search').value.trim();
            const countryFilter = document.getElementById('h2h-country-filter').value;
            const resultsDiv = document.getElementById('h2h-results');
            
            // Case 1: No Input, No Country -> Reset
            if (!opponentNameInput && !countryFilter) { 
                resultsDiv.innerHTML = `<p class="text-center text-text-muted py-8">Selecione um adversário ou país.</p>`; 
                return; 
            }
            
            // Case 2: Country Selected but No Name Input -> List all players from that country
            if (countryFilter && !opponentNameInput) {
                const opponentsFromCountry = allOpponentNames.filter(op => op.country === countryFilter);
                if(opponentsFromCountry.length === 0) {
                    resultsDiv.innerHTML = `<p class="text-center text-text-muted py-8">Nenhum adversário enfrentado do país: ${getFlagEmoji(countryFilter)} ${countryFilter}.</p>`;
                    return;
                }

                let listHtml = `<div class="mb-4 text-center font-extrabold text-xl text-primary">Adversários de ${getFlagEmoji(countryFilter)} ${countryFilter}</div>`;
                listHtml += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[400px] overflow-y-auto p-2">`;
                
                opponentsFromCountry.forEach(op => {
                    let wins = 0, losses = 0;
                    allTournaments.forEach(t => {
                        (t.jogos || []).forEach(j => {
                             if (j.adversario.trim().toLowerCase() === op.name.toLowerCase()) {
                                if (j.resultado === 'V') wins++; else losses++;
                             }
                        });
                    });
                    listHtml += `
                        <div class="bg-card-base border border-border-subtle p-3 rounded-lg flex justify-between items-center cursor-pointer hover:bg-card-base/50 transition-colors" onclick="document.getElementById('h2h-search').value = '${op.name}'; document.getElementById('h2h-search').dispatchEvent(new Event('change'));">
                            <span class="font-medium text-text-main">${op.name}</span>
                            <span class="text-sm"><span class="text-secondary font-bold">${wins}</span> - <span class="text-red-400 font-bold">${losses}</span></span>
                        </div>`;
                });
                listHtml += `</div><p class="text-center text-xs text-text-muted mt-2">Clique em um jogador para ver detalhes.</p>`;
                resultsDiv.innerHTML = listHtml;
                return;
            }

            // Case 3: Specific Opponent Search (with or without country filter)
            let wins = 0, losses = 0; const matches = [];
            let opponentNationalityCode = '';
            
            allTournaments.forEach(t => {
                (t.jogos || []).forEach(j => {
                    if (j.adversario.trim().toLowerCase() === opponentNameInput.toLowerCase()) {
                        if (countryFilter && j.nacionalidade !== countryFilter) return; // Filter mismatch check
                        
                        if (j.resultado === 'V') wins++; else losses++;
                        if (j.nacionalidade && !opponentNationalityCode) opponentNationalityCode = j.nacionalidade;
                        matches.push({ ...t, ...j });
                    }
                });
            });

            if (matches.length === 0) {
                 resultsDiv.innerHTML = `<p class="text-center text-text-muted py-8">Nenhum confronto encontrado${countryFilter ? ` com este filtro de país` : ''}.</p>`; 
                 return;
            }

            matches.sort((a,b) => new Date(b.dataInicio) - new Date(a.dataInicio));
            let html = `<div class="text-center mb-6"><p class="text-xl md:text-2xl font-extrabold whitespace-nowrap">F. Lapa ${getFlagEmoji('BRA')} <span class="text-secondary">${wins}</span> x <span class="text-red-400">${losses}</span> ${opponentNameInput} ${getFlagEmoji(opponentNationalityCode)}</p></div>`;
            
            html += `
                <div class="overflow-x-auto rounded-lg border border-border-subtle shadow-xl"><table class="w-full min-w-[600px] text-sm text-text-main">
                    <thead class="text-xs uppercase bg-background-deep text-text-muted"><tr>
                        <th class="py-3 px-4 text-left">Ano</th><th class="py-3 px-4 text-left">Torneio</th>
                        <th class="py-3 px-4 text-left whitespace-nowrap">Tipo</th><th class="py-3 px-4 text-left">Rodada</th>
                        <th class="py-3 px-4 text-left">Piso</th><th class="py-3 px-4 text-left whitespace-nowrap">Placar</th>
                        <th class="py-3 px-4 text-left">Res.</th>
                    </tr></thead><tbody>
                    ${matches.map(m => `
                        <tr class="border-b border-border-subtle odd:bg-card-base/50 even:bg-background-deep/50 hover:bg-card-base/50 transition-colors">
                            <td class="py-3 px-4 text-text-muted">${m.ano}</td>
                            <td class="py-3 px-4 font-semibold text-text-main">${getFlagEmoji(m.paisTorneio)} ${m.nome}</td>
                            <td class="py-3 px-4 whitespace-nowrap text-text-muted">${abbreviateTournamentType(m.tipo)}</td>
                            <td class="py-3 px-4 text-text-muted">${abbreviateRound(m.rodada)}</td>
                            <td class="py-3 px-4 text-text-muted">${m.superficie}</td>
                            <td class="py-3 px-4 whitespace-nowrap text-text-main">${m.placar}</td>
                            <td class="py-3 px-4 font-bold ${m.resultado === 'V' ? 'text-secondary' : 'text-red-400'}">${m.resultado === 'V' ? 'Vitória' : 'Derrota'}</td>
                        </tr>`).join('')}
                    </tbody></table></div>`;
            resultsDiv.innerHTML = html;
        }
        // --- INITIALIZATION ---
        function initialize() {
            document.getElementById('create-tournament-btn').addEventListener('click', openCreateTournamentModal);
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.getElementById('season-filter').addEventListener('change', () => { renderMainTable(); updateStatsForSeason(); });
            
            const h2hSearch = document.getElementById('h2h-search');
            const h2hCountry = document.getElementById('h2h-country-filter');

            h2hSearch.addEventListener('input', handleH2hSearchInput);
            h2hSearch.addEventListener('change', displayH2HResults);
            h2hCountry.addEventListener('change', () => {
                 handleH2hSearchInput(); 
                 displayH2HResults();   
            });

            document.getElementById('h2h-suggestions').addEventListener('click', (e) => {
                if (e.target.tagName === 'DIV') {
                    const text = e.target.innerText; 
                    const namePart = text.split(/[\uD800-\uDBFF][\uDC00-\DFFF]/)[0].trim();
                    h2hSearch.value = namePart;
                    document.getElementById('h2h-suggestions').classList.add('hidden');
                    displayH2HResults();
                }
            });
            document.addEventListener('click', (e) => { if (!e.target.closest('.relative')) { document.getElementById('h2h-suggestions').classList.add('hidden'); }});
            document.getElementById('titulos-list').addEventListener('click', handleDetailsClick);
            document.getElementById('vitorias-list').addEventListener('click', handleDetailsClick);
            document.getElementById('titulos-surface-list').addEventListener('click', handleDetailsClick);
            document.getElementById('vitorias-surface-list').addEventListener('click', handleDetailsClick);
            
            const listContainers = ['vitorias-list', 'titulos-list'];
            listContainers.forEach(id => {
                document.getElementById(id).addEventListener('click', (e) => {
                    const button = e.target.closest('.toggle-sublist-btn');
                    if (!button) return;
                    const targetId = button.dataset.target;
                    const target = document.getElementById(targetId);
                    const icon = button.querySelector('i');
                    target.classList.toggle('open');
                    icon.classList.toggle('fa-plus');
                    icon.classList.toggle('fa-minus');
                });
            });

            const tabButtons = document.querySelectorAll('.tab-button'), tabContents = document.querySelectorAll('.tab-content');
            tabButtons.forEach(button => button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(button.dataset.tab).classList.add('active');
            }));
            const chartColors = ['#fcd34d', '#06b6d4', '#10b981', '#ef4444', '#3b82f6', '#ec4899', '#a78bfa', '#fb923c', '#d4d4d8', '#34d399', '#94a3b8'];
            titulosChart = new Chart(document.getElementById('titulosChart').getContext('2d'), { 
                type: 'doughnut', 
                data: { labels: tournamentTypes, datasets: [{ data: [], backgroundColor: chartColors }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            labels: { 
                                color: 'var(--text-main)',
                                font: { size: 14 } // Aumentado para melhor legibilidade
                            } 
                        },
                        title: { display: false }
                    }
                }
            });
            vitoriasChart = new Chart(document.getElementById('vitoriasChart').getContext('2d'), { 
                type: 'bar', 
                data: { 
                    labels: surfaces, 
                    datasets: [
                        { 
                            label: 'Vitórias (ATP)', 
                            data: [], 
                            backgroundColor: 'var(--secondary)',
                            hoverBackgroundColor: '#1dcd93',
                            borderRadius: 4,
                            borderSkipped: false
                        }, 
                        { 
                            label: 'Derrotas (ATP)', 
                            data: [], 
                            backgroundColor: '#f87171',
                            hoverBackgroundColor: '#ef4444',
                            borderRadius: 4,
                            borderSkipped: false
                        }
                    ]
                }, 
                options: { 
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { labels: { color: 'var(--text-main)', font: { size: 12 } } } },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { color: 'rgba(255, 255, 255, 0.15)', drawBorder: false }, 
                            ticks: { color: 'var(--text-muted)' } 
                        },
                        x: { 
                            grid: { color: 'rgba(255, 255, 255, 0.15)', drawBorder: false }, 
                            ticks: { color: 'var(--text-muted)' } 
                        }
                    }
                } 
            });
            
            calcularIdade();
            document.getElementById('main-flag').textContent = getFlagEmoji('BRA');
            loadTournamentsFromDb();
        }

        function calcularIdade(){
            const hoje = new Date();
            let idade = hoje.getFullYear() - dataNascimentoJogador.getFullYear();
            const m = hoje.getMonth() - dataNascimentoJogador.getMonth();
            if (m < 0 || (m === 0 && hoje.getDate() < dataNascimentoJogador.getDate())) {
                idade--;
            }
            document.getElementById('idade').textContent = idade;
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
