<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fernando Lapa - Dashboard de T√™nis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #1e40af;
            --secondary: #10b981;
            --accent: #facc15;
            --background: #f1f5f9;
            --text: #1f2937;
            --border: #e5e7eb;
            --error: #ef4444;
            --success: #22c55e;
            --card-bg: rgba(255, 255, 255, 0.9);
        }

        html, body { overflow-x: hidden; width: 100%; }
        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            background-image: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            background-attachment: fixed;
            color: var(--text);
        }

        .main-container {
            display: grid; grid-template-columns: 1fr; gap: 1.5rem; width: 100%;
            max-width: 1400px; margin: 0 auto; padding: 0.75rem;
        }
        @media (min-width: 1024px) { .main-container { grid-template-columns: 320px 1fr; } }
        
        .glass-card {
            background: var(--card-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .tab-button {
            padding: 0.75rem 1.25rem; font-weight: 600; font-size: 0.9rem;
            border-radius: 0.75rem; border: 2px solid transparent; color: #4b5563;
            cursor: pointer; transition: all 0.3s ease; white-space: nowrap;
        }
        .tab-button.active, .tab-button:hover {
            color: var(--primary); background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: smoothEnter 0.5s ease-out forwards; }
        
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes smoothEnter { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content { animation: smoothEnter 0.4s ease-out forwards; }
        
        .form-input, .form-select {
            width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border);
            background-color: #fff; font-size: 0.9rem; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(30, 64, 175, 0.3);
        }
        .btn {
            padding: 0.6rem 1.2rem; font-weight: 600; border-radius: 0.5rem; color: white;
            background-color: var(--primary); transition: background-color 0.3s; cursor: pointer; border: none;
        }
        .btn:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: var(--secondary); }
        .btn-secondary:hover { background-color: #059669; }
        .btn-danger { background-color: var(--error); }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-sm { padding: 0.25rem 0.6rem; font-size: 0.8rem; }

        #temporadas-tabela tr { cursor: pointer; }
        .details-btn {
            background: none; border: none; color: var(--primary); cursor: pointer;
            margin-left: 0.5rem; opacity: 0.6; transition: opacity 0.2s;
        }
        .details-btn:hover { opacity: 1; }
    </style>
</head>
<body class="bg-slate-50">
    <div class="main-container">
        <aside class="space-y-6">
            <div class="glass-card p-6 text-center fade-in-up">
                <img src="https://ui-avatars.com/api/?name=Fernando+Lapa&background=1e40af&color=fff&size=96&bold=true&rounded=true" alt="Avatar Fernando Lapa" class="mx-auto mb-4 border-4 border-white/50 rounded-full shadow-lg">
                <h1 class="text-2xl font-bold text-slate-800">Fernando Lapa</h1>
                <p class="text-sm text-slate-600">Tenista Profissional</p>
            </div>

            <div class="glass-card p-6 space-y-4 fade-in-up" style="animation-delay: 0.1s;">
                <h2 class="text-lg font-bold text-slate-800 border-b pb-2 mb-4">Estat√≠sticas</h2>
                <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-slate-600"><i class="fa-solid fa-ranking-star w-5 mr-2 text-primary"></i>Ranking</span>
                    <span id="ranking" class="font-bold text-slate-700">Sem ranking</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-slate-600"><i class="fa-solid fa-sack-dollar w-5 mr-2 text-secondary"></i>Pr√™mios</span>
                    <span id="premiacao" class="font-bold text-slate-700">$0.00</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-slate-600"><i class="fa-solid fa-trophy w-5 mr-2 text-accent"></i>T√≠tulos</span>
                    <span id="titulos-total" class="font-bold text-slate-700">0</span>
                </div>
                 <div class="flex items-center justify-between text-sm">
                    <span class="font-semibold text-slate-600"><i class="fa-solid fa-right-left w-5 mr-2 text-green-500"></i>V/D (ATP)</span>
                    <span id="vitorias-derrotas" class="font-bold text-slate-700">0 / 0</span>
                </div>
            </div>

            <div class="glass-card p-4 fade-in-up" style="animation-delay: 0.2s;">
                 <button id="create-tournament-btn" class="btn w-full flex justify-center items-center">
                    <i class="fa-solid fa-plus-circle mr-2"></i>Criar Novo Torneio
                </button>
            </div>
        </aside>

        <main class="space-y-6 min-w-0">
            <div class="bg-slate-200/50 p-2 rounded-xl flex items-center justify-start gap-2 overflow-x-auto fade-in-up" style="animation-delay: 0.3s;" role="tablist">
                 <button class="tab-button active" data-tab="temporadas" role="tab" aria-selected="true">Temporadas</button>
                 <button class="tab-button" data-tab="titulos" role="tab" aria-selected="false">T√≠tulos</button>
                 <button class="tab-button" data-tab="vitorias" role="tab" aria-selected="false">Vit√≥rias/Derrotas</button>
                 <button class="tab-button" data-tab="h2h" role="tab" aria-selected="false">Head-to-Head</button>
                 <button class="tab-button" data-tab="recordes" role="tab" aria-selected="false">Recordes</button>
            </div>
            
            <div class="fade-in-up" style="animation-delay: 0.4s;">
                <div id="temporadas" class="tab-content active" role="tabpanel">
                    <div class="glass-card p-4 md:p-6">
                        <h2 class="text-2xl font-bold mb-6 text-slate-800">Hist√≥rico de Temporadas</h2>
                        <div class="flex items-center gap-4 mb-4 bg-slate-100 p-3 rounded-lg">
                            <label for="season-filter" class="font-semibold text-gray-700 text-sm">Filtrar por Temporada:</label>
                            <select id="season-filter" class="form-select w-auto"></select>
                        </div>
                        <div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-slate-500">Vit√≥rias (ATP)</p><p id="temporadas-vitorias" class="font-bold text-lg text-green-600">0</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-slate-500">Derrotas (ATP)</p><p id="temporadas-derrotas" class="font-bold text-lg text-red-600">0</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-slate-500">T√≠tulos (ATP)</p><p id="temporadas-titulos" class="font-bold text-lg text-amber-500">0</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p id="temporadas-premiacao-label" class="text-xs text-slate-500">Premia√ß√£o</p><p id="temporadas-premiacao" class="font-bold text-lg text-blue-700">$0.00</p></div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="text-xs">
                                    <tr>
                                        <th class="py-2 px-1 sm:px-2 text-left">Datas</th> <th class="py-2 px-1 sm:px-2 text-left">Torneio</th>
                                        <th class="py-2 px-1 sm:px-2 text-left">Superf√≠cie</th> <th class="py-2 px-1 sm:px-2 text-center">Status</th>
                                        <th class="py-2 px-1 sm:px-2 text-center">Campanha (V-D)</th> <th class="py-2 px-1 sm:px-2 text-left">Resultado Final</th>
                                        <th class="py-2 px-1 sm:px-2 text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="temporadas-tabela" class="text-xs sm:text-sm align-middle"></tbody>
                            </table>
                             <p id="no-tournaments-msg" class="text-center text-slate-500 py-8 hidden">Nenhum torneio encontrado. Clique em "Criar Novo Torneio" para come√ßar.</p>
                        </div>
                        
                        <div class="mt-8 pt-6 border-t border-slate-200">
                             <h3 class="text-lg font-semibold mb-4 text-slate-700">Gerenciar Dados</h3>
                             <div class="flex flex-wrap gap-4 items-center">
                                 <button id="export-btn" class="btn">Exportar</button>
                                 <label for="import-file" class="btn cursor-pointer">Importar</label>
                                 <input type="file" id="import-file" class="hidden" accept=".json">
                             </div>
                        </div>
                    </div>
                </div>

                <div id="titulos" class="tab-content" role="tabpanel">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-card p-4 md:p-6">
                            <h2 class="text-2xl font-bold mb-6 text-slate-800">Resumo de T√≠tulos</h2>
                             <p class="font-semibold text-lg">Total de T√≠tulos (ATP): <span id="titulos-total-resumo" class="text-primary">0</span></p>
                             <div id="titulos-list" class="mt-4 space-y-2 text-sm"></div>
                             <p class="font-semibold mt-6 pt-4 border-t border-slate-200">T√≠tulos por Superf√≠cie (ATP):</p>
                             <ul id="titulos-surface-list" class="list-disc pl-6 text-sm"></ul>
                        </div>
                         <div class="glass-card p-4 md:p-6"><h3 class="text-xl font-bold mb-4 text-slate-800">Distribui√ß√£o de T√≠tulos</h3><canvas id="titulosChart"></canvas></div>
                    </div>
                </div>

                <div id="vitorias" class="tab-content" role="tabpanel">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-card p-4 md:p-6">
                            <h2 class="text-2xl font-bold mb-6 text-slate-800">Vit√≥rias e Derrotas</h2>
                            <p><strong>Total (ATP):</strong> <span id="total-vitorias" class="text-green-600">0</span> V / <span id="total-derrotas" class="text-red-600">0</span> D</p>
                            <p><strong>Taxa de Vit√≥rias (ATP):</strong> <span id="taxa-vitorias" class="font-bold text-primary">0%</span></p>
                            <p class="font-semibold mt-6 pt-4 border-t border-slate-200">Por Tipo de Torneio:</p>
                            <div id="vitorias-list" class="text-sm space-y-1 mt-2"></div>
                            <p class="font-semibold mt-6 pt-4 border-t border-slate-200">Por Superf√≠cie (ATP):</p>
                             <ul id="vitorias-surface-list" class="list-disc pl-6 text-sm"></ul>
                        </div>
                        <div class="glass-card p-4 md:p-6"><h3 class="text-xl font-bold mb-4 text-slate-800">Desempenho por Superf√≠cie</h3><canvas id="vitoriasChart"></canvas></div>
                    </div>
                </div>

                <div id="h2h" class="tab-content" role="tabpanel">
                    <div class="glass-card p-4 md:p-6">
                        <h2 class="text-2xl font-bold mb-6 text-slate-800">Head-to-Head (H2H)</h2>
                        <div class="relative mb-6">
                            <label for="h2h-search" class="block text-sm font-medium text-gray-700 mb-2">Pesquisar Advers√°rio:</label>
                            <input id="h2h-search" class="form-input" placeholder="Digite o nome de um advers√°rio" autocomplete="off">
                            <div id="h2h-suggestions" class="absolute z-10 w-full bg-white rounded-md shadow-lg hidden mt-1 max-h-48 overflow-y-auto"></div>
                        </div>
                        <div id="h2h-results">
                            <p class="text-center text-slate-500 py-8">Selecione um advers√°rio para ver o hist√≥rico de confrontos.</p>
                        </div>
                    </div>
                </div>

                <div id="recordes" class="tab-content" role="tabpanel">
                     <div class="glass-card p-4 md:p-6">
                        <h2 class="text-2xl font-bold mb-6 text-slate-800">Recordes na Carreira</h2>
                        <div id="recordes-conquistados" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="mainModal" class="fixed inset-0 z-50 items-center justify-center bg-black/60 hidden p-4">
        <div id="modalContent" class="modal-content glass-card max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center p-4 border-b border-slate-200 sticky top-0 bg-white/80 backdrop-blur-sm z-10">
                <h3 id="modalTitle" class="text-xl font-bold flex items-center gap-3"></h3>
                <button id="closeModalBtn" class="text-2xl text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div id="modalBody" class="p-6"></div>
            <div id="modalFooter" class="flex justify-end gap-3 p-4 border-t border-slate-200 sticky bottom-0 bg-white/80 backdrop-blur-sm"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';

        // --- CONFIG & GLOBALS ---
        const firebaseConfig = {
            apiKey: "AIzaSyBIWmpJcoCiD3jTWROFcjSZDgXcxafsgtA",
            authDomain: "tenis-456fc.firebaseapp.com",
            projectId: "tenis-456fc",
            storageBucket: "tenis-456fc.appspot.com",
            messagingSenderId: "21965853527",
            appId: "1:21965853527:web:38a9edbe0eb2438679e412",
            measurementId: "G-ZJ5MP3RLD9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let allTournaments = [];
        let titulosChart, vitoriasChart;
        let allOpponentNames = [];

        const modal = document.getElementById('mainModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const dataNascimentoJogador = new Date('2011-02-18');
        
        const tournamentTypes = ['Grand Slam', 'ATP Finals', 'ATP Masters 1000', 'ATP 500', 'ATP 250', 'Jogos Ol√≠mpicos', 'CH 175', 'CH 125', 'CH 100', 'CH 90', 'CH 75'];
        const surfaces = ['Saibro', 'R√°pida', 'Grama'];
        const roundsByTournamentType = {
            'Grand Slam': ['Primeira Rodada', 'Segunda Rodada', 'Terceira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'ATP Masters 1000': ['Primeira Rodada', 'Segunda Rodada', 'Terceira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'ATP 500': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'ATP 250': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'Jogos Ol√≠mpicos': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Disputa Bronze', 'Final'],
            'ATP Finals': ['Fase de Grupos 1', 'Fase de Grupos 2', 'Fase de Grupos 3', 'Semifinal', 'Final'],
            'CH 175': ['Primeira Rodada', 'Segunda Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 125': ['Primeira Rodada', 'Segunda Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 100': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 90': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'CH 75': ['Primeira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final'],
            'Default': ['Primeira Rodada', 'Segunda Rodada', 'Terceira Rodada', 'Oitavas de Final', 'Quartas de Final', 'Semifinal', 'Final']
        };
        const iocToIso2 = {'AFG':'AF','ALB':'AL','ALG':'DZ','ASA':'AS','AND':'AD','ANG':'AO','ANT':'AG','ARG':'AR','ARM':'AM','ARU':'AW','AUS':'AU','AUT':'AT','AZE':'AZ','BAH':'BS','BRN':'BH','BAN':'BD','BAR':'BB','BLR':'BY','BEL':'BE','BIZ':'BZ','BEN':'BJ','BER':'BM','BHU':'BT','BOL':'BO','BIH':'BA','BOT':'BW','BRA':'BR','IVB':'VG','BRU':'BN','BUL':'BG','BUR':'BF','BDI':'BI','CAM':'KH','CMR':'CM','CAN':'CA','CAY':'KY','CAF':'CF','CHA':'TD','CHI':'CL','CHN':'CN','TPE':'TW','COL':'CO','COM':'KM','CGO':'CG','COD':'CD','COK':'CK','CRC':'CR','CIV':'CI','CRO':'HR','CUB':'CU','CYP':'CY','CZE':'CZ','DEN':'DK','DJI':'DJ','DMA':'DM','DOM':'DO','ECU':'EC','EGY':'EG','ESA':'SV','GEQ':'GQ','ERI':'ER','EST':'EE','SWZ':'SZ','ETH':'ET','FIJ':'FJ','FIN':'FI','FRA':'FR','GAB':'GA','GAM':'GM','GEO':'GE','GER':'DE','GHA':'GH','GBR':'GB','GRE':'GR','GRN':'GD','GUM':'GU','GUA':'GT','GUI':'GN','GBS':'GW','GUY':'GY','HAI':'HT','HON':'HN','HKG':'HK','HUN':'HU','ISL':'IS','IND':'IN','INA':'ID','IRI':'IR','IRQ':'IQ','IRL':'IE','ISR':'IL','ITA':'IT','JAM':'JM','JOR':'JO','KAZ':'KZ','KEN':'KE','KIR':'KI','PRK':'KP','KOR':'KR','KUW':'KW','KGZ':'KG','LAO':'LA','LAT':'LV','LIB':'LB','LES':'LS','LBR':'LR','LBA':'LY','LIE':'LI','LTU':'LT','LUX':'LU','MAD':'MG','MAW':'MW','MAS':'MY','MDV':'MV','MLI':'ML','MLT':'MT','MHL':'MH','MTN':'MR','MRI':'MU','MEX':'MX','FSM':'FM','MDA':'MD','MON':'MC','MGL':'MN','MNE':'ME','MAR':'MA','MOZ':'MZ','MYA':'MM','NAM':'NA','NRU':'NR','NEP':'NP','NED':'NL','NZL':'NZ','NCA':'NI','NIG':'NE','NGR':'NG','MKD':'MK','NOR':'NO','OMA':'OM','PAK':'PK','PLW':'PW','PLE':'PS','PAN':'PA','PNG':'PG','PAR':'PY','PER':'PE','PHI':'PH','POL':'PL','POR':'PT','PUR':'PR','QAT':'QA','ROU':'RO','RUS':'RU','RWA':'RW','SKN':'KN','LCA':'LC','VIN':'VC','SAM':'WS','SMR':'SM','STP':'ST','KSA':'SA','SEN':'SN','SRB':'RS','SEY':'SC','SLE':'SL','SGP':'SG','SVK':'SK','SLO':'SI','SOL':'SB','SOM':'SO','RSA':'ZA','ESP':'ES','SRI':'LK','SUD':'SD','SUR':'SR','SWE':'SE','SUI':'CH','SYR':'SY','TAN':'TZ','THA':'TH','TLS':'TL','TOG':'TG','TGA':'TO','TTO':'TT','TUN':'TN','TUR':'TR','TKM':'TM','TUV':'TV','UGA':'UG','UKR':'UA','UAE':'AE','USA':'US','URU':'UY','UZB':'UZ','VAN':'VU','VEN':'VE','VIE':'VN','ISV':'VI','YEM':'YE','ZAM':'ZM','ZIM':'ZW'};
        
        const worldRecords = [
            { id: 'grandSlams', title: 'Mais T√≠tulos de Grand Slam', holder: 'Novak Djokovic', value: 24, stat: (s) => s.porTipo['Grand Slam']?.t || 0, format: (v) => `${v} T√≠tulos` },
            { id: 'grandSlamFinals', title: 'Mais Finais de Grand Slam', holder: 'Novak Djokovic', value: 36, stat: (s) => s.finaisGrandSlam, format: (v) => `${v} Finais` },
            { id: 'atpFinals', title: 'Mais T√≠tulos de ATP Finals', holder: 'Novak Djokovic', value: 7, stat: (s) => s.porTipo['ATP Finals']?.t || 0, format: (v) => `${v} T√≠tulos` },
            { id: 'masters1000', title: 'Mais T√≠tulos de Masters 1000', holder: 'Novak Djokovic', value: 40, stat: (s) => s.porTipo['ATP Masters 1000']?.t || 0, format: (v) => `${v} T√≠tulos` },
            { id: 'atp500', title: 'Mais T√≠tulos de ATP 500', holder: 'Roger Federer', value: 24, stat: (s) => s.porTipo['ATP 500']?.t || 0, format: (v) => `${v} T√≠tulos` },
            { id: 'careerTitles', title: 'Mais T√≠tulos na Carreira (ATP)', holder: 'Jimmy Connors', value: 109, stat: (s) => s.titulosATP, format: (v) => `${v} T√≠tulos` },
            { id: 'careerFinals', title: 'Mais Finais na Carreira (ATP)', holder: 'Jimmy Connors', value: 164, stat: (s) => s.finaisATP, format: (v) => `${v} Finais` },
            { id: 'matchWins', title: 'Mais Vit√≥rias na Carreira (ATP)', holder: 'Jimmy Connors', value: 1274, stat: (s) => s.vitoriasATP, format: (v) => `${v} Vit√≥rias` },
            { id: 'prizeMoney', title: 'Maior Premia√ß√£o na Carreira', holder: 'Novak Djokovic', value: 182000000, stat: (s) => s.premiacao, format: (v) => formatCurrency(v) },
            { id: 'winPercentage', title: '% de Vit√≥rias (ATP, min. 200 jogos)', holder: 'Novak Djokovic', value: 83.9, stat: (s) => (s.vitoriasATP + s.derrotasATP > 200) ? (s.vitoriasATP / (s.vitoriasATP + s.derrotasATP) * 100) : 0, format: (v) => v > 0 ? `${v.toFixed(2)}%` : 'N/A' },
            { id: 'clayTitles', title: 'Mais T√≠tulos no Saibro (ATP)', holder: 'Rafael Nadal', value: 63, stat: (s) => s.porSuperficie.Saibro?.atp_t || 0, format: (v) => `${v} T√≠tulos` },
            { id: 'hardTitles', title: 'Mais T√≠tulos em Quadra R√°pida (ATP)', holder: 'Roger Federer', value: 71, stat: (s) => s.porSuperficie.R√°pida?.atp_t || 0, format: (v) => `${v} T√≠tulos` },
            { id: 'grassTitles', title: 'Mais T√≠tulos na Grama (ATP)', holder: 'Roger Federer', value: 19, stat: (s) => s.porSuperficie.Grama?.atp_t || 0, format: (v) => `${v} T√≠tulos` },
            { id: 'singleTournament', title: 'Mais T√≠tulos em um √önico Torneio', holder: 'Rafael Nadal', value: 14, stat: (s) => s.maxTitulosUnicoTorneio, format: (v, s) => `${v} (${s.nomeMaxTitulosUnicoTorneio})` },
            { id: 'singleSeason', title: 'Mais T√≠tulos em uma Temporada', holder: 'Guillermo Vilas', value: 16, stat: (s) => s.maxTitulosEmUmAno, format: (v) => `${v} T√≠tulos` },
            { id: 'careerSlam', title: 'Career Grand Slam', holder: 'V√°rios', value: 4, stat: (s) => s.grandSlamEvents.size, format: (v) => v === 4 ? 'Conquistado üèÜ' : `${v} de 4` },
            { id: 'goldenSlam', title: 'Career Golden Slam', holder: 'A. Agassi, R. Nadal', value: 5, stat: (s) => s.goldenSlamEvents.size, format: (v) => v === 5 ? 'Conquistado üèÜ' : `${v} de 5` },
            { id: 'youngestGS', title: 'Vencedor de GS Mais Jovem', holder: 'Michael Chang', value: 207, isLowerBetter: true, stat: (s) => s.idadeMenorCampeaoGS, format: (v) => v > 0 ? `${Math.floor(v/12)}a ${v%12}m` : 'N/A' },
            { id: 'oldestGS', title: 'Vencedor de GS Mais Velho', holder: 'Ken Rosewall', value: 446, stat: (s) => s.idadeMaiorCampeaoGS, format: (v) => v > 0 ? `${Math.floor(v/12)}a ${v%12}m` : 'N/A' },
        ];

        // --- MODAL & UI HELPERS ---
        function openModal(title, bodyHTML, footerHTML = '') {
            modalTitle.innerHTML = title;
            modalBody.innerHTML = bodyHTML;
            modalFooter.innerHTML = footerHTML;
            modal.style.display = 'flex';
        }
        function closeModal() { modal.style.display = 'none'; }
        function formatCurrency(value) { return (Number(value) || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' }); }
        
        function estimarRanking(pontos) {
            if (pontos <= 0) return 'Sem Ranking';
            const rankingPointsMap = [
                { rank: 1, points: 9500 }, { rank: 10, points: 4000 }, { rank: 25, points: 1500 },
                { rank: 50, points: 1000 }, { rank: 100, points: 640 }, { rank: 150, points: 430 },
                { rank: 200, points: 310 }, { rank: 250, points: 240 }, { rank: 300, points: 190 },
                { rank: 400, points: 125 }, { rank: 500, points: 80 }, { rank: 750, points: 35 },
                { rank: 1000, points: 17 }, { rank: 1500, points: 1 }
            ];
            for (let i = 0; i < rankingPointsMap.length; i++) {
                if (pontos >= rankingPointsMap[i].points) {
                    if (i === 0) return `${rankingPointsMap[i].rank}¬∫`;
                    const upper = rankingPointsMap[i-1];
                    const lower = rankingPointsMap[i];
                    const pointsRange = upper.points - lower.points;
                    const rankRange = lower.rank - upper.rank;
                    const pointsAboveLower = pontos - lower.points;
                    const rankOffset = (pointsAboveLower / pointsRange) * rankRange;
                    return `${Math.round(lower.rank - rankOffset)}¬∫`;
                }
            }
            return `>1500¬∫`;
        }

        function getFlagEmoji(iocCode) {
            if (!iocCode || iocCode.length < 2) return '';
            const code = iocCode.toUpperCase();
            const iso2 = iocToIso2[code] || (code.length === 2 ? code : '');
            if (!iso2) return `(${code})`;
            return iso2.toUpperCase().split('').map(char => String.fromCodePoint(char.charCodeAt(0) + 127397)).join('');
        }
        
        function abbreviateTournamentType(type) {
            const map = {
                "Grand Slam": "GS", "ATP Finals": "Finals", "ATP Masters 1000": "M1000",
                "Jogos Ol√≠mpicos": "Ol√≠mpiadas"
            };
            return map[type] || type;
        }

        function abbreviateRound(round) {
            const map = {
                "Primeira Rodada": "R1", "Segunda Rodada": "R2", "Terceira Rodada": "R3",
                "Oitavas de Final": "R16", "Quartas de Final": "QF", "Semifinal": "SF", "Final": "F",
                "Disputa Bronze": "Bronze"
            };
            return map[round] || round;
        }
        
        // --- CRUD & DB OPERATIONS ---
        async function loadTournamentsFromDb() {
            try {
                const snapshot = await getDocs(collection(db, 'torneios'));
                allTournaments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            } catch (error) { console.error("Erro ao carregar torneios: ", error); document.getElementById('no-tournaments-msg').textContent = 'Erro ao carregar dados.'; document.getElementById('no-tournaments-msg').style.display = 'block'; }
        }
        async function updateTournamentInDb(id, data) {
            try {
                const tournamentRef = doc(db, 'torneios', id);
                await updateDoc(tournamentRef, data);
                const index = allTournaments.findIndex(t => t.id === id);
                if (index > -1) {
                    allTournaments[index] = { ...allTournaments[index], ...data };
                }
                updateUI();
            } catch (error) { console.error("Erro ao atualizar torneio: ", error); alert('Ocorreu um erro ao atualizar.'); }
        }
        async function deleteTournamentFromDb(id) {
            if (confirm('Tem certeza que deseja excluir este torneio e toda a sua campanha?')) {
                try {
                    await deleteDoc(doc(db, 'torneios', id));
                    allTournaments = allTournaments.filter(t => t.id !== id);
                    updateUI();
                } catch (error) { console.error("Erro ao excluir torneio: ", error); alert('Ocorreu um erro ao excluir.'); }
            }
        }
        async function handleSaveNewTournament() {
            const form = document.getElementById('create-tournament-form');
            if (!form.checkValidity()) { form.reportValidity(); return; }
            const dataInicio = document.getElementById('torneio-data-inicio').value;
            const newTournament = {
                nome: document.getElementById('torneio-nome').value.trim(),
                tipo: document.getElementById('torneio-tipo').value,
                superficie: document.getElementById('torneio-superficie').value,
                paisTorneio: document.getElementById('torneio-pais').value.trim().toUpperCase(),
                dataInicio, dataFim: document.getElementById('torneio-data-fim').value,
                ano: new Date(dataInicio + 'T00:00:00').getFullYear(),
                pontos: 0, premiacao: 0, faseFinal: '', status: 'Em Andamento',
                jogos: [{
                    rodada: 'Primeira Rodada',
                    adversario: document.getElementById('jogo-adversario').value.trim(),
                    nacionalidade: document.getElementById('jogo-nacionalidade').value.trim().toUpperCase(),
                    placar: document.getElementById('jogo-placar').value.trim(),
                    resultado: document.getElementById('jogo-resultado').value,
                }]
            };
            if (newTournament.jogos[0].resultado === 'D') {
                newTournament.status = 'Finalizado';
                newTournament.faseFinal = 'Primeira Rodada';
                newTournament.pontos = Number(document.getElementById('torneio-pontos').value) || 0;
                newTournament.premiacao = Number(document.getElementById('torneio-premiacao').value) || 0;
            }
            try {
                const docRef = await addDoc(collection(db, 'torneios'), newTournament);
                allTournaments.push({ id: docRef.id, ...newTournament });
                closeModal();
                updateUI();
            } catch (error) { console.error("Erro ao salvar novo torneio: ", error); alert('Ocorreu um erro ao salvar.'); }
        }

        // --- MODAL RENDERING ---
        function openCreateTournamentModal() {
            const body = `
                <form id="create-tournament-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="torneio-nome" class="block text-sm font-medium">Nome</label><input type="text" id="torneio-nome" class="form-input mt-1" required></div>
                        <div><label for="torneio-pais" class="block text-sm font-medium">Pa√≠s do Torneio (Ex: BRA)</label><input type="text" id="torneio-pais" maxlength="3" class="form-input mt-1" required></div>
                        <div><label for="torneio-tipo" class="block text-sm font-medium">Tipo</label><select id="torneio-tipo" class="form-select mt-1" required>${tournamentTypes.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                        <div><label for="torneio-superficie" class="block text-sm font-medium">Superf√≠cie</label><select id="torneio-superficie" class="form-select mt-1" required>${surfaces.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
                        <div><label for="torneio-data-inicio" class="block text-sm font-medium">Data In√≠cio</label><input type="date" id="torneio-data-inicio" class="form-input mt-1" required></div>
                        <div><label for="torneio-data-fim" class="block text-sm font-medium">Data Final</label><input type="date" id="torneio-data-fim" class="form-input mt-1" required></div>
                    </div>
                    <div class="pt-4 mt-4 border-t">
                        <h4 class="text-md font-semibold">Resultado da Estreia</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div><label for="jogo-adversario" class="block text-sm font-medium">Advers√°rio</label><input type="text" id="jogo-adversario" class="form-input mt-1" required></div>
                            <div><label for="jogo-nacionalidade" class="block text-sm font-medium">Nacionalidade (Ex: SUI)</label><input type="text" id="jogo-nacionalidade" maxlength="3" class="form-input mt-1"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div><label for="jogo-placar" class="block text-sm font-medium">Placar</label><input type="text" id="jogo-placar" class="form-input mt-1" required></div>
                            <div><label for="jogo-resultado" class="block text-sm font-medium">Resultado</label><select id="jogo-resultado" class="form-select mt-1"><option value="V" selected>Vit√≥ria</option><option value="D">Derrota</option></select></div>
                        </div>
                    </div>
                    <div id="final-details-create" class="hidden space-y-4 pt-4 mt-4 border-t">
                         <h4 class="text-md font-semibold text-red-600">Finalizar Campanha (Derrota na Estreia)</h4>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="torneio-pontos" class="block text-sm font-medium">Pontos</label><input type="number" id="torneio-pontos" class="form-input mt-1" min="0" value="0"></div>
                            <div><label for="torneio-premiacao" class="block text-sm font-medium">Pr√™mio ($)</label><input type="number" id="torneio-premiacao" class="form-input mt-1" min="0" value="0"></div>
                        </div>
                    </div>
                </form>
            `;
            const footer = `<button id="save-tournament-btn" class="btn btn-secondary">Salvar e Continuar</button>`;
            openModal('Criar Novo Torneio', body, footer);
            const resultSelect = document.getElementById('jogo-resultado'), finalDetails = document.getElementById('final-details-create'), saveBtn = document.getElementById('save-tournament-btn');
            resultSelect.addEventListener('change', () => {
                const isLoss = resultSelect.value === 'D';
                finalDetails.classList.toggle('hidden', !isLoss);
                saveBtn.textContent = isLoss ? 'Salvar e Finalizar' : 'Salvar e Continuar';
                saveBtn.classList.toggle('btn-danger', isLoss); saveBtn.classList.toggle('btn-secondary', !isLoss);
            });
            saveBtn.addEventListener('click', handleSaveNewTournament);
        }
        function openManageTournamentModal(torneioId) {
            const torneio = allTournaments.find(t => t.id === torneioId);
            if (!torneio) return;
            const matchesHistory = (torneio.jogos || []).map(jogo => `
                <div class="p-3 rounded-lg flex justify-between items-center ${jogo.resultado === 'V' ? 'bg-green-50' : 'bg-red-50'}">
                    <div class="flex-grow min-w-0 mr-2">
                        <p class="font-bold truncate">${jogo.rodada}</p>
                        <p class="text-sm text-slate-600 truncate">Fernando Lapa ${getFlagEmoji('BRA')} vs. ${jogo.adversario} ${getFlagEmoji(jogo.nacionalidade)}</p>
                    </div>
                    <div class="flex-shrink-0 flex items-center text-right">
                        <span class="font-semibold text-sm whitespace-nowrap mr-4">${jogo.placar}</span>
                        <span class="text-lg font-bold w-4 ${jogo.resultado === 'V' ? 'text-green-600' : 'text-red-600'}">${jogo.resultado}</span>
                    </div>
                </div>`).join('');
            let body = `<div id="matches-history-list" class="space-y-3">${matchesHistory}</div>`;
            let titlePrefix = torneio.status === 'Finalizado' ? '' : 'Gerenciar: ';
            const modalTitleHTML = `
                <span>${getFlagEmoji(torneio.paisTorneio)}</span>
                <span class="truncate">${titlePrefix}${torneio.nome}</span>
                <span class="text-sm font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded-md">${torneio.tipo}</span>
            `;
            if (torneio.status === 'Finalizado') {
                body += `<div class="mt-6 pt-4 border-t text-center space-y-2"><p class="text-lg font-bold">Campanha Finalizada</p><p><strong>Resultado:</strong> ${torneio.faseFinal}</p><p><strong>Pontos:</strong> ${torneio.pontos}</p><p><strong>Pr√™mio:</strong> ${formatCurrency(torneio.premiacao)}</p></div>`;
            } else {
                const lastPlayedRound = torneio.jogos[torneio.jogos.length - 1].rodada;
                const allPossibleRounds = roundsByTournamentType[torneio.tipo] || roundsByTournamentType['Default'];
                const lastPlayedIndex = allPossibleRounds.indexOf(lastPlayedRound);
                const remainingRounds = allPossibleRounds.slice(lastPlayedIndex + 1);
                body += `
                    <form id="update-tournament-form" class="space-y-4 pt-6 mt-6 border-t">
                        <h4 class="text-md font-semibold">Pr√≥ximo Jogo</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div><label for="next-round" class="block text-sm font-medium">Fase</label><select id="next-round" class="form-select mt-1">${remainingRounds.map(r => `<option value="${r}">${r}</option>`).join('')}</select></div>
                            <div><label for="next-adversario" class="block text-sm font-medium">Advers√°rio</label><input type="text" id="next-adversario" class="form-input mt-1" required></div>
                            <div><label for="next-nacionalidade" class="block text-sm font-medium">Nacionalidade</label><input type="text" maxlength="3" id="next-nacionalidade" class="form-input mt-1" placeholder="Ex: SUI"></div>
                            <div><label for="next-placar" class="block text-sm font-medium">Placar</label><input type="text" id="next-placar" class="form-input mt-1" required></div>
                        </div>
                        <div id="final-details-update" class="hidden space-y-4 pt-4 mt-4 border-t">
                             <h4 id="final-title-update" class="text-md font-semibold"></h4>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="update-pontos" class="block text-sm font-medium">Pontos</label><input type="number" id="update-pontos" class="form-input mt-1" min="0" value="0"></div>
                                <div><label for="update-premiacao" class="block text-sm font-medium">Pr√™mio ($)</label><input type="number" id="update-premiacao" class="form-input mt-1" min="0" value="0"></div>
                            </div>
                        </div>
                    </form>`;
            }
            const footer = torneio.status !== 'Finalizado' ? `<button id="win-match-btn" class="btn btn-secondary">Salvar Vit√≥ria</button><button id="lose-match-btn" class="btn btn-danger">Finalizar com Derrota</button>` : '';
            openModal(modalTitleHTML, body, footer);

            const handleUpdate = (result) => {
                 const form = document.getElementById('update-tournament-form');
                 const nextRoundName = form.querySelector('#next-round').value;
                 if (!nextRoundName) { alert('N√£o h√° mais fases neste torneio para selecionar.'); return; }
                 const adversario = form.querySelector('#next-adversario').value.trim(), placar = form.querySelector('#next-placar').value.trim();
                 if (!adversario || !placar) { alert('Preencha advers√°rio e placar.'); return; }
                 const isFinal = nextRoundName === 'Final';
                 const newMatch = { rodada: nextRoundName, adversario, nacionalidade: form.querySelector('#next-nacionalidade').value.trim().toUpperCase(), placar, resultado: result };
                 const updatedJogos = [...(torneio.jogos || []), newMatch];
                 let updatedData = { jogos: updatedJogos };
                 if (result === 'D' || (result === 'V' && isFinal)) {
                     updatedData = { ...updatedData, status: 'Finalizado', faseFinal: result === 'V' ? 'Campe√£o' : nextRoundName, pontos: Number(form.querySelector('#update-pontos').value) || 0, premiacao: Number(form.querySelector('#update-premiacao').value) || 0 };
                 }
                 updateTournamentInDb(torneioId, updatedData).then(closeModal);
            };
            const setupFinalizationUI = (isWin) => {
                const finalDetails = document.getElementById('final-details-update'), title = document.getElementById('final-title-update');
                if (finalDetails.classList.contains('hidden')) {
                    finalDetails.classList.remove('hidden');
                    title.textContent = isWin ? 'Finalizar (Campe√£o!)' : 'Finalizar com Derrota';
                    title.className = isWin ? 'text-md font-semibold text-amber-500' : 'text-md font-semibold text-red-600';
                    return false;
                } return true;
            };
            const winBtn = document.getElementById('win-match-btn'), loseBtn = document.getElementById('lose-match-btn');
            if(winBtn && loseBtn) {
                winBtn.addEventListener('click', () => {
                    const nextRound = document.getElementById('next-round').value;
                    if(nextRound === 'Final') { if (setupFinalizationUI(true)) handleUpdate('V'); } 
                    else { handleUpdate('V'); }
                });
                loseBtn.addEventListener('click', () => { if (setupFinalizationUI(false)) handleUpdate('D'); });
            }
        }
        function handleDetailsClick(e) {
            const button = e.target.closest('.details-btn'); if (!button) return;
            const { filterType, filterValue, view } = button.dataset;
            let originalTournaments;
            if (filterType === 'category') { originalTournaments = allTournaments.filter(t => t.tipo === filterValue); } 
            else if (filterType === 'surface') { originalTournaments = allTournaments.filter(t => t.superficie === filterValue); }
            if (view === 'titles') { originalTournaments = originalTournaments.filter(t => t.faseFinal === 'Campe√£o'); }
            const seasons = [...new Set(originalTournaments.map(t => t.ano))].sort((a,b) => b-a);
            const tournamentNames = [...new Set(originalTournaments.map(t => t.nome))].sort();
            const modalTitleText = view === 'titles' ? `T√≠tulos - ${filterValue}` : `Campanhas - ${filterValue}`;
            const body = `
                <div class="flex flex-wrap gap-4 mb-4 p-2 bg-slate-100 rounded-lg">
                    <div class="flex-1 min-w-[150px]"><label class="text-xs font-semibold">Torneio:</label><select id="modal-tournament-filter" class="form-select text-sm"><option value="all">Todos</option>${tournamentNames.map(n => `<option value="${n}">${n}</option>`).join('')}</select></div>
                    <div class="flex-1 min-w-[150px]"><label class="text-xs font-semibold">Temporada:</label><select id="modal-season-filter" class="form-select text-sm"><option value="all">Carreira</option>${seasons.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
                </div>
                <div id="modal-results-content" class="space-y-2"></div>`;
            openModal(modalTitleText, body);
            const renderModalContent = () => {
                const seasonFilter = document.getElementById('modal-season-filter').value;
                const tournamentFilter = document.getElementById('modal-tournament-filter').value;
                let filtered = originalTournaments;
                if (seasonFilter !== 'all') filtered = filtered.filter(t => t.ano == seasonFilter);
                if (tournamentFilter !== 'all') filtered = filtered.filter(t => t.nome === tournamentFilter);
                let contentHTML = '';
                if (filtered.length === 0) { contentHTML = '<p class="text-center p-4">Nenhum resultado para exibir.</p>'; } 
                else if (tournamentFilter !== 'all' && seasonFilter === 'all') {
                    let aggWins = 0, aggLosses = 0, aggTitles = 0;
                    filtered.forEach(t => {
                        aggWins += (t.jogos || []).filter(j => j.resultado === 'V').length;
                        aggLosses += (t.jogos || []).filter(j => j.resultado === 'D').length;
                        if (t.faseFinal === 'Campe√£o') aggTitles++;
                    });
                    contentHTML += `<div class="p-3 bg-slate-50 rounded-lg mb-4 text-center"><h4 class="font-bold">Resumo em ${tournamentFilter}</h4><p>${aggTitles} T√≠tulo(s) | ${aggWins}V / ${aggLosses}D</p></div>`;
                }
                contentHTML += filtered.map(t => {
                    const vitorias = (t.jogos || []).filter(j => j.resultado === 'V').length;
                    const derrotas = (t.jogos || []).filter(j => j.resultado === 'D').length;
                    return `<div class="p-3 border-b last:border-b-0"><p class="font-bold">${getFlagEmoji(t.paisTorneio)} ${t.ano} - ${t.nome}</p><p class="text-sm text-slate-600">Resultado: ${t.faseFinal} | Campanha: ${vitorias}V-${derrotas}D | Pr√™mio: ${formatCurrency(t.premiacao)}</p></div>`;
                }).join('');
                document.getElementById('modal-results-content').innerHTML = contentHTML;
            };
            document.getElementById('modal-season-filter').addEventListener('change', renderModalContent);
            document.getElementById('modal-tournament-filter').addEventListener('change', renderModalContent);
            renderModalContent();
        }
        
        // --- STATS CALCULATION & UI UPDATES ---
        function updateUI() {
            const stats = calculateAllStats();
            updateSeasonFilter(); 
            renderMainTable(); 
            updateStatsForSeason();
            updateStatsPanels(stats); 
            updateCharts(stats); 
            updateTabs(stats);
            updateOpponentList();
            updateRecordsTab(stats);
        }
        function calculateAllStats() {
            const stats = { 
                rankingPoints: 0, premiacao: 0, titulos: 0, vitoriasATP: 0, derrotasATP: 0, 
                porTipo: {}, porSuperficie: {}, titulosATP: 0, 
                maxTitulosUnicoTorneio: 0, nomeMaxTitulosUnicoTorneio: '-', maxTitulosEmUmAno: 0, 
                goldenSlamEvents: new Set(), grandSlamEvents: new Set(), 
                finaisATP: 0, finaisGrandSlam: 0,
                idadeMenorCampeaoGS: 0, idadeMaiorCampeaoGS: 0
            };
            tournamentTypes.forEach(t => { stats.porTipo[t] = { v: 0, d: 0, t: 0 }; });
            surfaces.forEach(s => { stats.porSuperficie[s] = { v: 0, d: 0, t: 0, atp_v: 0, atp_d: 0, atp_t: 0 }; });
            const oneYearAgo = new Date(); oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const titulosPorNome = {};
            const titulosPorAno = {};

            allTournaments.forEach(t => {
                stats.premiacao += Number(t.premiacao) || 0;
                if (t.dataFim && new Date(t.dataFim) >= oneYearAgo) { stats.rankingPoints += Number(t.pontos) || 0; }
                const vitorias = (t.jogos || []).filter(j => j.resultado === 'V').length;
                const derrotas = (t.jogos || []).filter(j => j.resultado === 'D').length;
                const isATP = t.tipo && !t.tipo.startsWith('CH');
                
                if (isATP) {
                    stats.vitoriasATP += vitorias;
                    stats.derrotasATP += derrotas;
                    if (t.faseFinal?.includes('Final') || t.faseFinal === 'Campe√£o') {
                        stats.finaisATP++;
                        if (t.tipo === 'Grand Slam') stats.finaisGrandSlam++;
                    }
                }
                
                if (t.faseFinal === 'Campe√£o') {
                    stats.titulos++;
                    titulosPorAno[t.ano] = (titulosPorAno[t.ano] || 0) + 1;
                    const nomeNormalizado = t.nome.toLowerCase();
                    titulosPorNome[nomeNormalizado] = (titulosPorNome[nomeNormalizado] || 0) + 1;
                    if (isATP) stats.titulosATP++;

                    const gsMap = { 'australian open': 'ao', 'roland garros': 'rg', 'wimbledon': 'w', 'us open': 'uo'};
                    const oly = 'jogos ol√≠mpicos';
                    if(gsMap[nomeNormalizado]) {
                        stats.grandSlamEvents.add(gsMap[nomeNormalizado]);
                        stats.goldenSlamEvents.add(gsMap[nomeNormalizado]);
                    }
                    if(nomeNormalizado === oly) stats.goldenSlamEvents.add('oly');
                    
                    if (t.tipo === 'Grand Slam' && t.dataFim) {
                        const idadeEmMeses = Math.floor((new Date(t.dataFim) - dataNascimentoJogador) / (1000 * 60 * 60 * 24 * 30.44));
                        if (!stats.idadeMenorCampeaoGS || idadeEmMeses < stats.idadeMenorCampeaoGS) {
                            stats.idadeMenorCampeaoGS = idadeEmMeses;
                        }
                        if (!stats.idadeMaiorCampeaoGS || idadeEmMeses > stats.idadeMaiorCampeaoGS) {
                            stats.idadeMaiorCampeaoGS = idadeEmMeses;
                        }
                    }
                }

                if (stats.porTipo[t.tipo]) { stats.porTipo[t.tipo].v += vitorias; stats.porTipo[t.tipo].d += derrotas; if (t.faseFinal === 'Campe√£o') stats.porTipo[t.tipo].t++; }
                if (stats.porSuperficie[t.superficie]) {
                    stats.porSuperficie[t.superficie].v += vitorias; stats.porSuperficie[t.superficie].d += derrotas;
                    if (isATP) { stats.porSuperficie[t.superficie].atp_v += vitorias; stats.porSuperficie[t.superficie].atp_d += derrotas; if(t.faseFinal === 'Campe√£o') stats.porSuperficie[t.superficie].atp_t++; }
                }
            });

            if (Object.keys(titulosPorNome).length > 0) {
                stats.maxTitulosUnicoTorneio = Math.max(...Object.values(titulosPorNome));
                stats.nomeMaxTitulosUnicoTorneio = Object.keys(titulosPorNome).find(key => titulosPorNome[key] === stats.maxTitulosUnicoTorneio);
            }
            if (Object.keys(titulosPorAno).length > 0) stats.maxTitulosEmUmAno = Math.max(...Object.values(titulosPorAno));
            return stats;
        }
        function updateStatsPanels(stats) {
            document.getElementById('ranking').textContent = `${estimarRanking(stats.rankingPoints)} (${stats.rankingPoints} pts)`;
            document.getElementById('premiacao').textContent = formatCurrency(stats.premiacao);
            document.getElementById('titulos-total').textContent = stats.titulos;
            document.getElementById('vitorias-derrotas').textContent = `${stats.vitoriasATP} / ${stats.derrotasATP}`;
        }
        function updateTabs(stats) {
             const titulosATP = Object.entries(stats.porTipo).filter(([key]) => key && !key.startsWith("CH")).reduce((sum, [, val]) => sum + val.t, 0);
             document.getElementById('titulos-total-resumo').textContent = titulosATP;
             document.getElementById('titulos-list').innerHTML = tournamentTypes.map(type => `<p class="flex justify-between items-center"><strong>${type}:</strong> <span>${stats.porTipo[type]?.t || 0} <button class="details-btn" data-filter-type="category" data-filter-value="${type}" data-view="titles" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></p>`).join('');
             document.getElementById('titulos-surface-list').innerHTML = surfaces.map(s => `<li class="flex justify-between items-center">${s}: <span>${stats.porSuperficie[s]?.atp_t || 0} <button class="details-btn" data-filter-type="surface" data-filter-value="${s}" data-view="titles" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></li>`).join('');
             document.getElementById('total-vitorias').textContent = stats.vitoriasATP;
             document.getElementById('total-derrotas').textContent = stats.derrotasATP;
             document.getElementById('taxa-vitorias').textContent = (stats.vitoriasATP + stats.derrotasATP > 0) ? `${((stats.vitoriasATP / (stats.vitoriasATP + stats.derrotasATP)) * 100).toFixed(1)}%` : '0%';
             document.getElementById('vitorias-list').innerHTML = tournamentTypes.map(type => `<div class="flex justify-between items-center">${type}: <span>${stats.porTipo[type]?.v || 0} / ${stats.porTipo[type]?.d || 0} <button class="details-btn" data-filter-type="category" data-filter-value="${type}" data-view="wins" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></div>`).join('');
             document.getElementById('vitorias-surface-list').innerHTML = surfaces.map(s => `<li class="flex justify-between items-center">${s}: <span>${stats.porSuperficie[s]?.atp_v || 0} / ${stats.porSuperficie[s]?.atp_d || 0} <button class="details-btn" data-filter-type="surface" data-filter-value="${s}" data-view="wins" title="Ver detalhes"><i class="fa-solid fa-eye"></i></button></span></li>`).join('');
        }
        function updateCharts(stats) {
             if (titulosChart) { titulosChart.data.datasets[0].data = tournamentTypes.map(t => stats.porTipo[t]?.t || 0); titulosChart.update(); }
             if (vitoriasChart) {
                vitoriasChart.data.datasets[0].data = surfaces.map(s => stats.porSuperficie[s]?.atp_v || 0);
                vitoriasChart.data.datasets[1].data = surfaces.map(s => stats.porSuperficie[s]?.atp_d || 0);
                vitoriasChart.update();
             }
        }
        function updateRecordsTab(stats) {
            const container = document.getElementById('recordes-conquistados');
            let html = worldRecords.map(record => {
                const playerValue = record.stat(stats);
                const isBroken = record.isLowerBetter ? (playerValue > 0 && playerValue < record.value) : (playerValue >= record.value);
                const progress = record.value > 0 ? Math.min((playerValue / record.value) * 100, 100) : (isBroken ? 100 : 0);
                return `
                <div class="glass-card p-4 rounded-lg ${isBroken ? 'bg-green-100/50 border-green-400' : 'bg-white/30'}">
                    <h4 class="font-bold text-md text-primary">${record.title} ${isBroken ? 'üèÜ' : ''}</h4>
                    <p class="text-xs text-slate-600 mt-1">Recorde: ${record.holder} (${record.format(record.value, {})})</p>
                    <p class="text-sm font-semibold mt-2">Progresso de Fernando: ${record.format(playerValue, stats)}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>`;
            }).join('');
            container.innerHTML = html || '<p class="text-gray-500 md:col-span-2">Nenhum recorde para exibir.</p>';
        }
        function renderMainTable() {
            const tableBody = document.getElementById('temporadas-tabela');
            const noDataMsg = document.getElementById('no-tournaments-msg');
            const season = document.getElementById('season-filter').value;
            const filtered = (season === 'all') ? allTournaments : allTournaments.filter(t => t.ano == season);
            filtered.sort((a, b) => new Date(b.dataInicio) - new Date(a.dataInicio));
            if (filtered.length === 0) { tableBody.innerHTML = ''; noDataMsg.style.display = 'block'; return; }
            noDataMsg.style.display = 'none';
            tableBody.innerHTML = filtered.map(t => `
                <tr class="border-b border-slate-200/50 hover:bg-slate-50/50" data-id="${t.id}">
                    <td class="py-3 px-1 sm:px-2 whitespace-nowrap">${t.dataInicio ? t.dataInicio.split('-').reverse().join('/') : 'N/A'}</td>
                    <td class="py-3 px-1 sm:px-2 font-semibold text-slate-700">
                        <span class="flex items-center">
                            ${getFlagEmoji(t.paisTorneio)} 
                            <span class="ml-2">${t.nome || ''}</span>
                            <span class="text-xs text-slate-500 ml-1">(${t.tipo || ''})</span>
                        </span>
                    </td>
                    <td class="py-3 px-1 sm:px-2">${t.superficie || 'N/A'}</td>
                    <td class="py-3 px-1 sm:px-2 text-center"><span class="px-2 py-1 text-xs font-bold rounded-full ${t.status === 'Finalizado' ? 'bg-slate-400 text-white' : 'bg-yellow-400 text-black'}">${t.status}</span></td>
                    <td class="py-3 px-1 sm:px-2 text-center"><span class="font-semibold text-green-600">${(t.jogos || []).filter(j => j.resultado === 'V').length}</span> / <span class="font-semibold text-red-600">${(t.jogos || []).filter(j => j.resultado === 'D').length}</span></td>
                    <td class="py-3 px-1 sm:px-2">${t.faseFinal || '-'}</td>
                    <td class="py-3 px-1 sm:px-2 text-center"><button class="delete-btn text-slate-400 hover:text-red-500" data-id="${t.id}" title="Excluir"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
            tableBody.querySelectorAll('tr').forEach(row => row.addEventListener('click', (e) => { if (!e.target.closest('.delete-btn')) openManageTournamentModal(row.dataset.id); }));
            tableBody.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); deleteTournamentFromDb(btn.dataset.id); }));
        }
        function updateSeasonFilter() {
             const anos = [...new Set(allTournaments.map(t => t.ano))].filter(Boolean).sort((a, b) => b - a);
             const select = document.getElementById('season-filter');
             const currentYear = new Date().getFullYear();
             select.innerHTML = `<option value="all">Todas</option>${anos.map(ano => `<option value="${ano}">${ano}</option>`).join('')}`;
             if (anos.includes(currentYear)) {
                 select.value = currentYear;
             } else if (anos.length > 0) {
                 select.value = anos[0];
             }
        }
        function updateStatsForSeason() {
            const season = document.getElementById('season-filter').value;
            if (!season) return;
            const filtered = (season === 'all') ? allTournaments : allTournaments.filter(t => t.ano == season);
            let vitoriasATP = 0, derrotasATP = 0, titulosATP = 0, premiacao = 0;
            filtered.forEach(t => {
                premiacao += Number(t.premiacao) || 0;
                const isATP = t.tipo && !t.tipo.startsWith('CH');
                if (isATP) {
                    vitoriasATP += (t.jogos || []).filter(j => j.resultado === 'V').length;
                    derrotasATP += (t.jogos || []).filter(j => j.resultado === 'D').length;
                    if(t.faseFinal === 'Campe√£o') titulosATP++;
                }
            });
            document.getElementById('temporadas-vitorias').textContent = vitoriasATP;
            document.getElementById('temporadas-derrotas').textContent = derrotasATP;
            document.getElementById('temporadas-titulos').textContent = titulosATP;
            document.getElementById('temporadas-premiacao').textContent = formatCurrency(premiacao);
        }
        // --- H2H FUNCTIONS ---
        function updateOpponentList() {
            const opponentMap = new Map();
            allTournaments.forEach(t => (t.jogos || []).forEach(j => {
                const normalized = j.adversario.trim().toLowerCase();
                if (!opponentMap.has(normalized)) {
                    opponentMap.set(normalized, j.adversario.trim());
                }
            }));
            allOpponentNames = [...opponentMap.values()].sort();
        }
        function handleH2hSearchInput() {
            const searchInput = document.getElementById('h2h-search');
            const suggestionsDiv = document.getElementById('h2h-suggestions');
            const query = searchInput.value.toLowerCase();
            if (!query) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            const suggestions = allOpponentNames.filter(op => op.toLowerCase().includes(query));
            if (suggestions.length > 0) {
                const isMobile = window.innerWidth < 768;
                suggestionsDiv.style.bottom = isMobile ? '100%' : 'auto';
                suggestionsDiv.style.top = isMobile ? 'auto' : '100%';
                suggestionsDiv.innerHTML = suggestions.map(op => `<div class="p-2 hover:bg-slate-100 cursor-pointer">${op}</div>`).join('');
                suggestionsDiv.classList.remove('hidden');
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        }
        function displayH2HResults() {
            const opponentName = document.getElementById('h2h-search').value.trim();
            const resultsDiv = document.getElementById('h2h-results');
            if (!opponentName) { resultsDiv.innerHTML = `<p class="text-center text-slate-500 py-8">Selecione um advers√°rio.</p>`; return; }
            let wins = 0, losses = 0; const matches = [];
            let opponentNationalityCode = '';
            allTournaments.forEach(t => {
                (t.jogos || []).forEach(j => {
                    if (j.adversario.trim().toLowerCase() === opponentName.toLowerCase()) {
                        if (j.resultado === 'V') wins++; else losses++;
                        if (j.nacionalidade && !opponentNationalityCode) opponentNationalityCode = j.nacionalidade;
                        matches.push({ ...t, ...j });
                    }
                });
            });
            matches.sort((a,b) => new Date(b.dataInicio) - new Date(a.dataInicio));
            let html = `<div class="text-center mb-6"><p class="text-xl md:text-2xl font-bold whitespace-nowrap">F. Lapa ${getFlagEmoji('BRA')} <span class="text-green-600">${wins}</span> x <span class="text-red-600">${losses}</span> ${opponentName} ${getFlagEmoji(opponentNationalityCode)}</p></div>`;
            if (matches.length > 0) {
                html += `
                    <div class="overflow-x-auto"><table class="w-full text-sm">
                        <thead class="text-xs uppercase bg-slate-100"><tr>
                            <th class="py-3 px-2 md:px-4 text-left">Ano</th><th class="py-3 px-2 md:px-4 text-left">Torneio</th>
                            <th class="py-3 px-2 md:px-4 text-left whitespace-nowrap">Tipo</th><th class="py-3 px-2 md:px-4 text-left">Rodada</th>
                            <th class="py-3 px-2 md:px-4 text-left">Superf√≠cie</th><th class="py-3 px-2 md:px-4 text-left whitespace-nowrap">Placar</th>
                            <th class="py-3 px-2 md:px-4 text-left">Resultado</th>
                        </tr></thead><tbody>
                        ${matches.map(m => `
                            <tr class="border-b odd:bg-white even:bg-slate-50">
                                <td class="py-3 px-2 md:px-4">${m.ano}</td>
                                <td class="py-3 px-2 md:px-4 font-semibold">${getFlagEmoji(m.paisTorneio)} ${m.nome}</td>
                                <td class="py-3 px-2 md:px-4 whitespace-nowrap">${abbreviateTournamentType(m.tipo)}</td>
                                <td class="py-3 px-2 md:px-4">${abbreviateRound(m.rodada)}</td>
                                <td class="py-3 px-2 md:px-4">${m.superficie}</td>
                                <td class="py-3 px-2 md:px-4 whitespace-nowrap">${m.placar}</td>
                                <td class="py-3 px-2 md:px-4 font-bold ${m.resultado === 'V' ? 'text-green-600' : 'text-red-600'}">${m.resultado === 'V' ? 'Vit√≥ria' : 'Derrota'}</td>
                            </tr>`).join('')}
                        </tbody></table></div>`;
            } else { html += `<p class="text-center text-slate-500 py-8">Nenhum confronto encontrado.</p>`; }
            resultsDiv.innerHTML = html;
        }
        // --- INITIALIZATION ---
        function initialize() {
            document.getElementById('create-tournament-btn').addEventListener('click', openCreateTournamentModal);
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.getElementById('season-filter').addEventListener('change', () => { renderMainTable(); updateStatsForSeason(); });
            const h2hSearch = document.getElementById('h2h-search');
            h2hSearch.addEventListener('input', handleH2hSearchInput);
            h2hSearch.addEventListener('change', displayH2HResults);
            document.getElementById('h2h-suggestions').addEventListener('click', (e) => {
                if (e.target.tagName === 'DIV') {
                    h2hSearch.value = e.target.textContent;
                    document.getElementById('h2h-suggestions').classList.add('hidden');
                    displayH2HResults();
                }
            });
            document.addEventListener('click', (e) => { if (!e.target.closest('.relative')) { document.getElementById('h2h-suggestions').classList.add('hidden'); }});
            document.getElementById('titulos-list').addEventListener('click', handleDetailsClick);
            document.getElementById('vitorias-list').addEventListener('click', handleDetailsClick);
            document.getElementById('titulos-surface-list').addEventListener('click', handleDetailsClick);
            document.getElementById('vitorias-surface-list').addEventListener('click', handleDetailsClick);

            const tabButtons = document.querySelectorAll('.tab-button'), tabContents = document.querySelectorAll('.tab-content');
            tabButtons.forEach(button => button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(button.dataset.tab).classList.add('active');
            }));
            const chartColors = ['#facc15', '#10b981', '#1e3a8a', '#22d3ee', '#f97316', '#8b5cf6', '#6b7280', '#a1a1aa', '#71717a', '#52525b', '#4b5563'];
            titulosChart = new Chart(document.getElementById('titulosChart').getContext('2d'), { type: 'pie', data: { labels: tournamentTypes, datasets: [{ data: [], backgroundColor: chartColors }] } });
            vitoriasChart = new Chart(document.getElementById('vitoriasChart').getContext('2d'), { type: 'bar', data: { labels: surfaces, datasets: [{ label: 'Vit√≥rias (ATP)', data: [], backgroundColor: '#10b981' }, { label: 'Derrotas (ATP)', data: [], backgroundColor: '#ef4444' }]}, options: { scales: { y: { beginAtZero: true } } } });
            loadTournamentsFromDb();
        }
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
