<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fernando Lapa - Tennis Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #06b6d4;
            --primary-hover: #0891b2;
            --secondary: #10b981;
            --secondary-hover: #059669;
            --accent: #fcd34d;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --background-deep: #0f172a;
            --card-base: #1e293b;
            --card-hover: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-subtle: #334155;
            --shadow-glow: 0 0 20px rgba(6, 182, 212, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            overflow-x: hidden;
            width: 100%;
            min-height: 100vh;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-deep);
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15), transparent 50%),
                radial-gradient(at 100% 100%, rgba(6, 182, 212, 0.1), transparent 50%);
            background-attachment: fixed;
            color: var(--text-main);
            line-height: 1.6;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--background-deep);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
        }

        @media (min-width: 1024px) {
            .main-container {
                grid-template-columns: 340px 1fr;
                gap: 2rem;
                padding: 2rem;
            }
        }

        .dashboard-card {
            background: var(--card-base);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow), 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .dashboard-card:hover::before {
            opacity: 1;
        }

        .stat-value {
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--text-main);
            letter-spacing: -0.025em;
        }

        .stat-label {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-nav-container {
            background: var(--card-base);
            border-radius: 1rem;
            padding: 0.5rem;
            border: 1px solid var(--border-subtle);
            display: flex;
            gap: 0.25rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .tab-nav-container::-webkit-scrollbar {
            display: none;
        }

        .tab-button {
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: 0.75rem;
            border: none;
            color: var(--text-muted);
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }

        .tab-button:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-button.active {
            color: var(--primary);
            background: rgba(6, 182, 212, 0.1);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }

        .tab-content {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .tab-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-subtle);
            background: var(--background-deep);
            color: var(--text-main);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }

        .btn:active::after {
            width: 200px;
            height: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #0ea5e9);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(6, 182, 212, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-hover), #0284c7);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(6, 182, 212, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #34d399);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--secondary-hover), #10b981);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #f87171);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, var(--danger-hover), #ef4444);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(239, 68, 68, 0.4);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-subtle);
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            border-color: var(--primary);
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th {
            background: var(--background-deep);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-subtle);
            transition: background 0.2s ease;
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .badge-warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .badge-info {
            background: rgba(6, 182, 212, 0.2);
            color: #22d3ee;
        }

        .skeleton {
            background: linear-gradient(90deg, var(--card-base) 25%, var(--border-subtle) 50%, var(--card-base) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 0.5rem;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background: var(--card-base);
            border: 1px solid var(--border-subtle);
            border-left: 4px solid var(--primary);
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-success { border-left-color: var(--secondary); }
        .toast-error { border-left-color: var(--danger); }
        .toast-warning { border-left-color: var(--accent); }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-base);
            border: 1px solid var(--border-subtle);
            border-radius: 1rem;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.95) translateY(10px);
            transition: all 0.3s ease;
        }

        .modal-backdrop.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--background-deep);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(90vh - 200px);
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background: var(--background-deep);
        }

        .accordion-item {
            border-bottom: 1px solid var(--border-subtle);
        }

        .accordion-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
            border-radius: 0.5rem;
        }

        .accordion-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion-content.open {
            max-height: 500px;
        }

        .accordion-icon {
            transition: transform 0.3s ease;
        }

        .accordion-item.open .accordion-icon {
            transform: rotate(180deg);
        }

        .search-container {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-input {
            padding-left: 2.5rem;
        }

        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-base);
            border: 1px solid var(--border-subtle);
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 20;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .suggestions-dropdown.active {
            display: block;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-subtle);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background: rgba(6, 182, 212, 0.1);
            color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .progress-container {
            background: var(--background-deep);
            border-radius: 9999px;
            height: 0.5rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.7s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .sublist {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .sublist.open {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }

        .toggle-sublist-btn {
            transition: transform 0.3s ease;
        }

        .toggle-sublist-btn.open {
            transform: rotate(45deg);
        }

        .data-row {
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background 0.2s ease;
        }

        .details-btn {
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        .data-row:hover .details-btn {
            opacity: 1;
        }

        /* NOVO: Estilos para o layout do confronto */
        .match-card {
            background: var(--background-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .match-card:hover {
            border-color: var(--primary);
            background: rgba(6, 182, 212, 0.05);
        }

        .player-vs-layout {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .player-box {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--card-base);
            border-radius: 0.5rem;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .player-box.winner {
            border-color: var(--secondary);
            background: rgba(16, 185, 129, 0.1);
        }

        .player-box.loser {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            opacity: 0.8;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #0ea5e9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .player-info {
            flex: 1;
            min-width: 0;
        }

        .player-name {
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-flag {
            font-size: 1.25rem;
        }

        .vs-divider {
            font-weight: 800;
            color: var(--text-muted);
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .match-details {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }

        .match-score {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: var(--text-main);
            background: var(--card-base);
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
        }

        .match-round {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tournament-header {
            background: linear-gradient(135deg, var(--card-base), var(--background-deep));
            border: 1px solid var(--border-subtle);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .tournament-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .tournament-meta {
            display: flex;
            gap: 1rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            flex-wrap: wrap;
        }

        .tournament-meta span {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        /* NOVO: Estilo para lista compacta de torneios no modal */
        .tournament-list-item {
            background: var(--background-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }

        .tournament-list-header {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .tournament-list-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .tournament-list-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .tournament-list-content.open {
            max-height: 2000px;
        }

        .tournament-list-icon {
            transition: transform 0.3s ease;
        }

        .tournament-list-item.open .tournament-list-icon {
            transform: rotate(180deg);
        }

        @media (max-width: 640px) {
            .player-vs-layout {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .player-box {
                width: 100%;
            }
            
            .vs-divider {
                transform: rotate(90deg);
            }
        }

        @media (max-width: 768px) {
            .stat-value {
                font-size: 1.25rem;
            }
            
            .tab-button {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            
            .data-table {
                font-size: 0.875rem;
            }
            
            .data-table th, .data-table td {
                padding: 0.75rem 0.5rem;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        :focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="space-y-6 animate-fade-in">
            <!-- Profile Card -->
            <div class="dashboard-card p-6 text-center">
                <div class="w-28 h-28 mx-auto mb-4 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center border-4 border-cyan-500/30 overflow-hidden shadow-xl relative group cursor-pointer">
                    <img src="https://ui-avatars.com/api/?name=Fernando+Lapa&background=06b6d4&color=fff&size=128&bold=true&rounded=true" 
                         alt="Fernando Lapa" 
                         class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">
                    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <i class="fas fa-camera text-white text-xl"></i>
                    </div>
                </div>
                
                <div class="flex items-center justify-center gap-2 mb-1">
                    <h1 class="text-2xl font-extrabold text-text-main">Fernando Lapa</h1>
                    <span id="mainFlag" class="text-2xl" title="Brasil">üáßüá∑</span>
                </div>
                
                <p class="text-sm font-medium text-text-muted mb-4">Tenista Profissional</p>
                
                <div class="mt-4 border-t border-border-subtle pt-4 text-xs text-text-muted space-y-2">
                    <div class="flex justify-center items-center gap-2">
                        <i class="fas fa-birthday-cake text-primary"></i>
                        <span>18/02/2011 (<span id="idade"></span> anos)</span>
                    </div>
                    <div class="flex justify-center items-center gap-2">
                        <i class="fas fa-map-marker-alt text-secondary"></i>
                        <span>Florian√≥polis, SC, Brasil</span>
                    </div>
                </div>
            </div>

            <!-- Key Stats Card -->
            <div class="dashboard-card p-6 space-y-4">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-lg font-bold text-text-main">Estat√≠sticas Chave</h2>
                    <button class="text-text-muted hover:text-primary transition-colors" onclick="refreshData()" title="Atualizar dados">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 rounded-lg bg-background-deep/50">
                        <span class="stat-label">
                            <i class="fas fa-trophy text-primary w-5"></i>
                            Ranking Atual
                        </span>
                        <span id="ranking" class="stat-value">Sem ranking</span>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 rounded-lg bg-background-deep/50">
                        <span class="stat-label">
                            <i class="fas fa-dollar-sign text-secondary w-5"></i>
                            Total em Pr√™mios
                        </span>
                        <span id="premiacao" class="stat-value text-secondary">$0.00</span>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 rounded-lg bg-background-deep/50">
                        <span class="stat-label">
                            <i class="fas fa-medal text-accent w-5"></i>
                            T√≠tulos ATP
                        </span>
                        <span id="titulosTotal" class="stat-value text-accent">0</span>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 rounded-lg bg-background-deep/50">
                        <span class="stat-label">
                            <i class="fas fa-exchange-alt text-red-400 w-5"></i>
                            V/D na Carreira
                        </span>
                        <span id="vitoriasDerrotas" class="stat-value">0 / 0</span>
                    </div>
                </div>
            </div>

            <!-- Ranking Analysis Card -->
            <div class="dashboard-card p-6 space-y-4">
                <h2 class="text-lg font-bold text-text-main mb-2">An√°lise de Ranking</h2>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 rounded-lg bg-background-deep/50">
                        <span class="stat-label">
                            <i class="fas fa-star text-primary w-5"></i>
                            Pontos Atuais
                        </span>
                        <span id="currentRankingPoints" class="stat-value">0 pts</span>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 rounded-lg bg-background-deep/50 border-l-4 border-red-500">
                        <span class="stat-label">
                            <i class="fas fa-shield-alt text-red-400 w-5"></i>
                            Pontos a Defender
                        </span>
                        <span id="pointsToDefend" class="stat-value text-red-400">0 pts</span>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 rounded-lg bg-background-deep/50 border-l-4 border-sky-400">
                        <span class="stat-label">
                            <i class="fas fa-chart-line text-sky-400 w-5"></i>
                            Proje√ß√£o
                        </span>
                        <span id="projectedRanking" class="stat-value text-sky-400">Sem Ranking</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="space-y-3">
                <button id="createTournamentBtn" class="btn btn-primary w-full text-lg py-4">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Novo Torneio
                </button>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportData()" class="btn btn-ghost w-full">
                        <i class="fas fa-download mr-2"></i>
                        Exportar
                    </button>
                    <label class="btn btn-ghost w-full cursor-pointer">
                        <i class="fas fa-upload mr-2"></i>
                        Importar
                        <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
                    </label>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="space-y-6 min-w-0 animate-fade-in" style="animation-delay: 0.1s;">
            <!-- Tab Navigation -->
            <div class="tab-nav-container" role="tablist">
                <button class="tab-button active" data-tab="temporadas" role="tab" aria-selected="true">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Temporadas</span>
                </button>
                <button class="tab-button" data-tab="titulos" role="tab" aria-selected="false">
                    <i class="fas fa-trophy"></i>
                    <span>T√≠tulos</span>
                </button>
                <button class="tab-button" data-tab="vitorias" role="tab" aria-selected="false">
                    <i class="fas fa-exchange-alt"></i>
                    <span>V/D</span>
                </button>
                <button class="tab-button" data-tab="h2h" role="tab" aria-selected="false">
                    <i class="fas fa-handshake"></i>
                    <span>H2H</span>
                </button>
                <button class="tab-button" data-tab="recordes" role="tab" aria-selected="false">
                    <i class="fas fa-medal"></i>
                    <span>Recordes</span>
                </button>
            </div>

            <!-- Tab Contents -->
            <div>
                <!-- Temporadas Tab -->
                <div id="temporadas" class="tab-content active" role="tabpanel">
                    <div class="dashboard-card p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                            <h2 class="text-2xl font-extrabold text-text-main">Hist√≥rico de Campanhas</h2>
                            
                            <div class="flex items-center gap-3 bg-background-deep p-2 rounded-lg border border-border-subtle">
                                <label for="seasonFilter" class="text-sm font-medium text-text-muted whitespace-nowrap">Temporada:</label>
                                <select id="seasonFilter" class="form-select w-auto min-w-[120px] bg-transparent border-none focus:ring-0">
                                    <option value="all">Todas</option>
                                </select>
                            </div>
                        </div>

                        <!-- Season Stats Summary -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-gradient-to-br from-secondary/20 to-secondary/5 p-4 rounded-xl border border-secondary/20 text-center">
                                <p class="text-xs text-text-muted uppercase tracking-wider mb-1">Vit√≥rias</p>
                                <p id="temporadasVitorias" class="text-2xl font-extrabold text-secondary">0</p>
                            </div>
                            <div class="bg-gradient-to-br from-red-500/20 to-red-500/5 p-4 rounded-xl border border-red-500/20 text-center">
                                <p class="text-xs text-text-muted uppercase tracking-wider mb-1">Derrotas</p>
                                <p id="temporadasDerrotas" class="text-2xl font-extrabold text-red-400">0</p>
                            </div>
                            <div class="bg-gradient-to-br from-accent/20 to-accent/5 p-4 rounded-xl border border-accent/20 text-center">
                                <p class="text-xs text-text-muted uppercase tracking-wider mb-1">T√≠tulos</p>
                                <p id="temporadasTitulos" class="text-2xl font-extrabold text-accent">0</p>
                            </div>
                            <div class="bg-gradient-to-br from-primary/20 to-primary/5 p-4 rounded-xl border border-primary/20 text-center">
                                <p class="text-xs text-text-muted uppercase tracking-wider mb-1">Premia√ß√£o</p>
                                <p id="temporadasPremiacao" class="text-lg font-extrabold text-primary">$0</p>
                            </div>
                        </div>

                        <!-- Tournaments Table -->
                        <div class="overflow-x-auto rounded-xl border border-border-subtle">
                            <table class="data-table min-w-[800px]">
                                <thead>
                                    <tr>
                                        <th class="rounded-tl-lg">Data</th>
                                        <th>Torneio</th>
                                        <th class="text-center">Tipo</th>
                                        <th class="text-center">Superf√≠cie</th>
                                        <th class="text-center">Status</th>
                                        <th class="text-center">Resultado</th>
                                        <th class="text-center rounded-tr-lg">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="temporadasTabela">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>

                        <div id="noTournamentsMsg" class="empty-state hidden">
                            <i class="fas fa-tennis-ball empty-state-icon"></i>
                            <p class="text-lg font-medium mb-2">Nenhum torneio encontrado</p>
                            <p class="text-sm">Clique em "Novo Torneio" para come√ßar a registrar sua carreira.</p>
                        </div>
                    </div>
                </div>

                <!-- T√≠tulos Tab -->
                <div id="titulos" class="tab-content" role="tabpanel">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="dashboard-card p-6">
                            <h2 class="text-2xl font-extrabold mb-6 text-text-main">Resumo de T√≠tulos</h2>
                            <p class="text-sm text-text-muted mb-4">O total abaixo contabiliza apenas t√≠tulos ATP (250+).</p>
                            <p class="font-extrabold text-2xl mb-6">Total de T√≠tulos (ATP): <span id="titulosTotalResumo" class="text-primary">0</span></p>
                            
                            <h3 class="text-lg font-bold mb-3 text-text-main border-b border-border-subtle pb-2">Por Categoria</h3>
                            <div id="titulosList" class="space-y-1 text-sm">
                                <!-- Dynamic content with details buttons -->
                            </div>
                            
                            <h3 class="font-bold mt-6 pt-4 border-t border-border-subtle text-lg text-text-main">Por Superf√≠cie (ATP):</h3>
                            <ul id="titulosSurfaceList" class="list-none pl-0 text-sm space-y-1 pt-2">
                                <!-- Dynamic content -->
                            </ul>
                        </div>
                        <div class="dashboard-card p-6 flex flex-col justify-center">
                            <h3 class="text-xl font-bold mb-4 text-text-main text-center">Distribui√ß√£o de T√≠tulos</h3>
                            <div class="relative h-64">
                                <canvas id="titulosChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vit√≥rias Tab -->
                <div id="vitorias" class="tab-content" role="tabpanel">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="dashboard-card p-6">
                            <h2 class="text-2xl font-extrabold mb-6 text-text-main">Vit√≥rias e Derrotas</h2>
                            <p class="text-sm text-text-muted mb-4">Apenas ATP 250+ (Challengers n√£o contam para estat√≠sticas por superf√≠cie).</p>
                            <p class="text-lg"><strong>Total (ATP):</strong> <span id="totalVitorias" class="text-secondary font-extrabold">0</span> V / <span id="totalDerrotas" class="text-red-400 font-extrabold">0</span> D</p>
                            <p class="text-lg"><strong>Taxa de Vit√≥rias (ATP):</strong> <span id="taxaVitorias" class="font-extrabold text-primary">0%</span></p>
                            
                            <h3 class="font-bold mt-6 pt-4 border-t border-border-subtle text-lg text-text-main border-b pb-2 mb-2">Por Tipo de Torneio</h3>
                            <div id="vitoriasList" class="text-sm space-y-1 mt-2">
                                <!-- Dynamic content with details buttons -->
                            </div>
                            
                            <h3 class="font-bold mt-6 pt-4 border-t border-border-subtle text-lg text-text-main border-b pb-2 mb-2">Por Superf√≠cie (ATP 250+)</h3>
                            <ul id="vitoriasSurfaceList" class="list-none pl-0 text-sm space-y-1 pt-2">
                                <!-- Dynamic content with details buttons -->
                            </ul>
                        </div>
                        <div class="dashboard-card p-6 flex flex-col justify-center">
                            <h3 class="text-xl font-bold mb-4 text-text-main text-center">Desempenho por Superf√≠cie</h3>
                            <div class="relative h-80">
                                <canvas id="vitoriasChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- H2H Tab -->
                <div id="h2h" class="tab-content" role="tabpanel">
                    <div class="dashboard-card p-6">
                        <h2 class="text-2xl font-extrabold mb-6 text-text-main">Head-to-Head (H2H)</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="md:col-span-2 search-container">
                                <label class="block text-sm font-medium text-text-muted mb-2">Pesquisar Advers√°rio</label>
                                <div class="relative">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" id="h2hSearch" class="form-input search-input" 
                                           placeholder="Digite o nome do advers√°rio..." autocomplete="off">
                                    <div id="h2hSuggestions" class="suggestions-dropdown"></div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-text-muted mb-2">Filtrar por Pa√≠s</label>
                                <select id="h2hCountryFilter" class="form-select">
                                    <option value="">Todos os pa√≠ses</option>
                                </select>
                            </div>
                        </div>

                        <div id="h2hResults" class="min-h-[200px]">
                            <div class="empty-state">
                                <i class="fas fa-users empty-state-icon"></i>
                                <p>Pesquise um advers√°rio ou selecione um pa√≠s para ver o hist√≥rico de confrontos.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recordes Tab -->
                <div id="recordes" class="tab-content" role="tabpanel">
                    <div class="dashboard-card p-6">
                        <h2 class="text-2xl font-extrabold mb-6 text-text-main">Recordes na Carreira</h2>
                        
                        <div class="mb-4 flex items-center gap-2 text-sm text-text-muted">
                            <i class="fas fa-info-circle"></i>
                            <span>Compare seus n√∫meros com os maiores recordes da hist√≥ria do t√™nis</span>
                        </div>

                        <div id="recordesConquistados" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="mainModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" class="text-xl font-bold text-text-main flex items-center gap-3"></h3>
                <button id="closeModalBtn" class="text-2xl text-text-muted hover:text-red-400 transition-colors w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-500/10">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalBody" class="modal-body"></div>
            <div id="modalFooter" class="modal-footer"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';

        // ==================== CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBIWmpJcoCiD3jTWROFcjSZDgXcxafsgtA",
            authDomain: "tenis-456fc.firebaseapp.com",
            projectId: "tenis-456fc",
            storageBucket: "tenis-456fc.appspot.com",
            messagingSenderId: "21965853527",
            appId: "1:21965853527:web:38a9edbe0eb2438679e412"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ==================== CONSTANTS & DATA ====================
        const TOURNAMENT_TYPES = [
            'Grand Slam', 'ATP Finals', 'Next Gen Finals', 'ATP Masters 1000', 'ATP 500', 'ATP 250',
            'Jogos Ol√≠mpicos', 'CH 175', 'CH 125', 'CH 100', 'CH 90', 'CH 75'
        ];
        
        const SURFACES = ['Saibro', 'R√°pida', 'Grama'];
        
        const ROUNDS_BY_TYPE = {
            'Grand Slam': ['R128', 'R64', 'R32', 'R16', 'QF', 'SF', 'F'],
            'ATP Masters 1000': ['R128', 'R64', 'R32', 'R16', 'QF', 'SF', 'F'],
            'ATP 500': ['R32', 'R16', 'QF', 'SF', 'F'],
            'ATP 250': ['R32', 'R16', 'QF', 'SF', 'F'],
            'Jogos Ol√≠mpicos': ['R32', 'R16', 'QF', 'SF', 'Bronze', 'F'],
            'ATP Finals': ['RR1', 'RR2', 'RR3', 'SF', 'F'],
            'Next Gen Finals': ['RR1', 'RR2', 'RR3', 'RR4', 'SF', 'F'],
            'CH 175': ['R32', 'R16', 'QF', 'SF', 'F'],
            'CH 125': ['R32', 'R16', 'QF', 'SF', 'F'],
            'CH 100': ['R32', 'R16', 'QF', 'SF', 'F'],
            'CH 90': ['R32', 'R16', 'QF', 'SF', 'F'],
            'CH 75': ['R32', 'R16', 'QF', 'SF', 'F'],
            'Default': ['R128', 'R64', 'R32', 'R16', 'QF', 'SF', 'F']
        };

        const MAJOR_COUNTRIES = [
            "ARG", "AUS", "AUT", "BEL", "BRA", "CAN", "CHI", "CHN", "COL", "CRO",
            "CZE", "DEN", "ECU", "ESP", "FIN", "FRA", "GBR", "GER", "GRE", "HUN",
            "IND", "ITA", "JPN", "KAZ", "KOR", "MEX", "NED", "NOR", "NZL", "PER",
            "POL", "POR", "ROU", "RSA", "RUS", "SRB", "SUI", "SVK", "SWE", "TPE",
            "TUR", "UKR", "URU", "USA"
        ];

        const IOC_TO_ISO2 = {
            'AFG':'AF','ALB':'AL','ALG':'DZ','AND':'AD','ANG':'AO','ANT':'AG','ARG':'AR','ARM':'AM','ARU':'AW',
            'AUS':'AU','AUT':'AT','AZE':'AZ','BAH':'BS','BRN':'BH','BAN':'BD','BAR':'BB','BLR':'BY','BEL':'BE',
            'BIZ':'BZ','BEN':'BJ','BER':'BM','BHU':'BT','BOL':'BO','BIH':'BA','BOT':'BW','BRA':'BR','IVB':'VG',
            'BRU':'BN','BUL':'BG','BUR':'BF','BDI':'BI','CAM':'KH','CMR':'CM','CAN':'CA','CAY':'KY','CAF':'CF',
            'CHA':'TD','CHI':'CL','CHN':'CN','TPE':'TW','COL':'CO','COM':'KM','CGO':'CG','COD':'CD','COK':'CK',
            'CRC':'CR','CIV':'CI','CRO':'HR','CUB':'CU','CYP':'CY','CZE':'CZ','DEN':'DK','DJI':'DJ','DMA':'DM',
            'DOM':'DO','ECU':'EC','EGY':'EG','ESA':'SV','GEQ':'GQ','ERI':'ER','EST':'EE','SWZ':'SZ','ETH':'ET',
            'FIJ':'FJ','FIN':'FI','FRA':'FR','GAB':'GA','GAM':'GM','GEO':'GE','GER':'DE','GHA':'GH','GBR':'GB',
            'GRE':'GR','GRN':'GD','GUM':'GU','GUA':'GT','GUI':'GN','GBS':'GW','GUY':'GY','HAI':'HT','HON':'HN',
            'HKG':'HK','HUN':'HU','ISL':'IS','IND':'IN','INA':'ID','IRI':'IR','IRQ':'IQ','IRL':'IE','ISR':'IL',
            'ITA':'IT','JAM':'JM','JOR':'JO','KAZ':'KZ','KEN':'KE','KIR':'KI','PRK':'KP','KOR':'KR','KUW':'KW',
            'KGZ':'KG','LAO':'LA','LAT':'LV','LIB':'LB','LES':'LS','LBR':'LR','LBA':'LY','LIE':'LI','LTU':'LT',
            'LUX':'LU','MAD':'MG','MAW':'MW','MAS':'MY','MDV':'MV','MLI':'ML','MLT':'MT','MHL':'MH','MTN':'MR',
            'MRI':'MU','MEX':'MX','FSM':'FM','MDA':'MD','MON':'MC','MGL':'MN','MNE':'ME','MAR':'MA','MOZ':'MZ',
            'MYA':'MM','NAM':'NA','NRU':'NR','NEP':'NP','NED':'NL','NZL':'NZ','NCA':'NI','NIG':'NE','NGR':'NG',
            'MKD':'MK','NOR':'NO','OMA':'OM','PAK':'PK','PLW':'PW','PLE':'PS','PAN':'PA','PNG':'PG','PAR':'PY',
            'PER':'PE','PHI':'PH','POL':'PL','POR':'PT','PUR':'PR','QAT':'QA','ROU':'RO','RUS':'RU','RWA':'RW',
            'SKN':'KN','LCA':'LC','VIN':'VC','SAM':'WS','SMR':'SM','STP':'ST','KSA':'SA','SEN':'SN','SRB':'RS',
            'SEY':'SC','SLE':'SL','SGP':'SG','SVK':'SK','SLO':'SI','SOL':'SB','SOM':'SO','RSA':'ZA','ESP':'ES',
            'SRI':'LK','SUD':'SD','SUR':'SR','SWE':'SE','SUI':'CH','SYR':'SY','TAN':'TZ','THA':'TH','TLS':'TL',
            'TOG':'TG','TGA':'TO','TTO':'TT','TUN':'TN','TUR':'TR','TKM':'TM','TUV':'TV','UGA':'UG','UKR':'UA',
            'UAE':'AE','USA':'US','URU':'UY','UZB':'UZ','VAN':'VU','VEN':'VE','VIE':'VN','ISV':'VI','YEM':'YE',
            'ZAM':'ZM','ZIM':'ZW'
        };

        const WORLD_RECORDS = [
            { id: 'weeksAtNo1', title: 'Semanas como N¬∫ 1', holder: 'Novak Djokovic', value: 428, format: v => `${v} sem` },
            { id: 'consecutiveWeeks', title: 'Semanas consecutivas N¬∫ 1', holder: 'Roger Federer', value: 237, format: v => `${v} sem` },
            { id: 'yearEndNo1', title: 'Finais de ano como N¬∫ 1', holder: 'Novak Djokovic', value: 8, format: v => `${v}x` },
            { id: 'grandSlams', title: 'T√≠tulos de Grand Slam', holder: 'Novak Djokovic', value: 24, stat: s => s.porTipo?.['Grand Slam']?.titulos || 0, format: v => `${v}` },
            { id: 'masters1000', title: 'T√≠tulos Masters 1000', holder: 'Novak Djokovic', value: 40, stat: s => s.porTipo?.['ATP Masters 1000']?.titulos || 0, format: v => `${v}` },
            { id: 'atpFinals', title: 'T√≠tulos ATP Finals', holder: 'Novak Djokovic', value: 7, stat: s => s.porTipo?.['ATP Finals']?.titulos || 0, format: v => `${v}` },
            { id: 'careerTitles', title: 'T√≠tulos na carreira (ATP)', holder: 'Jimmy Connors', value: 109, stat: s => s.titulosATP || 0, format: v => `${v}` },
            { id: 'matchWins', title: 'Vit√≥rias na carreira (ATP)', holder: 'Jimmy Connors', value: 1274, stat: s => s.vitoriasATP || 0, format: v => `${v}` },
            { id: 'prizeMoney', title: 'Premia√ß√£o total', holder: 'Novak Djokovic', value: 184000000, stat: s => s.premiacao || 0, format: v => formatCurrency(v) },
            { id: 'winPercentage', title: '% de vit√≥rias (min. 200 jogos)', holder: 'Novak Djokovic', value: 83.9, stat: s => {
                const total = (s.vitoriasATP || 0) + (s.derrotasATP || 0);
                return total > 200 ? ((s.vitoriasATP / total) * 100) : 0;
            }, format: v => v > 0 ? `${v.toFixed(1)}%` : 'N/A' },
            { id: 'clayTitles', title: 'T√≠tulos no saibro', holder: 'Rafael Nadal', value: 63, stat: s => s.porSuperficie?.['Saibro']?.titulosATP || 0, format: v => `${v}` },
            { id: 'hardTitles', title: 'T√≠tulos em quadra r√°pida', holder: 'Novak Djokovic', value: 71, stat: s => s.porSuperficie?.['R√°pida']?.titulosATP || 0, format: v => `${v}` }
        ];

        // ==================== STATE MANAGEMENT ====================
        let allTournaments = [];
        let charts = {};
        let allOpponents = [];
        let availableCountries = new Set();
        const playerBirthDate = new Date('2011-02-18');
        const CURRENT_YEAR = new Date().getFullYear(); // Ano atual para filtro padr√£o

        // ==================== UTILITY FUNCTIONS ====================
        function showLoading(show = true) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            toast.innerHTML = `
                <i class="fas fa-${icons[type]} text-${type === 'success' ? 'secondary' : type === 'error' ? 'danger' : type === 'warning' ? 'accent' : 'primary'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value || 0);
        }

        function getFlagEmoji(iocCode) {
            if (!iocCode || iocCode.length < 2) return '';
            const code = iocCode.toUpperCase();
            const iso2 = IOC_TO_ISO2[code] || (code.length === 2 ? code : '');
            if (!iso2) return '';
            return iso2.toUpperCase().split('').map(char => 
                String.fromCodePoint(char.charCodeAt(0) + 127397)
            ).join('');
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function abbreviateType(type) {
            const map = {
                'Grand Slam': 'GS',
                'ATP Finals': 'Finals',
                'Next Gen Finals': 'NextGen',
                'ATP Masters 1000': 'M1000',
                'Jogos Ol√≠mpicos': 'Olympics'
            };
            return map[type] || type.replace('ATP ', '').replace('CH ', 'CH');
        }

        function calculateAge() {
            const today = new Date();
            let age = today.getFullYear() - playerBirthDate.getFullYear();
            const m = today.getMonth() - playerBirthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < playerBirthDate.getDate())) age--;
            document.getElementById('idade').textContent = age;
        }

        // ==================== RANKING ATP REAL (BASEADO EM PONTOS) ====================
        // Sistema ATP: Ranking √© determinado pela soma dos pontos dos 19 melhores torneios
        // A posi√ß√£o √© calculada comparando-se com a distribui√ß√£o real de pontos do ranking ATP
        
        function calculateATPRanking(points) {
            if (points <= 0) return { position: 'Sem Ranking', exact: 0, points: 0 };
            
            // Tabela de refer√™ncia ATP baseada na distribui√ß√£o real de pontos (2024/2025)
            // Cada entrada representa: [posi√ß√£o, pontos m√≠nimos necess√°rios]
            const atpRankingTable = [
                [1, 11000],      // Top 3 (Sinner, Alcaraz, Djokovic)
                [2, 10000],
                [3, 8500],
                [4, 7500],       // Zverev ~7500
                [5, 6500],       // Top 10
                [6, 5800],
                [7, 5200],
                [8, 4800],
                [9, 4500],
                [10, 4200],
                [11, 3900],      // Top 20 (Medvedev ~4000)
                [12, 3600],
                [13, 3400],
                [14, 3200],
                [15, 3000],
                [16, 2850],
                [17, 2700],
                [18, 2550],
                [19, 2400],
                [20, 2250],      // Rublev ~2300
                [25, 1850],      // Top 30
                [30, 1550],
                [35, 1300],
                [40, 1100],      // Cilic ~1100
                [45, 950],
                [50, 800],       // Korda ~1020
                [55, 700],       // Top 60
                [60, 600],
                [65, 520],
                [70, 450],
                [75, 390],
                [80, 340],       // Hanfmann ~695, Comesa√±a ~694
                [85, 290],
                [90, 250],
                [95, 210],
                [100, 180],      // Top 100
                [110, 140],
                [120, 110],
                [130, 85],
                [140, 65],
                [150, 50],
                [175, 30],
                [200, 18],
                [250, 10],
                [300, 5],
                [400, 2],
                [500, 1]
            ];

            // Encontrar posi√ß√£o baseada nos pontos
            let position = 500;
            let exactPos = 500;
            
            for (let i = 0; i < atpRankingTable.length; i++) {
                const [pos, minPoints] = atpRankingTable[i];
                
                if (points >= minPoints) {
                    exactPos = pos;
                    position = pos;
                    
                    // Interpolar entre posi√ß√µes se estiver no meio
                    if (i > 0) {
                        const [prevPos, prevMin] = atpRankingTable[i - 1];
                        const range = prevMin - minPoints;
                        const progress = (points - minPoints) / range;
                        const posDiff = prevPos - pos;
                        exactPos = pos + (posDiff * (1 - progress));
                    }
                    break;
                }
            }
            
            // Se tem menos pontos que o #500
            if (points < 1) {
                exactPos = 500 + Math.floor((1 - points) * 10);
                position = exactPos;
            }

            // Formatar posi√ß√£o
            let positionStr;
            if (exactPos <= 1) positionStr = '#1';
            else if (exactPos <= 10) positionStr = `#${Math.round(exactPos)}`;
            else if (exactPos <= 100) positionStr = `#${Math.round(exactPos)}`;
            else positionStr = `#${Math.round(exactPos)}`;

            return { 
                position: positionStr, 
                exact: Math.round(exactPos),
                points: points
            };
        }

        // ==================== MODAL SYSTEM ====================
        const modal = {
            element: document.getElementById('mainModal'),
            title: document.getElementById('modalTitle'),
            body: document.getElementById('modalBody'),
            footer: document.getElementById('modalFooter'),
            
            open(title, bodyHTML, footerHTML = '') {
                this.title.innerHTML = title;
                this.body.innerHTML = bodyHTML;
                this.footer.innerHTML = footerHTML;
                this.element.classList.add('active');
                document.body.style.overflow = 'hidden';
            },
            
            close() {
                this.element.classList.remove('active');
                document.body.style.overflow = '';
            }
        };

        document.getElementById('closeModalBtn').addEventListener('click', () => modal.close());
        modal.element.addEventListener('click', (e) => {
            if (e.target === modal.element) modal.close();
        });

        // ==================== DATA OPERATIONS ====================
        async function loadTournaments() {
            showLoading(true);
            try {
                const q = query(collection(db, 'torneios'), orderBy('dataInicio', 'desc'));
                const snapshot = await getDocs(q);
                allTournaments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                updateUI();
                showToast(`${allTournaments.length} torneios carregados`, 'success');
            } catch (error) {
                console.error('Erro ao carregar:', error);
                showToast('Erro ao carregar dados. Verifique sua conex√£o.', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function saveTournament(data) {
            showLoading(true);
            try {
                const docRef = await addDoc(collection(db, 'torneios'), data);
                allTournaments.unshift({ id: docRef.id, ...data });
                updateUI();
                modal.close();
                showToast('Torneio criado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showToast('Erro ao salvar torneio', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function updateTournament(id, data) {
            showLoading(true);
            try {
                await updateDoc(doc(db, 'torneios', id), data);
                const index = allTournaments.findIndex(t => t.id === id);
                if (index > -1) {
                    allTournaments[index] = { ...allTournaments[index], ...data };
                }
                updateUI();
                showToast('Torneio atualizado!', 'success');
            } catch (error) {
                console.error('Erro ao atualizar:', error);
                showToast('Erro ao atualizar', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteTournament(id) {
            if (!confirm('Tem certeza que deseja excluir este torneio permanentemente?')) return;
            
            showLoading(true);
            try {
                await deleteDoc(doc(db, 'torneios', id));
                allTournaments = allTournaments.filter(t => t.id !== id);
                updateUI();
                showToast('Torneio exclu√≠do', 'success');
            } catch (error) {
                console.error('Erro ao excluir:', error);
                showToast('Erro ao excluir', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== CALCULATIONS ====================
        function calculateStats() {
            const stats = {
                premiacao: 0,
                titulosATP: 0,
                titulosChallenger: 0,
                titulosGrandSlam: 0,
                titulosMasters: 0,
                vitoriasATP: 0,
                derrotasATP: 0,
                finaisATP: 0,
                finaisVencidas: 0,
                porTipo: {},
                porSuperficie: {},
                pontosRanking: 0,
                pontosDefender: 0,
                melhorSequencia: 0,
                sequenciaAtual: 0
            };

            TOURNAMENT_TYPES.forEach(t => {
                stats.porTipo[t] = { vitorias: 0, derrotas: 0, titulos: 0, jogos: 0 };
            });
            SURFACES.forEach(s => {
                stats.porSuperficie[s] = { vitorias: 0, derrotas: 0, titulos: 0, titulosATP: 0, jogos: 0 };
            });

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentWeek = getWeekNumber(today);
            let sequenciaAtual = 0;
            let melhorSequencia = 0;

            const sortedTournaments = [...allTournaments].sort((a, b) => 
                new Date(a.dataInicio) - new Date(b.dataInicio)
            );

            sortedTournaments.forEach(t => {
                const jogos = t.jogos || [];
                const vitorias = jogos.filter(j => j.resultado === 'V').length;
                const derrotas = jogos.filter(j => j.resultado === 'D').length;
                const isATP = !t.tipo?.startsWith('CH');
                const isFinal = t.faseFinal === 'Campe√£o' || t.faseFinal?.includes('Final');

                stats.premiacao += Number(t.premiacao) || 0;

                if (isATP) {
                    stats.vitoriasATP += vitorias;
                    stats.derrotasATP += derrotas;
                    
                    jogos.forEach(jogo => {
                        if (jogo.resultado === 'V') {
                            sequenciaAtual++;
                            melhorSequencia = Math.max(melhorSequencia, sequenciaAtual);
                        } else if (jogo.resultado === 'D') {
                            sequenciaAtual = 0;
                        }
                    });

                    if (isFinal) {
                        stats.finaisATP++;
                        if (t.faseFinal === 'Campe√£o') stats.finaisVencidas++;
                    }

                    if (t.faseFinal === 'Campe√£o') {
                        stats.titulosATP++;
                        if (t.tipo === 'Grand Slam') stats.titulosGrandSlam++;
                        if (t.tipo === 'ATP Masters 1000') stats.titulosMasters++;
                    }
                } else if (t.faseFinal === 'Campe√£o') {
                    stats.titulosChallenger++;
                }

                if (stats.porTipo[t.tipo]) {
                    stats.porTipo[t.tipo].vitorias += vitorias;
                    stats.porTipo[t.tipo].derrotas += derrotas;
                    stats.porTipo[t.tipo].jogos += vitorias + derrotas;
                    if (t.faseFinal === 'Campe√£o') stats.porTipo[t.tipo].titulos++;
                }

                // CORRE√á√ÉO: Apenas ATP 250+ contam para estat√≠sticas por superf√≠cie
                if (stats.porSuperficie[t.superficie]) {
                    // Sempre conta jogos totais
                    stats.porSuperficie[t.superficie].jogos += vitorias + derrotas;
                    
                    // Apenas ATP 250+ conta para vit√≥rias/derrotas/t√≠tulos por superf√≠cie
                    if (isATP) {
                        stats.porSuperficie[t.superficie].vitorias += vitorias;
                        stats.porSuperficie[t.superficie].derrotas += derrotas;
                        if (t.faseFinal === 'Campe√£o') {
                            stats.porSuperficie[t.superficie].titulos++;
                            stats.porSuperficie[t.superficie].titulosATP++;
                        }
                    }
                }

                const pontos = Number(t.pontos) || 0;
                if (pontos > 0) {
                    const tDate = new Date(t.dataInicio);
                    const tWeek = getWeekNumber(tDate);
                    const tYear = tDate.getFullYear();
                    
                    if (tYear === currentYear - 1 && tWeek === currentWeek) {
                        stats.pontosDefender += pontos;
                    }
                }
            });

            stats.melhorSequencia = melhorSequencia;
            stats.sequenciaAtual = sequenciaAtual;
            
            // ATP: Soma dos 19 melhores resultados (ou 18 + ATP Finals)
            const allPoints = allTournaments
                .map(t => Number(t.pontos) || 0)
                .filter(p => p > 0)
                .sort((a, b) => b - a)
                .slice(0, 19);
            stats.pontosRanking = allPoints.reduce((a, b) => a + b, 0);

            return stats;
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            const stats = calculateStats();
            const season = document.getElementById('seasonFilter').value;
            
            updateSidebar(stats);
            updateSeasonsTab(stats, season);
            updateTitulosTab(stats);
            updateVitoriasTab(stats);
            updateH2HTab();
            updateRecordsTab(stats);
            updateCharts(stats);
        }

        function updateSidebar(stats) {
            const ranking = calculateATPRanking(stats.pontosRanking);
            document.getElementById('ranking').textContent = `${ranking.position} (${stats.pontosRanking.toLocaleString()} pts)`;
            document.getElementById('premiacao').textContent = formatCurrency(stats.premiacao);
            document.getElementById('titulosTotal').textContent = stats.titulosATP;
            document.getElementById('vitoriasDerrotas').textContent = `${stats.vitoriasATP} / ${stats.derrotasATP}`;
            
            document.getElementById('currentRankingPoints').textContent = `${stats.pontosRanking.toLocaleString()} pts`;
            document.getElementById('pointsToDefend').textContent = `${stats.pontosDefender.toLocaleString()} pts`;
            
            const projected = Math.max(0, stats.pontosRanking - stats.pontosDefender);
            const projectedRank = calculateATPRanking(projected);
            document.getElementById('projectedRanking').textContent = `${projectedRank.position} (${projected.toLocaleString()} pts)`;
        }

        function updateSeasonsTab(stats, season) {
            const filtered = season === 'all' 
                ? allTournaments 
                : allTournaments.filter(t => t.ano == season);
            
            const years = [...new Set(allTournaments.map(t => t.ano))].sort((a, b) => b - a);
            const select = document.getElementById('seasonFilter');
            const currentVal = select.value;
            
            // Preencher op√ß√µes
            select.innerHTML = '<option value="all">Todas as temporadas</option>' + 
                years.map(y => `<option value="${y}">${y}</option>`).join('');
            
            // Se n√£o houver valor selecionado, definir como ano atual
            if (!currentVal || currentVal === 'all') {
                // Verificar se o ano atual existe nos dados, sen√£o pegar o mais recente
                if (years.includes(CURRENT_YEAR)) {
                    select.value = CURRENT_YEAR;
                } else if (years.length > 0) {
                    select.value = years[0]; // Mais recente
                } else {
                    select.value = 'all';
                }
            } else {
                select.value = currentVal;
            }
            
            // Recalcular filtered com o valor definido
            const finalSeason = select.value;
            const finalFiltered = finalSeason === 'all' 
                ? allTournaments 
                : allTournaments.filter(t => t.ano == finalSeason);

            let vitorias = 0, derrotas = 0, titulos = 0, premiacao = 0;
            finalFiltered.forEach(t => {
                const isATP = !t.tipo?.startsWith('CH');
                if (isATP) {
                    vitorias += (t.jogos || []).filter(j => j.resultado === 'V').length;
                    derrotas += (t.jogos || []).filter(j => j.resultado === 'D').length;
                    if (t.faseFinal === 'Campe√£o') titulos++;
                }
                premiacao += Number(t.premiacao) || 0;
            });

            document.getElementById('temporadasVitorias').textContent = vitorias;
            document.getElementById('temporadasDerrotas').textContent = derrotas;
            document.getElementById('temporadasTitulos').textContent = titulos;
            document.getElementById('temporadasPremiacao').textContent = formatCurrency(premiacao);

            const tbody = document.getElementById('temporadasTabela');
            const noData = document.getElementById('noTournamentsMsg');
            
            if (finalFiltered.length === 0) {
                tbody.innerHTML = '';
                noData.classList.remove('hidden');
                return;
            }
            
            noData.classList.add('hidden');
            tbody.innerHTML = finalFiltered.map(t => {
                const v = (t.jogos || []).filter(j => j.resultado === 'V').length;
                const d = (t.jogos || []).filter(j => j.resultado === 'D').length;
                const isChampion = t.faseFinal === 'Campe√£o';
                
                return `
                    <tr class="group cursor-pointer" onclick="window.openTournamentModal('${t.id}')">
                        <td class="whitespace-nowrap">
                            <div class="text-xs text-text-muted">${new Date(t.dataInicio).toLocaleDateString('pt-BR')}</div>
                            <div class="text-xs text-text-muted">${new Date(t.dataFim).toLocaleDateString('pt-BR')}</div>
                        </td>
                        <td>
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${getFlagEmoji(t.paisTorneio)}</span>
                                <div>
                                    <div class="font-semibold text-text-main">${t.nome}</div>
                                    <div class="text-xs text-text-muted">${t.tipo}</div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge ${t.tipo?.includes('Grand Slam') ? 'badge-warning' : t.tipo?.startsWith('CH') ? 'badge-info' : 'badge-success'}">
                                ${abbreviateType(t.tipo)}
                            </span>
                        </td>
                        <td class="text-center text-text-muted">${t.superficie}</td>
                        <td class="text-center">
                            <span class="badge ${t.status === 'Finalizado' ? 'badge-success' : 'badge-warning'}">
                                ${t.status === 'Finalizado' ? '‚úì Finalizado' : '‚è≥ Em andamento'}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="flex items-center justify-center gap-2">
                                <span class="text-secondary font-bold">${v}</span>
                                <span class="text-text-muted">/</span>
                                <span class="text-red-400 font-bold">${d}</span>
                            </div>
                            <div class="text-xs ${isChampion ? 'text-accent font-bold' : 'text-text-muted'} mt-1">
                                ${t.faseFinal || '-'}
                            </div>
                        </td>
                        <td class="text-center">
                            <button onclick="event.stopPropagation(); window.deleteTournament('${t.id}')" 
                                    class="w-8 h-8 rounded-full hover:bg-red-500/20 text-text-muted hover:text-red-400 transition-colors">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== T√çTULOS TAB ====================
        function updateTitulosTab(stats) {
            document.getElementById('titulosTotalResumo').textContent = stats.titulosATP;

            const atpTypes = TOURNAMENT_TYPES.filter(t => !t.startsWith('CH'));
            document.getElementById('titulosList').innerHTML = atpTypes.map(type => {
                const count = stats.porTipo[type]?.titulos || 0;
                return `
                    <p class="flex justify-between items-center data-row hover:bg-card-hover">
                        <strong>${type}:</strong> 
                        <span>
                            ${count} 
                            <button class="details-btn text-primary hover:text-accent ml-2" 
                                    onclick="showDetails('category', '${type}', 'titles')" 
                                    title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                        </span>
                    </p>
                `;
            }).join('') + `
                <div class="mt-2">
                    <p class="flex justify-between items-center data-row hover:bg-card-hover">
                        <strong>Challengers:</strong> 
                        <span>
                            ${stats.titulosChallenger} 
                            <button class="details-btn text-primary hover:text-accent ml-2" 
                                    onclick="showDetails('category', 'CH', 'titles')" 
                                    title="Ver detalhes de todos os Challengers">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="toggle-sublist-btn text-primary hover:text-accent ml-1" 
                                    onclick="toggleSublist('ch-titles-sublist', this)" 
                                    title="Expandir">
                                <i class="fas fa-plus"></i>
                            </button>
                        </span>
                    </p>
                    <div id="ch-titles-sublist" class="sublist pl-4 space-y-1 mt-1">
                        ${TOURNAMENT_TYPES.filter(t => t.startsWith('CH')).map(type => `
                            <p class="flex justify-between items-center text-xs text-text-muted hover:bg-card-hover p-1 rounded">
                                <em>${type}:</em> 
                                <span>${stats.porTipo[type]?.titulos || 0}</span>
                            </p>
                        `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('titulosSurfaceList').innerHTML = SURFACES.map(surface => `
                <li class="flex justify-between items-center py-1 data-row hover:bg-card-hover">
                    <span>${surface}:</span> 
                    <span>
                        ${stats.porSuperficie[surface]?.titulosATP || 0} 
                        <button class="details-btn text-primary hover:text-accent ml-2" 
                                onclick="showDetails('surface', '${surface}', 'titles')" 
                                title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                    </span>
                </li>
            `).join('');
        }

        // ==================== VIT√ìRIAS TAB ====================
        function updateVitoriasTab(stats) {
            document.getElementById('totalVitorias').textContent = stats.vitoriasATP;
            document.getElementById('totalDerrotas').textContent = stats.derrotasATP;
            
            const total = stats.vitoriasATP + stats.derrotasATP;
            const rate = total > 0 ? ((stats.vitoriasATP / total) * 100).toFixed(1) : 0;
            document.getElementById('taxaVitorias').textContent = `${rate}%`;

            const atpTypes = TOURNAMENT_TYPES.filter(t => !t.startsWith('CH'));
            document.getElementById('vitoriasList').innerHTML = atpTypes.map(type => {
                const s = stats.porTipo[type];
                if (!s || s.jogos === 0) return '';
                return `
                    <div class="flex justify-between items-center data-row hover:bg-card-hover">
                        ${type}: 
                        <span>
                            <span class="text-secondary">${s.vitorias}</span> / 
                            <span class="text-red-400">${s.derrotas}</span> 
                            <button class="details-btn text-primary hover:text-accent ml-2" 
                                    onclick="showDetails('category', '${type}', 'wins')" 
                                    title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                        </span>
                    </div>
                `;
            }).join('') + `
                <div class="mt-2">
                    <div class="flex justify-between items-center data-row hover:bg-card-hover">
                        Challengers: 
                        <span>
                            ${TOURNAMENT_TYPES.filter(t => t.startsWith('CH')).reduce((sum, type) => sum + (stats.porTipo[type]?.vitorias || 0), 0)} / 
                            ${TOURNAMENT_TYPES.filter(t => t.startsWith('CH')).reduce((sum, type) => sum + (stats.porTipo[type]?.derrotas || 0), 0)} 
                            <button class="details-btn text-primary hover:text-accent ml-2" 
                                    onclick="showDetails('category', 'CH', 'wins')" 
                                    title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="toggle-sublist-btn text-primary hover:text-accent ml-1" 
                                    onclick="toggleSublist('ch-wins-sublist', this)" 
                                    title="Expandir">
                                <i class="fas fa-plus"></i>
                            </button>
                        </span>
                    </div>
                    <div id="ch-wins-sublist" class="sublist pl-4 space-y-1 mt-1">
                        ${TOURNAMENT_TYPES.filter(t => t.startsWith('CH')).map(type => {
                            const s = stats.porTipo[type];
                            return `
                                <div class="flex justify-between items-center text-xs text-text-muted hover:bg-card-hover p-1 rounded">
                                    <em>${type}:</em> 
                                    <span>
                                        <span class="text-secondary">${s?.vitorias || 0}</span> / 
                                        <span class="text-red-400">${s?.derrotas || 0}</span>
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            // CORRE√á√ÉO: Mostrar apenas ATP 250+ nas superf√≠cies
            document.getElementById('vitoriasSurfaceList').innerHTML = SURFACES.map(surface => {
                const s = stats.porSuperficie[surface];
                const totalSurf = (s?.vitorias || 0) + (s?.derrotas || 0);
                const rateSurf = totalSurf > 0 ? ((s.vitorias / totalSurf) * 100).toFixed(1) : 0;
                return `
                    <li class="flex justify-between items-center py-1 data-row hover:bg-card-hover">
                        <span>${surface}:</span> 
                        <span>
                            <span class="text-secondary">${s?.vitorias || 0}</span> / 
                            <span class="text-red-400">${s?.derrotas || 0}</span> 
                            <button class="details-btn text-primary hover:text-accent ml-2" 
                                    onclick="showDetails('surface', '${surface}', 'wins')" 
                                    title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                        </span>
                    </li>
                `;
            }).join('');
        }

        // ==================== FUN√á√ïES DE DETALHES COM ACCORDION FECHADO ====================
        window.toggleSublist = function(id, btn) {
            const el = document.getElementById(id);
            const icon = btn.querySelector('i');
            el.classList.toggle('open');
            btn.classList.toggle('open');
            if (el.classList.contains('open')) {
                icon.classList.remove('fa-plus');
                icon.classList.add('fa-minus');
            } else {
                icon.classList.remove('fa-minus');
                icon.classList.add('fa-plus');
            }
        };

        // NOVO: Fun√ß√£o para renderizar confronto no layout VS
        function renderVSMatch(j) {
            const isWin = j.resultado === 'V';
            const isLoss = j.resultado === 'D';
            const isBye = j.resultado === 'Bye';
            
            return `
                <div class="match-card">
                    <div class="match-round mb-2">${j.rodada}</div>
                    <div class="player-vs-layout">
                        <!-- Fernando Lapa -->
                        <div class="player-box ${isWin ? 'winner' : isLoss ? 'loser' : ''}">
                            <div class="player-avatar">FL</div>
                            <div class="player-info">
                                <div class="player-name">Fernando Lapa</div>
                                <div class="text-xs text-text-muted">Brasil</div>
                            </div>
                            <span class="player-flag">${getFlagEmoji('BRA')}</span>
                        </div>
                        
                        <div class="vs-divider">VS</div>
                        
                        <!-- Advers√°rio -->
                        <div class="player-box ${isLoss ? 'winner' : isWin ? 'loser' : ''}">
                            <div class="player-avatar" style="background: ${isBye ? 'var(--text-muted)' : 'linear-gradient(135deg, #ef4444, #f97316)'}">
                                ${isBye ? 'B' : j.adversario.charAt(0)}
                            </div>
                            <div class="player-info">
                                <div class="player-name">${j.adversario}</div>
                                <div class="text-xs text-text-muted">${isBye ? 'Bye' : j.nacionalidade}</div>
                            </div>
                            ${!isBye ? `<span class="player-flag">${getFlagEmoji(j.nacionalidade)}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="match-details">
                        <span class="match-round">Placar</span>
                        <span class="match-score">${j.placar}</span>
                        <span class="badge ${isWin ? 'badge-success' : isLoss ? 'badge-danger' : 'badge-info'}">
                            ${isWin ? 'Vit√≥ria' : isLoss ? 'Derrota' : 'Bye'}
                        </span>
                    </div>
                </div>
            `;
        }

        window.showDetails = function(filterType, filterValue, viewType) {
            let filtered = [];
            
            if (filterType === 'category') {
                if (filterValue === 'CH') {
                    filtered = allTournaments.filter(t => t.tipo.startsWith('CH'));
                } else {
                    filtered = allTournaments.filter(t => t.tipo === filterValue);
                }
            } else if (filterType === 'surface') {
                // CORRE√á√ÉO: Para superf√≠cie, mostrar apenas ATP 250+
                filtered = allTournaments.filter(t => t.superficie === filterValue && !t.tipo.startsWith('CH'));
            }
            
            if (viewType === 'titles') {
                filtered = filtered.filter(t => t.faseFinal === 'Campe√£o');
            }

            const seasons = [...new Set(filtered.map(t => t.ano))].sort((a, b) => b - a);
            const tournamentNames = [...new Set(filtered.map(t => t.nome))].sort();
            
            const displayValue = filterValue === 'CH' ? 'Challengers' : filterValue;
            const title = viewType === 'titles' ? `T√≠tulos - ${displayValue}` : `Campanhas - ${displayValue}`;
            
            const body = `
                <div class="flex flex-wrap gap-4 mb-6 p-4 bg-background-deep rounded-lg border border-border-subtle">
                    <div class="flex-1 min-w-[150px]">
                        <label class="text-xs font-semibold text-text-muted">Torneio:</label>
                        <select id="modalTournamentFilter" class="form-select text-sm bg-card-base mt-1">
                            <option value="all">Todos</option>
                            ${tournamentNames.map(n => `<option value="${n}">${n}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="text-xs font-semibold text-text-muted">Temporada:</label>
                        <select id="modalSeasonFilter" class="form-select text-sm bg-card-base mt-1">
                            <option value="all">Carreira</option>
                            ${seasons.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div id="modalResultsContent" class="space-y-2 max-h-[600px] overflow-y-auto"></div>
            `;
            
            modal.open(title, body);
            
            const renderContent = () => {
                const seasonFilter = document.getElementById('modalSeasonFilter').value;
                const tournamentFilter = document.getElementById('modalTournamentFilter').value;
                
                let displayFiltered = [...filtered].sort((a, b) => new Date(b.dataInicio) - new Date(a.dataInicio));
                
                if (seasonFilter !== 'all') displayFiltered = displayFiltered.filter(t => t.ano == seasonFilter);
                if (tournamentFilter !== 'all') displayFiltered = displayFiltered.filter(t => t.nome === tournamentFilter);
                
                let html = '';
                
                if (tournamentFilter !== 'all' && seasonFilter === 'all') {
                    let aggWins = 0, aggLosses = 0, aggTitles = 0;
                    displayFiltered.forEach(t => {
                        aggWins += (t.jogos || []).filter(j => j.resultado === 'V').length;
                        aggLosses += (t.jogos || []).filter(j => j.resultado === 'D').length;
                        if (t.faseFinal === 'Campe√£o') aggTitles++;
                    });
                    html += `
                        <div class="p-3 bg-card-base/50 rounded-lg mb-4 text-center border border-border-subtle">
                            <h4 class="font-bold text-text-main">Resumo em ${tournamentFilter}</h4>
                            <p class="text-text-muted">${aggTitles} T√≠tulo(s) | <span class="text-secondary">${aggWins}V</span> / <span class="text-red-400">${aggLosses}D</span></p>
                        </div>
                    `;
                }
                
                // NOVO: Lista compacta de torneios (fechada por padr√£o)
                html += displayFiltered.map((t, index) => {
                    const v = (t.jogos || []).filter(j => j.resultado === 'V').length;
                    const d = (t.jogos || []).filter(j => j.resultado === 'D').length;
                    
                    return `
                        <div class="tournament-list-item" id="tournament-item-${index}">
                            <div class="tournament-list-header" onclick="toggleTournamentList(${index})">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${getFlagEmoji(t.paisTorneio)}</span>
                                    <div>
                                        <div class="font-bold text-text-main">${t.nome}</div>
                                        <div class="text-xs text-text-muted">${t.tipo} ‚Ä¢ ${t.superficie} ‚Ä¢ ${t.ano}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-sm">
                                        <span class="text-secondary font-bold">${v}</span> / 
                                        <span class="text-red-400 font-bold">${d}</span>
                                    </span>
                                    <i class="fas fa-chevron-down tournament-list-icon text-text-muted"></i>
                                </div>
                            </div>
                            <div class="tournament-list-content" id="tournament-content-${index}">
                                <div class="p-4 border-t border-border-subtle">
                                    <div class="tournament-meta mb-4">
                                        <span><i class="fas fa-calendar"></i> ${new Date(t.dataInicio).toLocaleDateString('pt-BR')} - ${new Date(t.dataFim).toLocaleDateString('pt-BR')}</span>
                                        ${t.status === 'Finalizado' ? `
                                            <span class="badge badge-success">Finalizado</span>
                                            <span class="text-accent font-bold">${t.faseFinal}</span>
                                            <span class="text-primary">${t.pontos} pts</span>
                                        ` : '<span class="badge badge-warning">Em Andamento</span>'}
                                    </div>
                                    <div class="space-y-3">
                                        ${(t.jogos || []).map(j => renderVSMatch(j)).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('modalResultsContent').innerHTML = html || '<p class="text-center text-text-muted py-4">Nenhum resultado encontrado.</p>';
            };
            
            document.getElementById('modalSeasonFilter').addEventListener('change', renderContent);
            document.getElementById('modalTournamentFilter').addEventListener('change', renderContent);
            renderContent();
        };

        // NOVO: Fun√ß√£o para toggle da lista de torneios
        window.toggleTournamentList = function(index) {
            const item = document.getElementById(`tournament-item-${index}`);
            const content = document.getElementById(`tournament-content-${index}`);
            
            item.classList.toggle('open');
            content.classList.toggle('open');
        };

        window.toggleAccordion = function(header) {
            const item = header.parentElement;
            const content = header.nextElementSibling;
            item.classList.toggle('open');
            content.classList.toggle('open');
        };

        // ==================== H2H FUNCTIONS ====================
        function updateH2HTab() {
            const opponentMap = new Map();
            availableCountries = new Set();
            
            allTournaments.forEach(t => {
                (t.jogos || []).forEach(j => {
                    if (!j.adversario || j.adversario === 'Bye') return;
                    const key = j.adversario.trim().toLowerCase();
                    if (!opponentMap.has(key)) {
                        opponentMap.set(key, {
                            name: j.adversario.trim(),
                            country: j.nacionalidade
                        });
                    }
                    if (j.nacionalidade) availableCountries.add(j.nacionalidade);
                });
            });
            
            allOpponents = Array.from(opponentMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            
            const countrySelect = document.getElementById('h2hCountryFilter');
            const countries = [...new Set([...availableCountries, ...MAJOR_COUNTRIES])].sort();
            countrySelect.innerHTML = '<option value="">Todos os pa√≠ses</option>' +
                countries.map(c => `<option value="${c}">${getFlagEmoji(c)} ${c}</option>`).join('');
        }

        const h2hSearch = document.getElementById('h2hSearch');
        const h2hSuggestions = document.getElementById('h2hSuggestions');
        let searchTimeout;

        h2hSearch.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.toLowerCase();
            
            if (!query) {
                h2hSuggestions.classList.remove('active');
                return;
            }

            searchTimeout = setTimeout(() => {
                const countryFilter = document.getElementById('h2hCountryFilter').value;
                let filtered = allOpponents.filter(o => o.name.toLowerCase().includes(query));
                
                if (countryFilter) {
                    filtered = filtered.filter(o => o.country === countryFilter);
                }
                
                filtered = filtered.slice(0, 5);
                
                if (filtered.length > 0) {
                    h2hSuggestions.innerHTML = filtered.map(o => `
                        <div class="suggestion-item" onclick="selectOpponent('${o.name.replace(/'/g, "\\'")}')">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${getFlagEmoji(o.country)}</span>
                                <span class="font-medium">${o.name}</span>
                            </div>
                        </div>
                    `).join('');
                    h2hSuggestions.classList.add('active');
                } else {
                    h2hSuggestions.classList.remove('active');
                }
            }, 300);
        });

        window.selectOpponent = function(name) {
            h2hSearch.value = name;
            h2hSuggestions.classList.remove('active');
            displayH2H();
        };

        document.getElementById('h2hCountryFilter').addEventListener('change', displayH2H);

        function displayH2H() {
            const name = h2hSearch.value.trim();
            const country = document.getElementById('h2hCountryFilter').value;
            const container = document.getElementById('h2hResults');

            if (!name && !country) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users empty-state-icon"></i>
                        <p>Pesquise um advers√°rio ou selecione um pa√≠s</p>
                    </div>
                `;
                return;
            }

            if (country && !name) {
                const players = allOpponents.filter(o => o.country === country);
                if (players.length === 0) {
                    container.innerHTML = `<div class="empty-state"><p>Nenhum jogador encontrado de ${getFlagEmoji(country)} ${country}</p></div>`;
                    return;
                }

                container.innerHTML = `
                    <div class="mb-4 font-bold text-text-main">Jogadores de ${getFlagEmoji(country)} ${country}:</div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${players.map(p => {
                            let wins = 0, losses = 0;
                            allTournaments.forEach(t => {
                                (t.jogos || []).forEach(j => {
                                    if (j.adversario.trim().toLowerCase() === p.name.toLowerCase()) {
                                        if (j.resultado === 'V') wins++; else if (j.resultado === 'D') losses++;
                                    }
                                });
                            });
                            return `
                                <div class="p-3 bg-background-deep rounded-lg cursor-pointer hover:bg-card-hover transition-colors"
                                     onclick="selectOpponent('${p.name.replace(/'/g, "\\'")}')">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">${p.name}</span>
                                        <span class="text-sm">
                                            <span class="text-secondary">${wins}</span> - 
                                            <span class="text-red-400">${losses}</span>
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                return;
            }

            let wins = 0, losses = 0;
            const matches = [];
            let opponentCountry = '';

            allTournaments.forEach(t => {
                (t.jogos || []).forEach(j => {
                    if (j.adversario.trim().toLowerCase() === name.toLowerCase()) {
                        if (country && j.nacionalidade !== country) return;
                        
                        if (j.resultado === 'V') wins++; else if (j.resultado === 'D') losses++;
                        if (!opponentCountry && j.nacionalidade) opponentCountry = j.nacionalidade;
                        
                        matches.push({ ...t, ...j, data: new Date(t.dataInicio) });
                    }
                });
            });

            if (matches.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Nenhum confronto encontrado</p></div>`;
                return;
            }

            matches.sort((a, b) => b.data - a.data);

            container.innerHTML = `
                <div class="text-center mb-6 p-4 bg-background-deep rounded-xl">
                    <div class="text-3xl font-extrabold mb-2">
                        <span class="text-secondary">${wins}</span>
                        <span class="text-text-muted mx-2">-</span>
                        <span class="text-red-400">${losses}</span>
                    </div>
                    <div class="text-text-muted">
                        vs ${getFlagEmoji(opponentCountry)} ${name}
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Torneio</th>
                                <th>Rodada</th>
                                <th>Superf√≠cie</th>
                                <th>Placar</th>
                                <th>Resultado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${matches.map(m => `
                                <tr>
                                    <td class="whitespace-nowrap">${m.data.toLocaleDateString('pt-BR')}</td>
                                    <td>
                                        <div class="flex items-center gap-2">
                                            ${getFlagEmoji(m.paisTorneio)}
                                            <span>${m.nome}</span>
                                        </div>
                                    </td>
                                    <td>${m.rodada}</td>
                                    <td>${m.superficie}</td>
                                    <td class="font-mono">${m.placar}</td>
                                    <td>
                                        <span class="badge ${m.resultado === 'V' ? 'badge-success' : 'badge-danger'}">
                                            ${m.resultado === 'V' ? 'Vit√≥ria' : 'Derrota'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ==================== RECORDES TAB ====================
        function updateRecordsTab(stats) {
            const container = document.getElementById('recordesConquistados');
            
            container.innerHTML = WORLD_RECORDS.map(record => {
                const playerValue = record.stat ? record.stat(stats) : 0;
                const percentage = record.value > 0 ? Math.min((playerValue / record.value) * 100, 100) : 0;
                const isReached = percentage >= 100;
                const isClose = percentage >= 80 && !isReached;
                
                return `
                    <div class="dashboard-card p-4 ${isReached ? 'border-secondary/50 bg-secondary/5' : ''}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-text-main text-sm leading-tight">${record.title}</h4>
                                <p class="text-xs text-text-muted mt-1">Recorde: ${record.holder} (${record.format(record.value)})</p>
                            </div>
                            ${isReached ? '<i class="fas fa-trophy text-secondary text-xl"></i>' : isClose ? '<i class="fas fa-fire text-accent"></i>' : ''}
                        </div>
                        
                        <div class="flex justify-between items-end mb-2">
                            <div>
                                <p class="text-xs text-text-muted">Voc√™</p>
                                <p class="text-xl font-extrabold ${isReached ? 'text-secondary' : 'text-primary'}">${record.format(playerValue)}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-text-muted">Progresso</p>
                                <p class="text-sm font-bold text-text-muted">${percentage.toFixed(1)}%</p>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-bar ${isReached ? 'bg-secondary' : isClose ? 'bg-accent' : 'bg-primary'}" 
                                 style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== CHARTS ====================
        function updateCharts(stats) {
            if (charts.titulos) charts.titulos.destroy();
            charts.titulos = new Chart(document.getElementById('titulosChart'), {
                type: 'doughnut',
                data: {
                    labels: TOURNAMENT_TYPES.filter(t => !t.startsWith('CH')),
                    datasets: [{
                        data: TOURNAMENT_TYPES.filter(t => !t.startsWith('CH')).map(t => stats.porTipo[t]?.titulos || 0),
                        backgroundColor: ['#fcd34d', '#f59e0b', '#ef4444', '#f97316', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', padding: 15, font: { size: 11 } }
                        }
                    }
                }
            });

            if (charts.vitorias) charts.vitorias.destroy();
            charts.vitorias = new Chart(document.getElementById('vitoriasChart'), {
                type: 'bar',
                data: {
                    labels: SURFACES,
                    datasets: [
                        {
                            label: 'Vit√≥rias',
                            data: SURFACES.map(s => stats.porSuperficie[s]?.vitorias || 0),
                            backgroundColor: '#10b981',
                            borderRadius: 6
                        },
                        {
                            label: 'Derrotas',
                            data: SURFACES.map(s => stats.porSuperficie[s]?.derrotas || 0),
                            backgroundColor: '#ef4444',
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } }
                    }
                }
            });
        }

        // ==================== MODAL FORMS ====================
        function openCreateTournamentModal() {
            const body = `
                <form id="createTournamentForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-text-muted mb-1">Nome do Torneio *</label>
                            <input type="text" id="tNome" class="form-input" required placeholder="Ex: Australian Open">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-1">Pa√≠s *</label>
                            <input type="text" id="tPais" class="form-input" required maxlength="3" placeholder="Ex: AUS">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-1">Tipo *</label>
                            <select id="tTipo" class="form-select" required onchange="updateRounds()">
                                ${TOURNAMENT_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-1">Superf√≠cie *</label>
                            <select id="tSuperficie" class="form-select" required>
                                ${SURFACES.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-1">Rodada de In√≠cio</label>
                            <select id="tRodadaInicio" class="form-select"></select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-1">Data In√≠cio *</label>
                            <input type="date" id="tDataInicio" class="form-input" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-muted mb-1">Data Fim *</label>
                            <input type="date" id="tDataFim" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="border-t border-border-subtle pt-4 mt-4">
                        <h4 class="font-semibold text-text-main mb-3">Primeira Partida</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-muted mb-1">Advers√°rio *</label>
                                <input type="text" id="jAdversario" class="form-input" required placeholder="Nome do advers√°rio">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-muted mb-1">Nacionalidade</label>
                                <input type="text" id="jNacionalidade" class="form-input" maxlength="3" placeholder="Ex: SRB">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-muted mb-1">Placar *</label>
                                <input type="text" id="jPlacar" class="form-input" required placeholder="Ex: 6-4, 3-6, 6-3">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-muted mb-1">Resultado *</label>
                                <select id="jResultado" class="form-select" onchange="toggleFinalFields()">
                                    <option value="V">Vit√≥ria</option>
                                    <option value="D">Derrota</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="finalFields" class="hidden border-t border-border-subtle pt-4 mt-4">
                        <h4 class="font-semibold text-red-400 mb-3">Finalizar Campanha</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-muted mb-1">Pontos</label>
                                <input type="number" id="tPontos" class="form-input" min="0" value="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-text-muted mb-1">Pr√™mio ($)</label>
                                <input type="number" id="tPremiacao" class="form-input" min="0" value="0">
                            </div>
                        </div>
                    </div>
                </form>
            `;
            
            const footer = `
                <button onclick="modal.close()" class="btn btn-ghost">Cancelar</button>
                <button onclick="saveNewTournament()" class="btn btn-primary">
                    <i class="fas fa-save mr-2"></i>Salvar Torneio
                </button>
            `;
            
            modal.open('<i class="fas fa-plus-circle text-primary mr-2"></i>Novo Torneio', body, footer);
            updateRounds();
            
            const today = new Date();
            document.getElementById('tDataInicio').valueAsDate = today;
            document.getElementById('tDataFim').valueAsDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
        }

        window.updateRounds = function() {
            const tipo = document.getElementById('tTipo').value;
            const rounds = ROUNDS_BY_TYPE[tipo] || ROUNDS_BY_TYPE['Default'];
            const select = document.getElementById('tRodadaInicio');
            
            const hasByes = ['ATP Masters 1000', 'ATP 500'].includes(tipo);
            const maxRound = hasByes ? (tipo === 'ATP Masters 1000' ? 2 : 1) : 0;
            
            select.innerHTML = rounds.slice(0, maxRound + 1).map((r, i) => 
                `<option value="${r}">${r}</option>`
            ).join('');
        };

        window.toggleFinalFields = function() {
            const isLoss = document.getElementById('jResultado').value === 'D';
            document.getElementById('finalFields').classList.toggle('hidden', !isLoss);
        };

        window.saveNewTournament = async function() {
            const form = document.getElementById('createTournamentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const tipo = document.getElementById('tTipo').value;
            const rounds = ROUNDS_BY_TYPE[tipo] || ROUNDS_BY_TYPE['Default'];
            const startRound = document.getElementById('tRodadaInicio').value;
            const startIndex = rounds.indexOf(startRound);
            
            const jogos = [];
            for (let i = 0; i < startIndex; i++) {
                jogos.push({
                    rodada: rounds[i],
                    adversario: 'Bye',
                    nacionalidade: 'ATP',
                    placar: 'Bye',
                    resultado: 'Bye'
                });
            }
            
            const isBye = document.getElementById('jAdversario').value.toLowerCase() === 'bye';
            const resultado = isBye ? 'Bye' : document.getElementById('jResultado').value;
            
            jogos.push({
                rodada: startRound,
                adversario: isBye ? 'Bye' : document.getElementById('jAdversario').value,
                nacionalidade: isBye ? 'ATP' : document.getElementById('jNacionalidade').value.toUpperCase(),
                placar: isBye ? 'Bye' : document.getElementById('jPlacar').value,
                resultado: resultado
            });

            const isLoss = resultado === 'D';
            const isFinal = startRound === 'F';
            
            const data = {
                nome: document.getElementById('tNome').value,
                paisTorneio: document.getElementById('tPais').value.toUpperCase(),
                tipo: tipo,
                superficie: document.getElementById('tSuperficie').value,
                dataInicio: document.getElementById('tDataInicio').value,
                dataFim: document.getElementById('tDataFim').value,
                ano: new Date(document.getElementById('tDataInicio').value).getFullYear(),
                jogos: jogos,
                status: (isLoss || (isFinal && !isLoss)) ? 'Finalizado' : 'Em Andamento',
                faseFinal: isLoss ? startRound : (isFinal ? 'Campe√£o' : ''),
                pontos: isLoss ? Number(document.getElementById('tPontos').value) || 0 : 0,
                premiacao: isLoss ? Number(document.getElementById('tPremiacao').value) || 0 : 0
            };

            await saveTournament(data);
        };

        window.openTournamentModal = function(id) {
            const t = allTournaments.find(x => x.id === id);
            if (!t) return;

            const matchesHtml = (t.jogos || []).map((j, i) => {
                const isWin = j.resultado === 'V';
                const isLoss = j.resultado === 'D';
                const isBye = j.resultado === 'Bye';
                
                return `
                    <div class="match-card">
                        <div class="match-round mb-2">${j.rodada}</div>
                        <div class="player-vs-layout">
                            <!-- Fernando Lapa -->
                            <div class="player-box ${isWin ? 'winner' : isLoss ? 'loser' : ''}">
                                <div class="player-avatar">FL</div>
                                <div class="player-info">
                                    <div class="player-name">Fernando Lapa</div>
                                    <div class="text-xs text-text-muted">Brasil</div>
                                </div>
                                <span class="player-flag">${getFlagEmoji('BRA')}</span>
                            </div>
                            
                            <div class="vs-divider">VS</div>
                            
                            <!-- Advers√°rio -->
                            <div class="player-box ${isLoss ? 'winner' : isWin ? 'loser' : ''}">
                                <div class="player-avatar" style="background: ${isBye ? 'var(--text-muted)' : 'linear-gradient(135deg, #ef4444, #f97316)'}">
                                    ${isBye ? 'B' : j.adversario.charAt(0)}
                                </div>
                                <div class="player-info">
                                    <div class="player-name">${j.adversario}</div>
                                    <div class="text-xs text-text-muted">${isBye ? 'Bye' : j.nacionalidade}</div>
                                </div>
                                ${!isBye ? `<span class="player-flag">${getFlagEmoji(j.nacionalidade)}</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="match-details">
                            <span class="match-round">Placar</span>
                            <span class="match-score">${j.placar}</span>
                            <span class="badge ${isWin ? 'badge-success' : isLoss ? 'badge-danger' : 'badge-info'}">
                                ${isWin ? 'Vit√≥ria' : isLoss ? 'Derrota' : 'Bye'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            const isFinished = t.status === 'Finalizado';
            const canAddMatch = !isFinished && t.faseFinal !== 'Campe√£o';
            
            let addMatchForm = '';
            if (canAddMatch) {
                const lastRound = t.jogos?.[t.jogos.length - 1]?.rodada;
                const rounds = ROUNDS_BY_TYPE[t.tipo] || ROUNDS_BY_TYPE['Default'];
                const lastIndex = rounds.indexOf(lastRound);
                const nextRounds = rounds.slice(lastIndex + 1);
                
                if (nextRounds.length > 0) {
                    addMatchForm = `
                        <div class="border-t border-border-subtle pt-4 mt-4">
                            <h4 class="font-semibold text-text-main mb-3">Adicionar Pr√≥xima Partida</h4>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <select id="nextRound" class="form-select">
                                    ${nextRounds.map(r => `<option value="${r}">${r}</option>`).join('')}
                                </select>
                                <input type="text" id="nextAdversario" class="form-input" placeholder="Advers√°rio">
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <input type="text" id="nextNacionalidade" class="form-input" placeholder="Pa√≠s (Ex: ESP)" maxlength="3">
                                <input type="text" id="nextPlacar" class="form-input" placeholder="Placar">
                            </div>
                            <div class="flex gap-3">
                                <button onclick="addMatch('${id}', 'V')" class="btn btn-secondary flex-1">
                                    <i class="fas fa-check mr-2"></i>Vit√≥ria
                                </button>
                                <button onclick="addMatch('${id}', 'D')" class="btn btn-danger flex-1">
                                    <i class="fas fa-times mr-2"></i>Derrota
                                </button>
                            </div>
                            <div id="finalizeFields" class="hidden mt-4 p-4 bg-background-deep rounded-lg">
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="number" id="finalPontos" class="form-input" placeholder="Pontos" min="0">
                                    <input type="number" id="finalPremiacao" class="form-input" placeholder="Pr√™mio $" min="0">
                                </div>
                                <button onclick="finalizeTournament('${id}')" class="btn btn-primary w-full mt-3">
                                    Finalizar Campanha
                                </button>
                            </div>
                        </div>
                    `;
                }
            }

            const body = `
                <!-- Header do Torneio -->
                <div class="tournament-header">
                    <div class="tournament-title">
                        <span class="text-3xl">${getFlagEmoji(t.paisTorneio)}</span>
                        <div>
                            ${t.nome}
                            <div class="text-sm text-text-muted font-normal mt-1">${t.tipo} ‚Ä¢ ${t.superficie}</div>
                        </div>
                    </div>
                    <div class="tournament-meta">
                        <span><i class="fas fa-calendar"></i> ${new Date(t.dataInicio).toLocaleDateString('pt-BR')} - ${new Date(t.dataFim).toLocaleDateString('pt-BR')}</span>
                        <span><i class="fas fa-trophy"></i> ${t.ano}</span>
                        ${t.status === 'Finalizado' ? `
                            <span class="badge badge-success">Finalizado</span>
                            <span class="text-accent font-bold">${t.faseFinal}</span>
                            <span class="text-primary">${t.pontos} pts</span>
                            <span class="text-secondary">${formatCurrency(t.premiacao)}</span>
                        ` : '<span class="badge badge-warning">Em Andamento</span>'}
                    </div>
                </div>

                <!-- Lista de Partidas -->
                <div class="space-y-3 mb-4">
                    ${matchesHtml}
                </div>
                
                ${addMatchForm}
            `;

            const footer = `
                <button onclick="modal.close()" class="btn btn-ghost">Fechar</button>
                ${!isFinished ? `<button onclick="deleteTournament('${id}')" class="btn btn-danger">
                    <i class="fas fa-trash mr-2"></i>Excluir
                </button>` : ''}
            `;

            modal.open(`
                <span class="text-2xl mr-2">${getFlagEmoji(t.paisTorneio)}</span>
                Detalhes do Torneio
            `, body, footer);
        };

        window.addMatch = function(id, result) {
            const round = document.getElementById('nextRound').value;
            const adversario = document.getElementById('nextAdversario').value.trim();
            const nacionalidade = document.getElementById('nextNacionalidade').value.trim().toUpperCase();
            const placar = document.getElementById('nextPlacar').value.trim();
            
            if (!adversario || !placar) {
                showToast('Preencha todos os campos', 'warning');
                return;
            }

            const t = allTournaments.find(x => x.id === id);
            const newMatch = {
                rodada: round,
                adversario,
                nacionalidade: nacionalidade || 'UNK',
                placar,
                resultado: result
            };
            
            const updatedJogos = [...(t.jogos || []), newMatch];
            
            if (result === 'D') {
                document.getElementById('finalizeFields').classList.remove('hidden');
                window.tempMatchData = { id, jogos: updatedJogos, faseFinal: round };
            } else {
                const isFinal = round === 'F';
                if (isFinal) {
                    document.getElementById('finalizeFields').classList.remove('hidden');
                    window.tempMatchData = { id, jogos: updatedJogos, faseFinal: 'Campe√£o' };
                } else {
                    updateTournament(id, { jogos: updatedJogos });
                    openTournamentModal(id);
                }
            }
        };

        window.finalizeTournament = function(id) {
            const pontos = Number(document.getElementById('finalPontos').value) || 0;
            const premiacao = Number(document.getElementById('finalPremiacao').value) || 0;
            
            const data = {
                ...window.tempMatchData,
                status: 'Finalizado',
                pontos,
                premiacao
            };
            
            updateTournament(id, data);
            modal.close();
        };

        // ==================== EXPORT/IMPORT ====================
        window.exportData = function() {
            const data = {
                exportDate: new Date().toISOString(),
                player: 'Fernando Lapa',
                tournaments: allTournaments
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fernando_lapa_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Dados exportados com sucesso!', 'success');
        };

        window.importData = function(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.tournaments || !Array.isArray(data.tournaments)) {
                        throw new Error('Formato inv√°lido');
                    }

                    if (!confirm(`Importar ${data.tournaments.length} torneios? Isso adicionar√° aos dados existentes.`)) {
                        return;
                    }

                    showLoading(true);
                    let imported = 0;
                    
                    for (const t of data.tournaments) {
                        if (!t.nome || !t.dataInicio) continue;
                        
                        const { id, ...tournamentData } = t;
                        await addDoc(collection(db, 'torneios'), tournamentData);
                        imported++;
                    }

                    await loadTournaments();
                    showToast(`${imported} torneios importados!`, 'success');
                } catch (err) {
                    console.error(err);
                    showToast('Erro ao importar: ' + err.message, 'error');
                } finally {
                    showLoading(false);
                    input.value = '';
                }
            };
            reader.readAsText(file);
        };

        window.refreshData = loadTournaments;

        // ==================== INITIALIZATION ====================
        function init() {
            calculateAge();
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    btn.setAttribute('aria-selected', 'true');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                });
            });

            document.getElementById('seasonFilter').addEventListener('change', (e) => {
                updateSeasonsTab(calculateStats(), e.target.value);
            });

            document.getElementById('createTournamentBtn').addEventListener('click', openCreateTournamentModal);

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    h2hSuggestions.classList.remove('active');
                }
            });

            loadTournaments();
        }

        document.addEventListener('DOMContentLoaded', init);

        // Expose functions to window
        Object.assign(window, {
            openCreateTournamentModal,
            openTournamentModal: window.openTournamentModal,
            deleteTournament,
            updateRounds: window.updateRounds,
            toggleFinalFields: window.toggleFinalFields,
            saveNewTournament: window.saveNewTournament,
            addMatch: window.addMatch,
            finalizeTournament: window.finalizeTournament,
            selectOpponent: window.selectOpponent,
            exportData: window.exportData,
            importData: window.importData,
            refreshData: window.refreshData,
            showDetails: window.showDetails,
            toggleSublist: window.toggleSublist,
            toggleAccordion: window.toggleAccordion,
            toggleTournamentList: window.toggleTournamentList
        });
    </script>
</body>
</html>
